<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Impact CMS{% endblock %}</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <!-- Flatpickr date picker CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- App stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Centered flash messages (fixed overlay) */
    .flash-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: min(720px, calc(100vw - 2rem));
      pointer-events: none; /* allow clicks through except the alerts */
    }

    .flash-container .alert {
      pointer-events: auto;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }

    /* Stronger error emphasis */
    .flash-container .alert-danger {
      border-width: 2px;
    }

    /* Temporary highlight for invalid fields when flash includes [field=...] */
    .flash-field-highlight {
      outline: 3px solid rgba(220, 53, 69, 0.55); /* bootstrap danger-ish */
      outline-offset: 2px;
      animation: flashOutline 900ms ease-in-out 0s 2;
    }

    @keyframes flashOutline {
      0%   { outline-color: rgba(220, 53, 69, 0.15); }
      50%  { outline-color: rgba(220, 53, 69, 0.75); }
      100% { outline-color: rgba(220, 53, 69, 0.15); }
    }

    /* Global floating alert (used for save confirmations + validation notices) */
    .floating-alert-host {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1090;
      width: min(720px, calc(100vw - 2rem));
      pointer-events: none;
    }

    .floating-alert-host .alert {
      pointer-events: auto;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
      border-width: 2px;
    }

    /* Save confirmation styling (success)
       Apply to BOTH the floating alert (preferred) and regular flashed success alerts.
       Use !important to reliably override Bootstrap defaults.
    */
    .floating-alert-host .alert-success,
    .flash-container .alert-success {
      background-color: #ffffff !important;
      color: #111111 !important;
      border: 10px solid var(--accent-color, #198754) !important;
    }

    .dark-mode .floating-alert-host .alert-success,
    .dark-mode .flash-container .alert-success {
      background-color: #000000 !important;
      color: #ffffff !important;
      border: 10px solid var(--accent-color, #198754) !important;
    }

    /* Accent-aware styling (works in light & dark if --accent-color is defined in CSS) */
    .floating-alert-host .alert-accent {
      border-color: var(--accent-color, #0d6efd);
    }

    .floating-alert-host .alert-danger {
      border-color: var(--accent-color, #dc3545);
    }
  </style>
</head>
<body class="bg-light">

  <!-- Top navbar -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <!-- Brand / Logo -->
        {% set brand_name_raw = settings.business_name if settings and settings.business_name else 'Impact Medical CMS' %}
        {#
          Defensive: if Settings.business_name accidentally contains pasted code (newlines, decorators, imports),
          donâ€™t render it across every page.
        #}
        {% set brand_name_clean = (brand_name_raw or '') | replace('\r', ' ') | replace('\n', ' ') | trim %}
        {% if ('from flask import' in brand_name_clean) or ('@app.route' in brand_name_clean) or ('def ' in brand_name_clean and 'route' in brand_name_clean) %}
          {% set brand_name_clean = 'Impact Medical CMS' %}
        {% endif %}
        {% if brand_name_clean|length > 80 %}
          {% set brand_name_clean = brand_name_clean[:77] ~ 'â€¦' %}
        {% endif %}
        <a class="navbar-brand d-flex flex-column align-items-center" href="{{ url_for('main.claims_list') }}">
          <span style="line-height: 1.1;">{{ brand_name_clean }}</span>
        </a>

        <!-- Mobile nav toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
                aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Nav links -->
        <div class="collapse navbar-collapse d-flex align-items-center" id="mainNavbar">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'claims' %}active{% endif %}"
                 href="{{ url_for('main.claims_list') }}">Claims</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'billing' %}active{% endif %}"
                 href="{{ url_for('main.billing_list') }}">Billing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'carriers' %}active{% endif %}"
                 href="{{ url_for('main.carriers_list') }}">Carriers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'employers' %}active{% endif %}"
                 href="{{ url_for('main.employers_list') }}">Employers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'providers' %}active{% endif %}"
                 href="{{ url_for('main.providers_list') }}">Providers</a>
            </li>

            <li class="nav-item">
              <a class="nav-link {% if active_page == 'forms' %}active{% endif %}"
                 href="{{ url_for('main.forms_index') }}">Forms</a>
            </li>

            <li class="nav-item">
              <a class="nav-link {% if active_page == 'reporting' %}active{% endif %}"
                 href="{{ url_for('main.reporting_dashboard') }}">Reporting</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'analysis' %}active{% endif %}"
                 href="{{ url_for('main.analysis_view') }}">Analysis</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'settings' %}active{% endif %}"
                 href="{{ url_for('main.settings_view') }}">Settings</a>
            </li>
          </ul>

          <!-- Right side: theme toggle + version -->
          <div class="d-flex align-items-center gap-2">
            <button id="themeToggle"
                    type="button"
                    class="btn btn-sm btn-outline-light"
                    aria-label="Toggle dark mode">
              ðŸŒ“
            </button>
            <span class="navbar-text text-secondary small">
              v{{ config.APP_VERSION }}
            </span>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Page content -->
  <main class="container-fluid py-3">

    <!-- Global floating alert host (JS-managed) -->
    <div id="floatingAlertHost" class="floating-alert-host" aria-live="polite" aria-atomic="true"></div>

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            {% set bs_category = 'info' %}
            {% if category in ['success','info','warning','danger','primary','secondary','light','dark'] %}
              {% set bs_category = category %}
            {% elif category in ['error'] %}
              {% set bs_category = 'danger' %}
            {% endif %}
            <div class="alert alert-{{ bs_category }} alert-dismissible fade show mb-2 js-auto-dismiss" role="alert">
              <span class="js-flash-msg">{{ message }}</span>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  {% block scripts %}
  <!-- Bootstrap 5 JS bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <script>
    // Global floating alert helper.
    // Usage: window.showFloatingAlert('Changes saved', 'success')
    // Levels: success | info | warning | danger | primary | secondary | light | dark
    (function () {
      function normalizeLevel(level) {
        var allowed = ['success','info','warning','danger','primary','secondary','light','dark'];
        if (!level) return 'info';
        level = String(level).toLowerCase();
        return allowed.indexOf(level) !== -1 ? level : 'info';
      }

      function getHost() {
        return document.getElementById('floatingAlertHost');
      }

      function removeHostChildren(host) {
        if (!host) return;
        while (host.firstChild) host.removeChild(host.firstChild);
      }

      function detachDismissListeners(state) {
        if (!state) return;
        if (state.onDismiss) {
          document.removeEventListener('click', state.onDismiss, true);
          document.removeEventListener('keydown', state.onDismiss, true);
          state.onDismiss = null;
        }
      }

      var _state = { onDismiss: null };

      window.clearFloatingAlert = function () {
        var host = getHost();
        detachDismissListeners(_state);
        removeHostChildren(host);
      };

      function textIncludesAny(t, arr) {
        if (!t) return false;
        t = String(t).toLowerCase();
        for (var i = 0; i < arr.length; i++) {
          if (t.indexOf(arr[i]) !== -1) return true;
        }
        return false;
      }

      window.showFloatingAlert = function (message, level, opts) {
        try {
          var host = getHost();
          if (!host) return;

          opts = opts || {};
          var bsLevel = normalizeLevel(level);
          var msgText = message || '';

          // Default policy: auto-dismiss most things.
          // Persist only for explicit saves/deletes (or when opts.persistent is true).
          var defaultKeywords = ['saved', 'changes saved', 'deleted', 'removed'];
          var persistent = !!opts.persistent || (bsLevel === 'success' && textIncludesAny(msgText, defaultKeywords));
          var autoMs = (typeof opts.autoDismissMs === 'number') ? opts.autoDismissMs : (bsLevel === 'success' ? 2500 : 3000);

          // Clear any previous floating alert
          window.clearFloatingAlert();

          var alertEl = document.createElement('div');
          alertEl.className = 'alert alert-' + bsLevel + ' alert-dismissible fade show alert-accent';
          alertEl.setAttribute('role', 'alert');

          var msgSpan = document.createElement('span');
          msgSpan.textContent = msgText;
          alertEl.appendChild(msgSpan);

          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn-close';
          btn.setAttribute('data-bs-dismiss', 'alert');
          btn.setAttribute('aria-label', 'Close');
          alertEl.appendChild(btn);

          host.appendChild(alertEl);

          function dismiss() {
            try {
              if (window.bootstrap && window.bootstrap.Alert) {
                var inst = window.bootstrap.Alert.getOrCreateInstance(alertEl);
                inst.close();
              } else {
                alertEl.classList.remove('show');
                alertEl.remove();
              }
            } finally {
              detachDismissListeners(_state);
              removeHostChildren(host);
            }
          }

          // Close button works as normal
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            dismiss();
          });

          // Allow click on alert to dismiss
          alertEl.addEventListener('click', function (e) {
            e.stopPropagation();
          });

          if (persistent) {
            _state.onDismiss = function () { dismiss(); };
            document.addEventListener('click', _state.onDismiss, true);
            document.addEventListener('keydown', _state.onDismiss, true);
          } else {
            // Auto-dismiss
            window.setTimeout(function () {
              dismiss();
            }, autoMs);
          }

        } catch (e) {
          // Silent fail (alerts shouldn't break pages)
        }
      };
    })();
  </script>

  <!-- Flatpickr date picker JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Global Flatpickr init. Use on inputs with: class="js-date" or data-flatpickr="1".
    // Standard format: MM/DD/YYYY, allow typed entry, and use an explicit calendar button on supported pages.
    document.addEventListener('DOMContentLoaded', function () {
      if (!window.flatpickr) return;

      // Attach Flatpickr to our standard selectors.
      var dateInputs = document.querySelectorAll('input.js-date, input[data-flatpickr="1"]');
      if (!dateInputs || !dateInputs.length) return;

      dateInputs.forEach(function (el) {
        // Avoid double-init if pages re-run scripts.
        if (el._flatpickr) return;

        window.flatpickr(el, {
          allowInput: true,
          dateFormat: 'm/d/Y',
          // Keep behavior consistent with our UI expectations
          // (no time selection here; we can enable time per-field later).
          enableTime: false,
        });
      });
    });
  </script>

  <!-- Simple reusable table search helper -->

  <script>
    /**
     * Attach simple text filter to a table.
     * Hides <tbody><tr> rows whose text doesn't include the search value.
     */
    function attachTableSearch(inputId, tableId) {
      var input = document.getElementById(inputId);
      var table = document.getElementById(tableId);
      if (!input || !table) {
        return;
      }

      input.addEventListener('input', function () {
        var value = (input.value || '').toLowerCase().trim();
        var rows = table.querySelectorAll('tbody tr');

        rows.forEach(function (row) {
          var text = (row.textContent || '').toLowerCase();
          row.style.display = text.indexOf(value) !== -1 ? '' : 'none';
        });
      });
    }
  </script>

  <script>
    // Global textarea auto-grow (min 2 rows, max 10 rows).
    // Applies to all <textarea> by default.
    // Opt-out with: data-autogrow="0" or class "js-no-autogrow".
    // Per-field overrides:
    //   data-autogrow-min="2" data-autogrow-max="10"
    (function () {
      function clamp(n, lo, hi) {
        return Math.max(lo, Math.min(hi, n));
      }

      function parseIntSafe(v, fallback) {
        var n = parseInt(v, 10);
        return isNaN(n) ? fallback : n;
      }

      function getLineHeightPx(el) {
        try {
          var style = window.getComputedStyle(el);
          var lh = parseFloat(style.lineHeight);
          if (lh && !isNaN(lh)) return lh;
          var fs = parseFloat(style.fontSize) || 14;
          return fs * 1.35;
        } catch (e) {
          return 18;
        }
      }

      function shouldAutoGrow(el) {
        if (!el || el.tagName !== 'TEXTAREA') return false;
        if (el.classList && el.classList.contains('js-no-autogrow')) return false;
        var flag = el.getAttribute('data-autogrow');
        if (flag === '0' || flag === 'false' || flag === 'off') return false;
        return true;
      }

      function autoGrowTextarea(el) {
        if (!shouldAutoGrow(el)) return;

        var minRows = parseIntSafe(el.getAttribute('data-autogrow-min'), 2);
        var maxRows = parseIntSafe(el.getAttribute('data-autogrow-max'), 10);
        minRows = clamp(minRows, 1, 50);
        maxRows = clamp(maxRows, minRows, 200);

        var lineHeight = getLineHeightPx(el);

        // Reset to min rows so scrollHeight reflects full content.
        el.rows = minRows;

        // Compute rows needed from height.
        var rowsNeeded = Math.ceil((el.scrollHeight || 0) / lineHeight);
        el.rows = clamp(rowsNeeded, minRows, maxRows);
      }

      function wireTextarea(el) {
        if (!shouldAutoGrow(el)) return;
        if (el.dataset && el.dataset.autogrowWired === '1') return;

        // Initial sizing (for saved content after reload)
        autoGrowTextarea(el);

        // Resize while typing
        el.addEventListener('input', function () {
          autoGrowTextarea(el);
        });

        if (el.dataset) el.dataset.autogrowWired = '1';
      }

      function initAutoGrowTextareas() {
        var areas = document.querySelectorAll('textarea');
        if (!areas || !areas.length) return;
        areas.forEach(function (ta) {
          wireTextarea(ta);
        });
      }

      document.addEventListener('DOMContentLoaded', initAutoGrowTextareas);

      // Expose for pages that dynamically add textareas.
      window.impactInitAutoGrowTextareas = initAutoGrowTextareas;
      window.impactAutoGrowTextarea = autoGrowTextarea;
    })();
  </script>

  <script>
    // Simple dark-mode toggle with localStorage persistence.
    document.addEventListener('DOMContentLoaded', function () {
      var root = document.documentElement;
      var toggle = document.getElementById('themeToggle');
      if (!toggle) {
        return;
      }

      var saved = null;
      try {
        saved = window.localStorage.getItem('impact_theme');
      } catch (e) {
        saved = null;
      }

      function applyTheme(theme) {
        if (theme === 'dark') {
          root.classList.add('dark-mode');
          toggle.textContent = 'â˜€';
        } else {
          root.classList.remove('dark-mode');
          toggle.textContent = 'ðŸŒ“';
        }
      }

      // Initialize from saved preference (default light).
      if (saved === 'dark') {
        applyTheme('dark');
      } else {
        applyTheme('light');
      }

      toggle.addEventListener('click', function () {
        var isDark = root.classList.contains('dark-mode');
        var next = isDark ? 'light' : 'dark';
        applyTheme(next);
        try {
          window.localStorage.setItem('impact_theme', next);
        } catch (e) {
          // Ignore storage errors
        }
      });
    });
  </script>
  <script>
    // Auto-format date and phone inputs and auto-advance when complete.
    document.addEventListener('DOMContentLoaded', function () {
      function focusNextField(input) {
        if (!input || !input.form) return;
        var elements = Array.prototype.filter.call(input.form.elements, function (el) {
          if (!el) return false;
          if (el.disabled) return false;
          if (el.type === 'hidden') return false;
          if (typeof el.offsetParent === 'undefined') return true;
          return el.offsetParent !== null;
        });
        var index = elements.indexOf(input);
        if (index >= 0 && index + 1 < elements.length) {
          elements[index + 1].focus();
        }
      }

      function setupAutoDate(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          var digits = (input.value || '').replace(/\D/g, '').slice(0, 8);
          var mm = '';
          var dd = '';
          var yyyy = '';

          if (digits.length >= 2) {
            mm = digits.slice(0, 2);
            if (digits.length >= 4) {
              dd = digits.slice(2, 4);
              if (digits.length > 4) {
                yyyy = digits.slice(4);
              }
            } else if (digits.length > 2) {
              dd = digits.slice(2);
            }
          } else {
            mm = digits;
          }

          var parts = [];
          if (mm) parts.push(mm);
          if (dd) parts.push(dd);
          if (yyyy) parts.push(yyyy);
          input.value = parts.join('/');

          if (digits.length === 8) {
            focusNextField(input);
          }
        });
      }

      function setupAutoPhone(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          var digits = (input.value || '').replace(/\D/g, '').slice(0, 10);
          var formatted = '';

          if (digits.length > 0) {
            formatted = '(' + digits.slice(0, Math.min(3, digits.length));
          }
          if (digits.length >= 4) {
            formatted += ') ' + digits.slice(3, Math.min(6, digits.length));
          } else if (digits.length > 3) {
            formatted += ') ' + digits.slice(3);
          }
          if (digits.length >= 7) {
            formatted += '-' + digits.slice(6);
          }

          input.value = formatted;

          if (digits.length === 10) {
            focusNextField(input);
          }
        });
        input.addEventListener('keypress', function (evt) {
          var ch = evt.key;
          if (!ch) return;
          // Allow control keys (Backspace, Arrow keys, etc.)
          if (ch.length > 1) return;
          if (!/[0-9]/.test(ch)) {
            evt.preventDefault();
          }
        });
      }

      var dateInputs = document.querySelectorAll('input[data-auto-date="1"], input.js-date-autofmt');

      // Skip fields that are using Flatpickr (js-date or data-flatpickr)
      dateInputs = Array.prototype.filter.call(dateInputs, function (el) {
        if (!el) return false;
        if (el.classList && el.classList.contains('js-date')) return false;
        if (el.getAttribute && el.getAttribute('data-flatpickr') === '1') return false;
        return true;
      });
      Array.prototype.forEach.call(dateInputs, function (input) {
        setupAutoDate(input);
      });

      var phoneInputs = document.querySelectorAll('input[type="tel"], input[data-auto-phone="1"], input.js-phone-autofmt, input.phone-input, input.js-phone, input.js-fax');
      Array.prototype.forEach.call(phoneInputs, function (input) {
        // Avoid attaching handlers multiple times if this script runs more than once
        // Skip extension fields (we don't auto-format extensions)
        var nm = (input.getAttribute('name') || '').toLowerCase();
        var id = (input.getAttribute('id') || '').toLowerCase();
        if (nm.includes('ext') || id.includes('ext') || nm.includes('phone_ext') || id.includes('phone_ext')) {
          return;
        }
        if (input.dataset && input.dataset.phoneWired === '1') {
          return;
        }
        setupAutoPhone(input);
        // Tag for later validation hooks (phone vs fax)
        if (input.classList && input.classList.contains('js-fax')) {
          input.dataset.maskType = 'fax';
        } else {
          input.dataset.maskType = 'phone';
        }
        if (input.dataset) {
          input.dataset.phoneWired = '1';
        }
      });
    });
  </script>

  <script>
    // Preserve scroll position per page using sessionStorage.
    (function () {
      try {
        var pathKey = 'scrollPos:' + window.location.pathname;

        function restoreScroll() {
          try {
            if (!window.sessionStorage) return;
            var saved = window.sessionStorage.getItem(pathKey);
            if (saved !== null) {
              var y = parseInt(saved, 10);
              if (!isNaN(y)) {
                window.scrollTo(0, y);
              }
            }
          } catch (e) {
            // Ignore storage errors
          }
        }

        function saveScroll() {
          try {
            if (!window.sessionStorage) return;
            var y = window.scrollY || window.pageYOffset || 0;
            window.sessionStorage.setItem(pathKey, String(y));
          } catch (e) {
            // Ignore storage errors
          }
        }

        document.addEventListener('DOMContentLoaded', restoreScroll);
        window.addEventListener('scroll', saveScroll);
        window.addEventListener('beforeunload', saveScroll);
      } catch (e) {
        if (window.console && console.warn) {
          console.warn('Scroll persistence failed:', e);
        }
      }
    })();
  </script>

  <script>
  // Flash alert behavior:
  // - Persistent until first click/keypress: validation/errors (danger/warning)
  // - Floating persistent: explicit saves/deletes (success containing keywords)
  // - Auto-dismiss: everything else
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var alerts = document.querySelectorAll('.js-auto-dismiss');

      function normalizeText(el) {
        try {
          var msgEl = el ? el.querySelector('.js-flash-msg') : null;
          var raw = msgEl ? (msgEl.textContent || '') : (el.textContent || '');
          return String(raw || '').toLowerCase().trim();
        } catch (e) {
          return '';
        }
      }

      function textIncludesAny(t, arr) {
        if (!t) return false;
        t = String(t).toLowerCase();
        for (var i = 0; i < arr.length; i++) {
          if (t.indexOf(arr[i]) !== -1) return true;
        }
        return false;
      }

      function bsClose(el) {
        try {
          if (window.bootstrap && window.bootstrap.Alert) {
            var inst = window.bootstrap.Alert.getOrCreateInstance(el);
            inst.close();
          } else {
            el.remove();
          }
        } catch (e) {
          try { el.remove(); } catch (e2) {}
        }
      }

      function wirePersistent(el) {
        function dismissOnce() {
          bsClose(el);
          document.removeEventListener('click', dismissOnce, true);
          document.removeEventListener('keydown', dismissOnce, true);
          document.removeEventListener('touchstart', dismissOnce, true);
        }

        // Clicking the alert itself dismisses immediately
        el.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          dismissOnce();
        });

        document.addEventListener('click', dismissOnce, true);
        document.addEventListener('touchstart', dismissOnce, true);
        document.addEventListener('keydown', dismissOnce, true);
      }

      function wireAuto(el, ms) {
        // Click-to-dismiss
        el.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          bsClose(el);
        });

        window.setTimeout(function () {
          bsClose(el);
        }, ms);
      }

      // Optional: highlight a specific field if the message includes a token like: [field=phone]
      alerts.forEach(function (alertEl) {
        try {
          var msgEl = alertEl.querySelector('.js-flash-msg');
          if (!msgEl) return;

          var raw = msgEl.textContent || '';
          var m = raw.match(/\[field=([^\]]+)\]\s*/i);
          if (!m) return;

          var fieldName = (m[1] || '').trim();
          if (!fieldName) return;

          // Remove token from displayed message
          msgEl.textContent = raw.replace(m[0], '');

          var target = document.querySelector('[name="' + CSS.escape(fieldName) + '"]') ||
                       document.getElementById(fieldName);

          if (target) {
            target.classList.add('is-invalid');
            target.classList.add('flash-field-highlight');
            window.setTimeout(function () {
              target.classList.remove('flash-field-highlight');
            }, 2500);
          }
        } catch (e) {
          // ignore
        }
      });

      // Promote ONLY "save/delete" success flashes into the floating alert.
      // Everything else stays in the normal flash stack and auto-dismisses.
      try {
        var successAlerts = document.querySelectorAll('.flash-container .alert-success');
        if (successAlerts && successAlerts.length && window.showFloatingAlert) {
          var keepKeywords = ['saved', 'changes saved', 'deleted', 'removed'];
          var promoted = [];

          successAlerts.forEach(function (el) {
            var txt = normalizeText(el);
            if (textIncludesAny(txt, keepKeywords)) {
              // Keep original casing in floating alert
              var msgEl = el.querySelector('.js-flash-msg');
              var raw = msgEl ? (msgEl.textContent || '').trim() : (el.textContent || '').trim();
              if (raw) promoted.push(raw);

              // Remove from regular flashes to avoid duplicates
              bsClose(el);
            }
          });

          if (promoted.length) {
            window.showFloatingAlert(promoted.join('\n'), 'success', { persistent: true });
          }
        }
      } catch (e) {
        // ignore
      }

      // Recompute after promotions
      alerts = document.querySelectorAll('.js-auto-dismiss');
      if (!alerts || !alerts.length) return;

      alerts.forEach(function (el) {
        var isDanger = el.classList.contains('alert-danger');
        var isWarn = el.classList.contains('alert-warning');
        var isSuccess = el.classList.contains('alert-success');

        // Validation/errors: persistent until interaction
        if (isDanger || isWarn) {
          wirePersistent(el);
          return;
        }

        // Everything else auto-dismiss
        if (isSuccess) {
          wireAuto(el, 2500);
          return;
        }

        if (el.classList.contains('alert-info') || el.classList.contains('alert-primary') || el.classList.contains('alert-secondary')) {
          wireAuto(el, 3000);
          return;
        }

        wireAuto(el, 3000);
      });

    } catch (e) {
      // ignore
    }
  });
  </script>
  {% endblock %}
</body>
</html>