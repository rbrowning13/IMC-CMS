<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  {#
    Tab title policy:
    - Pages can set `page_title` in render_template() for a contextual title.
      We prefer: "LastName, FirstName, ClaimNumber" (no extra "Claim" text).
    - If `page_title` is provided, the final browser tab title becomes:
        "<page_title> â€“ Impact CMS"
    - If `page_title` is not provided, templates may still override `{% block title %}`.
  #}
  <title>
    {#
      Browser tab title policy:
      Prefer: "Last, First - ClaimNumber - Impact CMS" when we can infer a claim context.
      Otherwise: "<page_title> - Impact CMS".
    #}

    {# Try to discover a claim object from common contexts #}
    {% set _ctx_claim = None %}
    {% if claim is defined and claim %}
      {% set _ctx_claim = claim %}
    {% elif report is defined and report and report.claim %}
      {% set _ctx_claim = report.claim %}
    {% elif invoice is defined and invoice and invoice.claim %}
      {% set _ctx_claim = invoice.claim %}
    {% endif %}

    {# Extract claimant + claim number using best-effort attribute fallbacks #}
    {% set _last = '' %}
    {% set _first = '' %}
    {% set _claimno = '' %}
    {% set _display_name = '' %}

    {% if _ctx_claim %}
      {# Claim number fallbacks #}
      {% set _claimno = (_ctx_claim.claim_number if _ctx_claim.claim_number is defined else '') %}
      {% if not _claimno %}{% set _claimno = (_ctx_claim.claim_no if _ctx_claim.claim_no is defined else '') %}{% endif %}
      {% if not _claimno %}{% set _claimno = (_ctx_claim.number if _ctx_claim.number is defined else '') %}{% endif %}

      {# Prefer explicit first/last fields if present #}
      {% set _last = (_ctx_claim.claimant_last_name if _ctx_claim.claimant_last_name is defined else '') %}
      {% if not _last %}{% set _last = (_ctx_claim.claimant_last if _ctx_claim.claimant_last is defined else '') %}{% endif %}

      {% set _first = (_ctx_claim.claimant_first_name if _ctx_claim.claimant_first_name is defined else '') %}
      {% if not _first %}{% set _first = (_ctx_claim.claimant_first if _ctx_claim.claimant_first is defined else '') %}{% endif %}

      {# Single-field claimant name fallbacks ("First Last" or "Last, First") #}
      {% if (not _last and not _first) %}
        {% set _raw_name = '' %}
        {% if _ctx_claim.claimant_name is defined %}{% set _raw_name = _ctx_claim.claimant_name %}{% endif %}
        {% if (not _raw_name) and (_ctx_claim.claimant is defined) %}{% set _raw_name = _ctx_claim.claimant %}{% endif %}
        {% if _raw_name %}
          {% set _raw_name = (_raw_name | string) | trim %}
          {% if ',' in _raw_name %}
            {# Already "Last, First" #}
            {% set _display_name = _raw_name %}
          {% else %}
            {# Assume "First Last" (or "First Middle Last") #}
            {% set _parts = _raw_name.split() %}
            {% if _parts|length >= 2 %}
              {% set _display_name = _parts[-1] ~ ', ' ~ (_parts[0:-1] | join(' ')) %}
            {% else %}
              {% set _display_name = _raw_name %}
            {% endif %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}

    {% set _has_claim_bits = (_last or _first or _display_name or _claimno) %}

    {# Compose the clean claim-based title when claim bits are available #}
    {% if _has_claim_bits %}
      {% if _display_name %}
        {% set _name = _display_name %}
      {% else %}
        {% set _name = (_last ~ ', ' ~ _first) if (_last and _first) else (_last or _first) %}
      {% endif %}

      {# Desired format: "Last, First - ClaimNumber - Impact CMS" (NO extra "Claim" text) #}
      {# Optional report context: add "<Type> Report <N>" so multiple report tabs are distinguishable #}
      {% set _report_suffix = '' %}
      {% if report is defined and report %}
        {# Determine report type label #}
        {% set _rtype = (report.report_type if report.report_type is defined else '') %}
        {% if not _rtype and (report.type if report.type is defined else '') %}
          {% set _rtype = report.type %}
        {% endif %}
        {% if _rtype %}
          {% set _rtype = (_rtype | string) | trim %}
          {# Normalize common stored values -> pretty labels #}
          {% if _rtype|lower == 'initial' %}{% set _rtype = 'Initial' %}{% endif %}
          {% if _rtype|lower == 'progress' %}{% set _rtype = 'Progress' %}{% endif %}
          {% if _rtype|lower == 'closure' %}{% set _rtype = 'Closure' %}{% endif %}
        {% endif %}

        {# Determine report sequence number within the claim (best-effort).
           Prefer route-provided numbers (matches UI header), then fall back to sorting claim.reports.
        #}
        {% set _rnum = none %}

        {# Prefer any explicit context variables the report pages may set #}
        {% if report_display_number is defined and report_display_number %}
          {% set _rnum = report_display_number %}
        {% elif report_number is defined and report_number %}
          {% set _rnum = report_number %}
        {% elif report_seq is defined and report_seq %}
          {% set _rnum = report_seq %}
        {% elif report_index is defined and report_index %}
          {% set _rnum = report_index %}
        {% endif %}

        {# If still unknown, try to compute from claim.reports when available #}
        {% if not _rnum and report.claim is defined and report.claim and report.claim.reports is defined and report.claim.reports %}
          {# Sort reports safely. NOTE: sorting by dos_start/dos_end can throw TypeError when any DOS is NULL.
             We keep it deterministic by sorting by id only (and optionally created_at if present in your data).
          #}
          {% set _sorted = report.claim.reports | sort(attribute='id') %}
          {% for r in _sorted %}
            {% if r and (r.id is defined) and (report.id is defined) and (r.id == report.id) %}
              {% set _rnum = loop.index %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {# Match on-screen header wording: e.g., "Progress Report 3" #}
        {% if _rtype and _rnum %}
          {% set _report_suffix = _rtype ~ ' Report ' ~ _rnum %}
        {% elif _rtype %}
          {% set _report_suffix = _rtype ~ ' Report' %}
        {% endif %}
      {% endif %}

      {% set _core = (_name ~ ' - ' ~ _claimno) if (_name and _claimno) else (_name or _claimno) %}
      {% if _report_suffix %}
        {% set _core = _core ~ ' - ' ~ _report_suffix %}
      {% endif %}
      {{ _core }} - Impact CMS

    {# Otherwise, use page_title if provided #}
    {% elif page_title %}
      {% set _pt = (page_title | string) | trim %}
      {{ _pt }} - Impact CMS

    {# Fallback for pages that still override the block title #}
    {% else %}
      {% block title %}Impact CMS{% endblock %}
    {% endif %}
  </title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <!-- Flatpickr date picker CSS (CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <!-- App stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  {# Global accent color from Settings (used by style.css via --accent-color) #}
  {% set _accent_color = (settings.accent_color if settings and settings.accent_color else '') %}
  {% set _accent_color = (_accent_color | string) | trim %}
  {% if not _accent_color %}
    {% set _accent_color = '#d6871f' %}
  {% endif %}
  <style>
    :root {
      /* Brand accent color (overrides the fallback defined in style.css) */
      --accent-color: {{ _accent_color }};
    }

    /* Page background/text should follow theme (avoid hard-coded Bootstrap bg-light on <body>) */
    body.impact-body {
      background: var(--bs-body-bg, #ffffff);
      color: var(--bs-body-color, #111111);
    }

    .dark-mode body.impact-body {
      background: #0f0f0f;
      color: #ffffff;
    }
    /* Centered flash messages (fixed overlay) */
    .flash-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: min(720px, calc(100vw - 2rem));
      pointer-events: none; /* allow clicks through except the alerts */
    }

    .flash-container .alert {
      pointer-events: auto;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }

    /* Stronger error emphasis */
    .flash-container .alert-danger {
      border-width: 2px;
    }

    /* Temporary highlight for invalid fields when flash includes [field=...] */
    .flash-field-highlight {
      outline: 3px solid rgba(220, 53, 69, 0.55); /* bootstrap danger-ish */
      outline-offset: 2px;
      animation: flashOutline 900ms ease-in-out 0s 2;
    }

    @keyframes flashOutline {
      0%   { outline-color: rgba(220, 53, 69, 0.15); }
      50%  { outline-color: rgba(220, 53, 69, 0.75); }
      100% { outline-color: rgba(220, 53, 69, 0.15); }
    }

    /* Global floating alert (used for save confirmations + validation notices) */
    .floating-alert-host {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1090;
      width: min(720px, calc(100vw - 2rem));
      pointer-events: none;
    }

    .floating-alert-host .alert {
      pointer-events: auto;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
      border-width: 2px;
    }

    /* Save confirmation styling (success)
       Apply to BOTH the floating alert (preferred) and regular flashed success alerts.
       Use !important to reliably override Bootstrap defaults.
    */
    .floating-alert-host .alert-success,
    .flash-container .alert-success {
      background-color: #ffffff !important;
      color: #111111 !important;
      border: 10px solid var(--accent-color, #198754) !important;
    }

    .dark-mode .floating-alert-host .alert-success,
    .dark-mode .flash-container .alert-success {
      background-color: #000000 !important;
      color: #ffffff !important;
      border: 10px solid var(--accent-color, #198754) !important;
    }

    /* Accent-aware styling (works in light & dark if --accent-color is defined in CSS) */
    .floating-alert-host .alert-accent {
      border-color: var(--accent-color, #0d6efd);
    }

    .floating-alert-host .alert-danger {
      border-color: var(--accent-color, #dc3545);
    }

    /* Sticky header: navbar + global AI bar */
    .impact-sticky-header {
      position: sticky;
      top: 0;
      z-index: 1100;
      background-color: var(--bs-body-bg);
    }

    .dark-mode .impact-sticky-header {
      background-color: #0f0f0f;
    }

    /* Ensure body content clears the sticky header height */
    body {
      scroll-padding-top: 110px; /* navbar + AI bar approx height */
    }

    .impact-main {
      position: relative;
      z-index: 1;
    }

    /* Florence dock layout (no backdrop; app remains interactive) */
    :root {
      --clarity-dock-width: 420px;
      --clarity-dock-border: rgba(0,0,0,0.15);
      --clarity-dock-bg: #ffffff;
      --clarity-dock-fg: #111111;
    }

    .dark-mode {
      --clarity-dock-border: rgba(255,255,255,0.14);
      --clarity-dock-bg: #0f0f0f;
      --clarity-dock-fg: #ffffff;
    }

    .clarity-dock {
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      width: var(--clarity-dock-width);
      z-index: 1200;
      background: var(--clarity-dock-bg);
      color: var(--clarity-dock-fg);
      border-left: 1px solid var(--clarity-dock-border);
      box-shadow: -12px 0 28px rgba(0,0,0,0.12);
      transform: translateX(100%);
      transition: transform 180ms ease;
      display: block;
    }

    body.clarity-open .clarity-dock {
      transform: translateX(0);
    }

    .clarity-dock-inner {
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .clarity-dock-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.75rem 0.75rem;
      border-bottom: 1px solid var(--clarity-dock-border);
    }

    .clarity-dock-body {
      display: flex;
      flex-direction: column;
      height: 100%;
      min-height: 0;
    }

    .clarity-chat-messages {
      padding: 0.75rem;
      flex: 1 1 auto;
      overflow-y: auto;
      min-height: 0;
    }

    .clarity-chat-input {
      border-top: 1px solid var(--clarity-dock-border);
      padding: 0.5rem;
      background: var(--clarity-dock-bg);
    }

    /* Desktop: shift app content so both app + chat are usable */
    @media (min-width: 992px) {
      body.clarity-open .impact-sticky-header,
      body.clarity-open .impact-main {
        margin-right: var(--clarity-dock-width);
      }
    }

    /* Small screens: overlay (no shift) */
    @media (max-width: 991.98px) {
      :root { --clarity-dock-width: min(92vw, 420px); }
      body.clarity-open .impact-sticky-header,
      body.clarity-open .impact-main {
        margin-right: 0;
      }
    }

    .dark-mode .clarity-dock .form-control {
      background-color: #111111;
      color: #ffffff;
      border-color: rgba(255,255,255,0.18);
    }

    .dark-mode .clarity-dock .form-control::placeholder {
      color: rgba(255,255,255,0.55);
    }

    /* Clarity dock buttons should remain readable in dark mode */
    .dark-mode .clarity-dock .btn-outline-secondary {
      color: rgba(255, 255, 255, 0.85);
      border-color: rgba(255, 255, 255, 0.25);
    }

    .dark-mode .clarity-dock .btn-outline-secondary:hover {
      color: #ffffff;
      border-color: rgba(255, 255, 255, 0.45);
      background: rgba(255, 255, 255, 0.06);
    }

    /* Clarity dock separators in dark mode */
    .dark-mode .clarity-dock-header,
    .dark-mode .clarity-chat-input {
      border-color: rgba(255,255,255,0.14);
    }

    .clarity-citations {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .clarity-citation-pill {
      background: rgba(13,110,253,0.15);
      border: 1px solid rgba(13,110,253,0.35);
      color: inherit;
      text-decoration: none;
      cursor: pointer;
    }

    .clarity-citation-pill:hover {
      background: rgba(13,110,253,0.25);
    }

    .dark-mode .clarity-citation-pill {
      background: rgba(13,110,253,0.25);
    }

    /* Navbar brand width stabilization (fixed column, no reflow) */
    .impact-brand {
      width: 320px;
      min-width: 320px;
      max-width: 320px;
      flex: 0 0 320px;        /* hard lock width so nav items never shift */
      overflow: hidden;
      white-space: nowrap;
    }

    .impact-brand-text {
      display: block;
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      font-size: 1.35rem;
      line-height: 1.15;
    }

    .impact-brand-company {
      color: #ffffff;
    }

    .impact-brand-claimant {
      color: var(--accent-color);
      font-weight: 600;
    }

    .navbar .container-fluid {
      flex-wrap: nowrap;
    }

    /* Flatpickr month navigation arrows visibility + theming */
    .flatpickr-calendar .flatpickr-months .flatpickr-prev-month,
    .flatpickr-calendar .flatpickr-months .flatpickr-next-month {
      padding: 6px;
    }

    /* Light mode arrows */
    .flatpickr-calendar .flatpickr-months svg {
      fill: #000000;
      stroke: #000000;
      stroke-width: 3px;
    }

    /* Dark mode arrows */
    .dark-mode .flatpickr-calendar .flatpickr-months svg {
      fill: #ffffff;
      stroke: #ffffff;
      stroke-width: 3px;
    }

    /* Hover accent color */
    .flatpickr-calendar .flatpickr-months .flatpickr-prev-month:hover svg,
    .flatpickr-calendar .flatpickr-months .flatpickr-next-month:hover svg {
      fill: var(--accent-color);
      stroke: var(--accent-color);
    }

    /* Alternating row striping for better scanability */
    table tbody tr:nth-child(even) {
      background-color: #f8f9fb;
    }

    /* Slightly darker striping in dark mode */
    .dark-mode table tbody tr:nth-child(even) {
      background-color: #1a1a1a;
    }

    /* Increase vertical padding for table cells */
    table tbody tr td,
    table tbody tr th {
      padding-top: 12px;
      padding-bottom: 12px;
    }

  </style>
</head>
<body
  class="impact-body"
  {% if claim is defined and claim %}
    data-claim-id="{{ claim.id }}"
  {% elif invoice is defined and invoice and invoice.claim %}
    data-claim-id="{{ invoice.claim.id }}"
    data-invoice-id="{{ invoice.id }}"
  {% elif report is defined and report and report.claim %}
    data-claim-id="{{ report.claim.id }}"
    data-report-id="{{ report.id }}"
  {% endif %}
>

  <!-- Top navbar -->
  <header class="impact-sticky-header">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <!-- Brand / Logo -->
        {% set brand_name_raw = settings.business_name if settings and settings.business_name else 'Impact Medical CMS' %}
        {#
          Defensive: if Settings.business_name accidentally contains pasted code (newlines, decorators, imports),
          donâ€™t render it across every page.
        #}
        {% set brand_name_clean = (brand_name_raw or '') | replace('\r', ' ') | replace('\n', ' ') | trim %}
        {% if ('from flask import' in brand_name_clean) or ('@app.route' in brand_name_clean) or ('def ' in brand_name_clean and 'route' in brand_name_clean) %}
          {% set brand_name_clean = 'Impact Medical CMS' %}
        {% endif %}
        {% if brand_name_clean|length > 80 %}
          {% set brand_name_clean = brand_name_clean[:77] ~ 'â€¦' %}
        {% endif %}
        <a class="navbar-brand d-flex flex-column align-items-center impact-brand" href="{{ url_for('main.claims_list') }}">
          {% if claim is defined and claim %}
            <span class="impact-brand-text impact-brand-claimant">
              {{ claim.claimant_last_name }}, {{ claim.claimant_first_name }}
            </span>
          {% elif invoice is defined and invoice and invoice.claim %}
            <span class="impact-brand-text impact-brand-claimant">
              {{ invoice.claim.claimant_last_name }}, {{ invoice.claim.claimant_first_name }}
            </span>
          {% elif report is defined and report and report.claim %}
            <span class="impact-brand-text impact-brand-claimant">
              {{ report.claim.claimant_last_name }}, {{ report.claim.claimant_first_name }}
            </span>
          {% else %}
            <span class="impact-brand-text impact-brand-company">
              {{ brand_name_clean }}
            </span>
          {% endif %}
        </a>

        <!-- Mobile nav toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
                aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Nav links -->
        <div class="collapse navbar-collapse d-flex align-items-center" id="mainNavbar">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'analysis' %}active{% endif %}"
                 href="{{ url_for('main.analysis_view') }}">Dashboard</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'claims' %}active{% endif %}"
                 href="{{ url_for('main.claims_list') }}">Claims</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'billing' %}active{% endif %}"
                 href="{{ url_for('main.billing_list') }}">Billing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'carriers' %}active{% endif %}"
                 href="{{ url_for('main.carriers_list') }}">Carriers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'employers' %}active{% endif %}"
                 href="{{ url_for('main.employers_list') }}">Employers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'providers' %}active{% endif %}"
                 href="{{ url_for('main.providers_list') }}">Providers</a>
            </li>

            <li class="nav-item">
              <a class="nav-link {% if active_page == 'forms' %}active{% endif %}"
                 href="{{ url_for('main.forms_index') }}">Forms</a>
            </li>

            <li class="nav-item">
              <a class="nav-link {% if active_page == 'reporting' %}active{% endif %}"
                 href="{{ url_for('main.reporting_dashboard') }}">Reporting</a>
            </li>
          <li class="nav-item">
            <a class="nav-link {% if active_page == 'settings' %}active{% endif %}"
               href="{{ url_for('main.settings_view') }}">Settings</a>
          </li>
          </ul>

          <!-- Right side: theme toggle + version -->
          <div class="d-flex align-items-center gap-2">
          <button
            id="clarityChatToggle"
            type="button"
            class="btn btn-sm btn-outline-light"
            aria-controls="clarityChat"
            aria-expanded="false"
            title="Open Clarity chat"
          >
            Clarity
          </button>
            <button id="themeToggle"
                    type="button"
                    class="btn btn-sm btn-outline-light"
                    aria-label="Toggle dark mode">
              ðŸŒ“
            </button>
            <span class="navbar-text text-secondary small">
              v{{ config.APP_VERSION }}
            </span>
          </div>
        </div>
      </div>
  </nav>

<!-- Clarity Chat (docked, persistent sidebar) -->
<aside id="clarityChat" class="clarity-dock" aria-labelledby="clarityChatLabel" aria-hidden="true">
  <div class="clarity-dock-inner">
    <div class="clarity-dock-header">
      <h5 class="m-0" id="clarityChatLabel">Clarity</h5>
      <div class="d-flex gap-2">
        <button id="clarityChatCopyBtn" type="button" class="btn btn-sm btn-outline-secondary" title="Copy latest Clarity reply">Copy</button>
        <button id="clarityChatClearBtn" type="button" class="btn btn-sm btn-outline-secondary" title="Clear chat">Clear</button>
        <button id="clarityChatCloseBtn" type="button" class="btn btn-sm btn-outline-secondary" aria-label="Close">âœ•</button>
      </div>
    </div>

    <div class="clarity-dock-body">
      <div id="clarityChatMessages" class="clarity-chat-messages"></div>

      <div class="clarity-chat-input">
        <form id="clarityChatForm" class="d-flex gap-2" autocomplete="off">
          <input
            type="text"
            id="clarityChatInput"
            class="form-control"
            placeholder="Ask Clarityâ€¦"
            aria-label="Ask Clarity"
          >
          <button type="submit" class="btn btn-outline-secondary">Send</button>
        </form>
        <div id="clarityChatHint" class="text-muted small mt-1"></div>
      </div>
    </div>
  </div>
</aside>
  </header>

  <!-- Page content -->
  <main class="container-fluid py-3 impact-main">

    <!-- Global floating alert host (JS-managed) -->
    <div id="floatingAlertHost" class="floating-alert-host" aria-live="polite" aria-atomic="true"></div>

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            {% set bs_category = 'info' %}
            {% if category in ['success','info','warning','danger','primary','secondary','light','dark'] %}
              {% set bs_category = category %}
            {% elif category in ['error'] %}
              {% set bs_category = 'danger' %}
            {% endif %}
            <div class="alert alert-{{ bs_category }} alert-dismissible fade show mb-2 js-auto-dismiss" role="alert">
              <span class="js-flash-msg">{{ message }}</span>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  {% block scripts %}
  <!-- Bootstrap 5 JS bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <script>
    // Global floating alert helper.
    // Usage: window.showFloatingAlert('Changes saved', 'success')
    // Levels: success | info | warning | danger | primary | secondary | light | dark
    (function () {
      function normalizeLevel(level) {
        var allowed = ['success','info','warning','danger','primary','secondary','light','dark'];
        if (!level) return 'info';
        level = String(level).toLowerCase();
        return allowed.indexOf(level) !== -1 ? level : 'info';
      }

      function getHost() {
        return document.getElementById('floatingAlertHost');
      }

      function removeHostChildren(host) {
        if (!host) return;
        while (host.firstChild) host.removeChild(host.firstChild);
      }

      function detachDismissListeners(state) {
        if (!state) return;
        if (state.onDismiss) {
          document.removeEventListener('click', state.onDismiss, true);
          document.removeEventListener('keydown', state.onDismiss, true);
          state.onDismiss = null;
        }
      }

      var _state = { onDismiss: null };

      window.clearFloatingAlert = function () {
        var host = getHost();
        detachDismissListeners(_state);
        removeHostChildren(host);
      };

      function textIncludesAny(t, arr) {
        if (!t) return false;
        t = String(t).toLowerCase();
        for (var i = 0; i < arr.length; i++) {
          if (t.indexOf(arr[i]) !== -1) return true;
        }
        return false;
      }

      window.showFloatingAlert = function (message, level, opts) {
        try {
          var host = getHost();
          if (!host) return;

          opts = opts || {};
          var bsLevel = normalizeLevel(level);
          var msgText = message || '';

          // Default policy: auto-dismiss most things.
          // Persist only for explicit saves/deletes (or when opts.persistent is true).
          var defaultKeywords = ['saved', 'changes saved', 'deleted', 'removed'];
          var persistent = !!opts.persistent || (bsLevel === 'success' && textIncludesAny(msgText, defaultKeywords));
          var autoMs = (typeof opts.autoDismissMs === 'number') ? opts.autoDismissMs : (bsLevel === 'success' ? 2500 : 3000);

          // Clear any previous floating alert
          window.clearFloatingAlert();

          var alertEl = document.createElement('div');
          alertEl.className = 'alert alert-' + bsLevel + ' alert-dismissible fade show alert-accent';
          alertEl.setAttribute('role', 'alert');

          var msgSpan = document.createElement('span');
          msgSpan.textContent = msgText;
          alertEl.appendChild(msgSpan);

          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn-close';
          btn.setAttribute('data-bs-dismiss', 'alert');
          btn.setAttribute('aria-label', 'Close');
          alertEl.appendChild(btn);

          host.appendChild(alertEl);

          function dismiss() {
            try {
              if (window.bootstrap && window.bootstrap.Alert) {
                var inst = window.bootstrap.Alert.getOrCreateInstance(alertEl);
                inst.close();
              } else {
                alertEl.classList.remove('show');
                alertEl.remove();
              }
            } finally {
              detachDismissListeners(_state);
              removeHostChildren(host);
            }
          }

          // Close button works as normal
          btn.addEventListener('click', function (e) {
            e.preventDefault();
            dismiss();
          });

          // Allow click on alert to dismiss
          alertEl.addEventListener('click', function (e) {
            e.stopPropagation();
          });

          if (persistent) {
            _state.onDismiss = function () { dismiss(); };
            document.addEventListener('click', _state.onDismiss, true);
            document.addEventListener('keydown', _state.onDismiss, true);
          } else {
            // Auto-dismiss
            window.setTimeout(function () {
              dismiss();
            }, autoMs);
          }

        } catch (e) {
          // Silent fail (alerts shouldn't break pages)
        }
      };
    })();
  </script>
  <script>
    // Clarity chat sidebar (persistent, app-wide)
    document.addEventListener('DOMContentLoaded', function () {
      var chatEl = document.getElementById('clarityChat');
      var messagesEl = document.getElementById('clarityChatMessages');
      var formEl = document.getElementById('clarityChatForm');
      var inputEl = document.getElementById('clarityChatInput');
      var hintEl = document.getElementById('clarityChatHint');
      var clearBtn = document.getElementById('clarityChatClearBtn');
      var copyBtn = document.getElementById('clarityChatCopyBtn');
      var toggleBtn = document.getElementById('clarityChatToggle');
      var closeBtn = document.getElementById('clarityChatCloseBtn');

      if (!chatEl || !messagesEl || !formEl || !inputEl) return;

      // Docked chat: no Bootstrap offcanvas; we manage open/close by toggling body.clarity-open
      // Infer lightweight context (matches /api/florence/query expectations)
      var context = {};
      if (document.body.dataset.claimId) {
        context.page = 'claim_detail';
        context.claim_id = document.body.dataset.claimId;
      } else if (document.body.dataset.invoiceId) {
        context.page = 'invoice_detail';
        context.invoice_id = document.body.dataset.invoiceId;
      } else if (document.body.dataset.reportId) {
        context.page = 'report_detail';
        context.report_id = document.body.dataset.reportId;
      } else {
        // Default to system scope, but try to infer which index page we're on.
        var path = (window.location && window.location.pathname) ? String(window.location.pathname) : '';
        if (path === '/claims' || path.indexOf('/claims') === 0) {
          context.page = 'claims_index';
        } else if (path === '/billing' || path.indexOf('/billing') === 0) {
          context.page = 'billing_index';
        } else if (path === '/carriers' || path.indexOf('/carriers') === 0) {
          context.page = 'carriers_index';
        } else if (path === '/employers' || path.indexOf('/employers') === 0) {
          context.page = 'employers_index';
        } else if (path === '/providers' || path.indexOf('/providers') === 0) {
          context.page = 'providers_index';
        } else {
          context.page = 'system';
        }
      }

      // Build a lightweight, privacy-safe snapshot of the current page when we're on an index view.
      // This lets Florence answer simple counting/listing questions without needing per-claim retrieval.
      function buildPageSnapshot(ctx) {
        try {
          var snap = {
            url: window.location.pathname,
            title: document.title,
            page: (ctx && ctx.page) ? ctx.page : 'system'
          };

          // Claims index: scrape the visible table (counts + basic rows)
          if (snap.page === 'claims_index') {
            var table = document.querySelector('table');
            var rows = table ? table.querySelectorAll('tbody tr') : null;
            var claims = [];
            var openCount = 0;
            var closedCount = 0;

            if (rows && rows.length) {
              rows.forEach(function (tr) {
                try {
                  var tds = tr.querySelectorAll('td');
                  if (!tds || !tds.length) return;

                  // Column order in your claims list is: Claim #, Claimant, Carrier, Employer, Status, ...
                  var claimNo = (tds[0] && tds[0].innerText) ? String(tds[0].innerText).trim() : '';
                  var claimant = (tds[1] && tds[1].innerText) ? String(tds[1].innerText).trim() : '';
                  var carrier = (tds[2] && tds[2].innerText) ? String(tds[2].innerText).trim() : '';
                  var employer = (tds[3] && tds[3].innerText) ? String(tds[3].innerText).trim() : '';

                  // Status is usually a badge inside the 5th cell
                  var statusText = '';
                  if (tds[4]) {
                    statusText = String(tds[4].innerText || '').trim();
                  }

                  // Try to capture claim id from the first link (href like /claims/<id>)
                  var claimId = null;
                  var a = tds[0] ? tds[0].querySelector('a[href]') : null;
                  if (a && a.getAttribute) {
                    var href = String(a.getAttribute('href') || '');
                    var m = href.match(/\/claims\/(\d+)/);
                    if (m) claimId = m[1];
                  }

                  var statusLower = String(statusText || '').toLowerCase();
                  if (statusLower.indexOf('open') !== -1) openCount += 1;
                  if (statusLower.indexOf('closed') !== -1) closedCount += 1;

                  claims.push({
                    claim_id: claimId,
                    claim_number: claimNo,
                    claimant: claimant,
                    carrier: carrier,
                    employer: employer,
                    status: statusText
                  });
                } catch (eRow) {
                  // ignore a row
                }
              });
            }

            snap.claims = claims;
            snap.counts = {
              total_visible: claims.length,
              open_visible: openCount,
              closed_visible: closedCount
            };
          }

          // Billing index: scrape visible invoices table (optional, but cheap)
          if (snap.page === 'billing_index') {
            var tableB = document.querySelector('table');
            var rowsB = tableB ? tableB.querySelectorAll('tbody tr') : null;
            var invoices = [];
            if (rowsB && rowsB.length) {
              rowsB.forEach(function (tr) {
                try {
                  var tds = tr.querySelectorAll('td');
                  if (!tds || !tds.length) return;
                  var invoiceNo = (tds[0] && tds[0].innerText) ? String(tds[0].innerText).trim() : '';
                  var claim = (tds[1] && tds[1].innerText) ? String(tds[1].innerText).trim() : '';
                  var carrier = (tds[2] && tds[2].innerText) ? String(tds[2].innerText).trim() : '';
                  var status = (tds[3] && tds[3].innerText) ? String(tds[3].innerText).trim() : '';
                  invoices.push({ invoice: invoiceNo, claim: claim, carrier: carrier, status: status });
                } catch (eRowB) {
                  // ignore
                }
              });
            }
            snap.invoices = invoices;
            snap.counts = snap.counts || {};
            snap.counts.total_visible = invoices.length;
          }

          return snap;
        } catch (e) {
          return { url: window.location.pathname, title: document.title, page: (ctx && ctx.page) ? ctx.page : 'system' };
        }
      }

      // Defensive: avoid sending null/empty IDs (prevents server-side "NULL primary key" warnings)
      ['claim_id','invoice_id','report_id'].forEach(function (k) {
        try {
          if (context[k] === null || context[k] === undefined || String(context[k]).trim() === '' || String(context[k]).toLowerCase() === 'none') {
            delete context[k];
          }
        } catch (e) {
          // ignore
        }
      });

      var scopeKey = (context.claim_id || context.invoice_id || context.report_id || 'system');
      var storageKey = 'clarity_chat:' + scopeKey;
      var openKey = 'clarity_chat_open';

      // Thread state persistence (required for clarifying-question followups)
      // Store separately from message history; per-scope so claim threads don't bleed.
      var threadKey = 'clarity_thread_state:' + scopeKey;

      function loadThreadState() {
        try {
          var raw = window.localStorage.getItem(threadKey);
          if (!raw) return null;
          var obj = safeJsonParse(raw, null);
          return obj && typeof obj === 'object' ? obj : null;
        } catch (e) {
          return null;
        }
      }

      function saveThreadState(state) {
        try {
          if (!state || typeof state !== 'object') {
            window.localStorage.removeItem(threadKey);
            return;
          }
          window.localStorage.setItem(threadKey, JSON.stringify(state));
        } catch (e) {
          // ignore
        }
      }

      function safeJsonParse(s, fallback) {
        try { return JSON.parse(s); } catch (e) { return fallback; }
      }

      function loadHistory() {
        try {
          var raw = window.localStorage.getItem(storageKey);
          var arr = safeJsonParse(raw, []);
          return Array.isArray(arr) ? arr : [];
        } catch (e) {
          return [];
        }
      }

      function saveHistory(arr) {
        try {
          window.localStorage.setItem(storageKey, JSON.stringify(arr.slice(-100)));
        } catch (e) {
          // ignore
        }
      }

      function escapeHtml(s) {
        return String(s || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function renderMessage(m) {
        var who = (m && m.role) ? String(m.role) : 'assistant';
        var text = (m && m.text) ? String(m.text) : '';

        var wrap = document.createElement('div');
        wrap.className = 'mb-2';

        var bubble = document.createElement('div');
        bubble.className = 'p-2 rounded';
        bubble.style.whiteSpace = 'pre-wrap';

        if (who === 'user') {
          bubble.style.background = 'rgba(13,110,253,0.12)';
          bubble.style.border = '1px solid rgba(13,110,253,0.25)';
          bubble.innerHTML = '<strong>You:</strong> ' + escapeHtml(text);
        } else {
          bubble.style.background = 'rgba(214,135,31,0.10)';
          bubble.style.border = '1px solid rgba(214,135,31,0.30)';

          // Main answer text
          bubble.innerHTML = '<strong>Clarity:</strong> ' + escapeHtml(text);

          // --- INSERT ---
          // Confidence badge (compact)
          if (typeof m.confidence === 'number') {
            var confWrap = document.createElement('div');
            confWrap.className = 'mt-1';

            var confBadge = document.createElement('span');
            confBadge.className = 'badge bg-secondary';
            confBadge.textContent = 'Confidence: ' + m.confidence.toFixed(2);

            confWrap.appendChild(confBadge);
            bubble.appendChild(confWrap);
          }

          // Citations block
          if (Array.isArray(m.citations) && m.citations.length > 0) {
            var citesWrap = document.createElement('div');
            citesWrap.className = 'mt-2';

            var label = document.createElement('div');
            label.className = 'text-muted small mb-1';
            label.textContent = 'Sources:';
            citesWrap.appendChild(label);

            var cites = document.createElement('div');
            cites.className = 'clarity-citations';

            m.citations.forEach(function (c, idx) {
              if (!c) return;

              var pill = document.createElement('a');
              pill.className = 'badge rounded-pill clarity-citation-pill';

              if (typeof c === 'string') {
                pill.textContent = c;
                pill.href = '#';
              } else {
                pill.textContent = c.label || ('Source ' + (idx + 1));
                pill.href = c.url || '#';
                if (c.scope || c.type) {
                  pill.title = (c.scope || c.type);
                }
              }

              pill.target = '_blank';
              cites.appendChild(pill);
            });

            citesWrap.appendChild(cites);
            bubble.appendChild(citesWrap);
          }
          // --- END INSERT ---
        }

        wrap.appendChild(bubble);
        messagesEl.appendChild(wrap);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function renderAll() {
        messagesEl.innerHTML = '';
        var hist = loadHistory();
        hist.forEach(renderMessage);

        if (hintEl) {
          hintEl.textContent = 'Context: ' + (context.page || 'system') + ' Â· scope: ' + scopeKey;
        }
      }

      function push(role, text, meta) {
        var hist = loadHistory();
        var item = { role: role, text: text, ts: Date.now() };

        if (role === 'assistant' && meta && typeof meta === 'object') {
          if (typeof meta.confidence === 'number') item.confidence = meta.confidence;
          if (Array.isArray(meta.citations)) item.citations = meta.citations;
          if (meta.is_guess === true) item.is_guess = true;
        }

        hist.push(item);
        saveHistory(hist);
        renderMessage(item);
      }

      function getLatestAssistantText() {
        var hist = loadHistory();
        for (var i = hist.length - 1; i >= 0; i--) {
          if (hist[i] && hist[i].role === 'assistant' && hist[i].text) {
            return String(hist[i].text);
          }
        }
        return '';
      }

      async function copyTextToClipboard(text) {
        if (!text) return false;
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            return true;
          }
        } catch (e) {}

        try {
          var ta = document.createElement('textarea');
          ta.value = text;
          ta.setAttribute('readonly', '');
          ta.style.position = 'fixed';
          ta.style.top = '-9999px';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          return true;
        } catch (e) {
          return false;
        }
      }


      // Initial render
      renderAll();

      function setOpen(isOpen) {
        try {
          document.body.classList.toggle('clarity-open', !!isOpen);
          chatEl.setAttribute('aria-hidden', isOpen ? 'false' : 'true');
          if (toggleBtn) {
            toggleBtn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          }
          try { window.localStorage.setItem(openKey, isOpen ? '1' : '0'); } catch (e) {}
        } catch (e) {
          // ignore
        }
      }

      function toggleOpen() {
        var isOpen = document.body.classList.contains('clarity-open');
        setOpen(!isOpen);
        if (!isOpen) {
          window.setTimeout(function () {
            try { inputEl && inputEl.focus(); } catch (e) {}
          }, 50);
        }
      }

      if (toggleBtn) {
        toggleBtn.addEventListener('click', function (e) {
          e.preventDefault();
          toggleOpen();
        });
      }

      if (closeBtn) {
        closeBtn.addEventListener('click', function (e) {
          e.preventDefault();
          setOpen(false);
        });
      }

      // Restore open state from storage
      try {
        var wasOpen = window.localStorage.getItem(openKey);
        if (wasOpen === '1') setOpen(true);
      } catch (e) {}

      // Clear
      if (clearBtn) {
        clearBtn.addEventListener('click', function () {
          try { window.localStorage.removeItem(storageKey); } catch (e) {}
          try { window.localStorage.removeItem(threadKey); } catch (e) {}
          renderAll();
          if (window.showFloatingAlert) {
            window.showFloatingAlert('Clarity chat cleared', 'info', { autoDismissMs: 1200 });
          }
        });
      }

      // Copy latest assistant reply
      if (copyBtn) {
        copyBtn.addEventListener('click', async function () {
          var txt = getLatestAssistantText().trim();
          if (!txt) return;
          var ok = await copyTextToClipboard(txt);
          if (ok && window.showFloatingAlert) {
            window.showFloatingAlert('Copied latest Clarity reply', 'info', { autoDismissMs: 1200 });
          }
        });
      }

      // Submit
      formEl.addEventListener('submit', async function (e) {
        e.preventDefault();
        var q = (inputEl.value || '').trim();
        if (!q) return;

        push('user', q);
        inputEl.value = '';
        inputEl.disabled = true;

        try {
          // Load thread state + any pending clarification intent (follow-up answers like "both").
          var _threadState = loadThreadState() || {};
          var _pendingIntent = null;
          try {
            if (_threadState && typeof _threadState === 'object') {
              if (typeof _threadState.pending_intent === 'string' && _threadState.pending_intent.trim() !== '') {
                _pendingIntent = _threadState.pending_intent.trim();
              } else if (typeof _threadState.pendingIntent === 'string' && _threadState.pendingIntent.trim() !== '') {
                // tolerate legacy camelCase
                _pendingIntent = _threadState.pendingIntent.trim();
              }
            }
          } catch (e) {
            _pendingIntent = null;
          }

          var pageSnap = (function () {
            var snap = buildPageSnapshot(context);
            // Always include the key IDs we already expose via body dataset
            snap.claim_id = document.body.dataset.claimId || null;
            snap.invoice_id = document.body.dataset.invoiceId || null;
            snap.report_id = document.body.dataset.reportId || null;
            return snap;
          })();

          var resp = await fetch('/api/clarity/query', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: q,
              // Keep both names for compatibility with older/newer backends
              context: context,
              page_context: context,
              thread_state: _threadState,
              pending_intent: _pendingIntent,
              page_data: pageSnap
            })
          });

          if (!resp.ok) {
            throw new Error('Clarity request failed');
          }

          var data = await resp.json();
          if (data && data.ok === false) {
            throw new Error(data.error || data.message || 'Clarity returned ok=false');
          }

          // Persist thread state so follow-up answers (e.g., "both") resolve pending clarifiers.
          // Also persist a lightweight pending_intent string when the server asks a clarifying question.
          try {
            var _state = loadThreadState() || {};
            if (!_state || typeof _state !== 'object') _state = {};

            // Server may send a full state object
            if (data && data.thread_state_update && typeof data.thread_state_update === 'object') {
              _state = data.thread_state_update;
            } else if (data && data.thread_state && typeof data.thread_state === 'object') {
              _state = data.thread_state;
            }

            // Server may send a standalone pending intent
            var pi = null;
            if (data && typeof data.pending_intent === 'string') {
              pi = data.pending_intent.trim();
            } else if (data && typeof data.pendingIntent === 'string') {
              pi = data.pendingIntent.trim();
            } else if (data && data.thread_state_update && typeof data.thread_state_update.pending_intent === 'string') {
              pi = data.thread_state_update.pending_intent.trim();
            } else if (data && data.thread_state && typeof data.thread_state.pending_intent === 'string') {
              pi = data.thread_state.pending_intent.trim();
            }

            // Normalize: store if non-empty; clear if explicitly empty string
            if (pi !== null) {
              if (pi) {
                _state.pending_intent = pi;
                _state.pendingIntent = pi; // keep a mirror for older code
              } else {
                try { delete _state.pending_intent; } catch (e) {}
                try { delete _state.pendingIntent; } catch (e) {}
              }
            }

            saveThreadState(_state);
          } catch (e) {
            // ignore
          }

          var msg = '';
          if (data && typeof data.answer === 'string' && data.answer.trim() !== '') {
            msg = data.answer;
          } else if (data && typeof data.text === 'string' && data.text.trim() !== '') {
            msg = data.text;
          } else if (data && typeof data.message === 'string' && data.message.trim() !== '') {
            msg = data.message;
          } else {
            msg = 'Clarity responded, but returned an empty/unknown payload.';
          }

          push('assistant', msg, {
            confidence: (typeof data.confidence === 'number') ? data.confidence : null,
            citations: Array.isArray(data.citations) ? data.citations : [],
            is_guess: data.is_guess === true
          });

        } catch (err) {
          push('assistant', 'Clarity error: ' + (err && err.message ? err.message : String(err)));
        } finally {
          inputEl.disabled = false;
          inputEl.focus();
        }
      });
    });
  </script>

  <!-- Flatpickr date picker JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // Global Flatpickr init.
    document.addEventListener('DOMContentLoaded', function () {
      if (!window.flatpickr) return;

      // Date fields (MM/DD/YYYY system-wide)
      var dateInputs = document.querySelectorAll(
        'input.js-date, input[data-flatpickr="1"], input.js-flatpickr-date'
      );

      dateInputs.forEach(function (el) {
        if (el._flatpickr) return;

        window.flatpickr(el, {
          allowInput: true,
          dateFormat: 'm/d/Y'
        });
      });

      // Time fields (12-hour with AM/PM)
      var timeInputs = document.querySelectorAll('input.js-flatpickr-time');

      timeInputs.forEach(function (el) {
        if (el._flatpickr) return;

        window.flatpickr(el, {
          enableTime: true,
          noCalendar: true,
          allowInput: true,
          dateFormat: 'h:i K',
          time_24hr: false
        });
      });
    });
  </script>

  <!-- Simple reusable table search helper -->

  <script>
    /**
     * Attach simple text filter to a table.
     * Hides <tbody><tr> rows whose text doesn't include the search value.
     */
    function attachTableSearch(inputId, tableId) {
      var input = document.getElementById(inputId);
      var table = document.getElementById(tableId);
      if (!input || !table) {
        return;
      }

      input.addEventListener('input', function () {
        var value = (input.value || '').toLowerCase().trim();
        var rows = table.querySelectorAll('tbody tr');

        rows.forEach(function (row) {
          var text = (row.textContent || '').toLowerCase();
          row.style.display = text.indexOf(value) !== -1 ? '' : 'none';
        });
      });
    }
  </script>

  <script>
    // Global textarea auto-grow (min 2 rows, max 10 rows).
    // Applies to all <textarea> by default.
    // Opt-out with: data-autogrow="0" or class "js-no-autogrow".
    // Per-field overrides:
    //   data-autogrow-min="2" data-autogrow-max="10"
    (function () {
      function clamp(n, lo, hi) {
        return Math.max(lo, Math.min(hi, n));
      }

      function parseIntSafe(v, fallback) {
        var n = parseInt(v, 10);
        return isNaN(n) ? fallback : n;
      }

      function getLineHeightPx(el) {
        try {
          var style = window.getComputedStyle(el);
          var lh = parseFloat(style.lineHeight);
          if (lh && !isNaN(lh)) return lh;
          var fs = parseFloat(style.fontSize) || 14;
          return fs * 1.35;
        } catch (e) {
          return 18;
        }
      }

      function shouldAutoGrow(el) {
        if (!el || el.tagName !== 'TEXTAREA') return false;
        if (el.classList && el.classList.contains('js-no-autogrow')) return false;
        var flag = el.getAttribute('data-autogrow');
        if (flag === '0' || flag === 'false' || flag === 'off') return false;
        return true;
      }

      function autoGrowTextarea(el) {
        if (!shouldAutoGrow(el)) return;

        var minRows = parseIntSafe(el.getAttribute('data-autogrow-min'), 2);
        var maxRows = parseIntSafe(el.getAttribute('data-autogrow-max'), 10);
        minRows = clamp(minRows, 1, 50);
        maxRows = clamp(maxRows, minRows, 200);

        var lineHeight = getLineHeightPx(el);

        // Reset to min rows so scrollHeight reflects full content.
        el.rows = minRows;

        // Compute rows needed from height.
        var rowsNeeded = Math.ceil((el.scrollHeight || 0) / lineHeight);
        el.rows = clamp(rowsNeeded, minRows, maxRows);
      }

      function wireTextarea(el) {
        if (!shouldAutoGrow(el)) return;
        if (el.dataset && el.dataset.autogrowWired === '1') return;

        // Initial sizing (for saved content after reload)
        autoGrowTextarea(el);

        // Resize while typing
        el.addEventListener('input', function () {
          autoGrowTextarea(el);
        });

        if (el.dataset) el.dataset.autogrowWired = '1';
      }

      function initAutoGrowTextareas() {
        var areas = document.querySelectorAll('textarea');
        if (!areas || !areas.length) return;
        areas.forEach(function (ta) {
          wireTextarea(ta);
        });
      }

      document.addEventListener('DOMContentLoaded', initAutoGrowTextareas);

      // Expose for pages that dynamically add textareas.
      window.impactInitAutoGrowTextareas = initAutoGrowTextareas;
      window.impactAutoGrowTextarea = autoGrowTextarea;
    })();
  </script>

  <script>
    // Simple dark-mode toggle with localStorage persistence.
    document.addEventListener('DOMContentLoaded', function () {
      var root = document.documentElement;
      var toggle = document.getElementById('themeToggle');
      if (!toggle) {
        return;
      }

      var saved = null;
      try {
        saved = window.localStorage.getItem('impact_theme');
      } catch (e) {
        saved = null;
      }

      function applyTheme(theme) {
        if (theme === 'dark') {
          root.classList.add('dark-mode');
          toggle.textContent = 'â˜€';
        } else {
          root.classList.remove('dark-mode');
          toggle.textContent = 'ðŸŒ“';
        }
      }

      // Initialize from saved preference (default light).
      if (saved === 'dark') {
        applyTheme('dark');
      } else {
        applyTheme('light');
      }

      toggle.addEventListener('click', function () {
        var isDark = root.classList.contains('dark-mode');
        var next = isDark ? 'light' : 'dark';
        applyTheme(next);
        try {
          window.localStorage.setItem('impact_theme', next);
        } catch (e) {
          // Ignore storage errors
        }
      });
    });
  </script>
  <script>
    // Auto-format date and phone inputs and auto-advance when complete.
    document.addEventListener('DOMContentLoaded', function () {
      function focusNextField(input) {
        if (!input || !input.form) return;
        var elements = Array.prototype.filter.call(input.form.elements, function (el) {
          if (!el) return false;
          if (el.disabled) return false;
          if (el.type === 'hidden') return false;
          if (typeof el.offsetParent === 'undefined') return true;
          return el.offsetParent !== null;
        });
        var index = elements.indexOf(input);
        if (index >= 0 && index + 1 < elements.length) {
          elements[index + 1].focus();
        }
      }

      function setupAutoDate(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          var digits = (input.value || '').replace(/\D/g, '').slice(0, 8);
          var mm = '';
          var dd = '';
          var yyyy = '';

          if (digits.length >= 2) {
            mm = digits.slice(0, 2);
            if (digits.length >= 4) {
              dd = digits.slice(2, 4);
              if (digits.length > 4) {
                yyyy = digits.slice(4);
              }
            } else if (digits.length > 2) {
              dd = digits.slice(2);
            }
          } else {
            mm = digits;
          }

          var parts = [];
          if (mm) parts.push(mm);
          if (dd) parts.push(dd);
          if (yyyy) parts.push(yyyy);
          input.value = parts.join('/');

          if (digits.length === 8) {
            focusNextField(input);
          }
        });
      }

      function setupAutoPhone(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          var digits = (input.value || '').replace(/\D/g, '').slice(0, 10);
          var formatted = '';

          if (digits.length > 0) {
            formatted = '(' + digits.slice(0, Math.min(3, digits.length));
          }
          if (digits.length >= 4) {
            formatted += ') ' + digits.slice(3, Math.min(6, digits.length));
          } else if (digits.length > 3) {
            formatted += ') ' + digits.slice(3);
          }
          if (digits.length >= 7) {
            formatted += '-' + digits.slice(6);
          }

          input.value = formatted;

          if (digits.length === 10) {
            focusNextField(input);
          }
        });
        input.addEventListener('keypress', function (evt) {
          var ch = evt.key;
          if (!ch) return;
          // Allow control keys (Backspace, Arrow keys, etc.)
          if (ch.length > 1) return;
          if (!/[0-9]/.test(ch)) {
            evt.preventDefault();
          }
        });
      }

      var dateInputs = document.querySelectorAll('input[data-auto-date="1"], input.js-date-autofmt');

      // Skip fields that are using Flatpickr (js-date or data-flatpickr)
      dateInputs = Array.prototype.filter.call(dateInputs, function (el) {
        if (!el) return false;
        if (el.classList && el.classList.contains('js-date')) return false;
        if (el.getAttribute && el.getAttribute('data-flatpickr') === '1') return false;
        return true;
      });
      Array.prototype.forEach.call(dateInputs, function (input) {
        setupAutoDate(input);
      });

      var phoneInputs = document.querySelectorAll('input[type="tel"], input[data-auto-phone="1"], input.js-phone-autofmt, input.phone-input, input.js-phone, input.js-fax');
      Array.prototype.forEach.call(phoneInputs, function (input) {
        // Avoid attaching handlers multiple times if this script runs more than once
        // Skip extension fields (we don't auto-format extensions)
        var nm = (input.getAttribute('name') || '').toLowerCase();
        var id = (input.getAttribute('id') || '').toLowerCase();
        if (nm.includes('ext') || id.includes('ext') || nm.includes('phone_ext') || id.includes('phone_ext')) {
          return;
        }
        if (input.dataset && input.dataset.phoneWired === '1') {
          return;
        }
        setupAutoPhone(input);
        // Tag for later validation hooks (phone vs fax)
        if (input.classList && input.classList.contains('js-fax')) {
          input.dataset.maskType = 'fax';
        } else {
          input.dataset.maskType = 'phone';
        }
        if (input.dataset) {
          input.dataset.phoneWired = '1';
        }
      });
    });
  </script>

  <script>
    // Preserve scroll position per page using sessionStorage.
    (function () {
      try {
        var pathKey = 'scrollPos:' + window.location.pathname;

        function restoreScroll() {
          try {
            if (!window.sessionStorage) return;

            // Only restore scroll on browser back/forward navigation
            var navEntries = (window.performance && performance.getEntriesByType)
              ? performance.getEntriesByType('navigation')
              : [];

            var isBackForward = false;
            if (navEntries && navEntries.length > 0) {
              isBackForward = navEntries[0].type === 'back_forward';
            }

            if (!isBackForward) {
              return; // Normal navigation: do NOT restore scroll
            }

            var saved = window.sessionStorage.getItem(pathKey);
            if (saved !== null) {
              var y = parseInt(saved, 10);
              if (!isNaN(y)) {
                window.scrollTo(0, y);
              }
            }
          } catch (e) {
            // Ignore storage errors
          }
        }

        function saveScroll() {
          try {
            if (!window.sessionStorage) return;
            var y = window.scrollY || window.pageYOffset || 0;
            window.sessionStorage.setItem(pathKey, String(y));
          } catch (e) {
            // Ignore storage errors
          }
        }

        document.addEventListener('DOMContentLoaded', restoreScroll);
        window.addEventListener('scroll', saveScroll);
        window.addEventListener('beforeunload', saveScroll);
      } catch (e) {
        if (window.console && console.warn) {
          console.warn('Scroll persistence failed:', e);
        }
      }
    })();
  </script>

  <script>
  // Flash alert behavior:
  // - Persistent until first click/keypress: validation/errors (danger/warning)
  // - Floating persistent: explicit saves/deletes (success containing keywords)
  // - Auto-dismiss: everything else
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var alerts = document.querySelectorAll('.js-auto-dismiss');

      function normalizeText(el) {
        try {
          var msgEl = el ? el.querySelector('.js-flash-msg') : null;
          var raw = msgEl ? (msgEl.textContent || '') : (el.textContent || '');
          return String(raw || '').toLowerCase().trim();
        } catch (e) {
          return '';
        }
      }

      function textIncludesAny(t, arr) {
        if (!t) return false;
        t = String(t).toLowerCase();
        for (var i = 0; i < arr.length; i++) {
          if (t.indexOf(arr[i]) !== -1) return true;
        }
        return false;
      }

      function bsClose(el) {
        try {
          if (window.bootstrap && window.bootstrap.Alert) {
            var inst = window.bootstrap.Alert.getOrCreateInstance(el);
            inst.close();
          } else {
            el.remove();
          }
        } catch (e) {
          try { el.remove(); } catch (e2) {}
        }
      }

      function wirePersistent(el) {
        function dismissOnce() {
          bsClose(el);
          document.removeEventListener('click', dismissOnce, true);
          document.removeEventListener('keydown', dismissOnce, true);
          document.removeEventListener('touchstart', dismissOnce, true);
        }

        // Clicking the alert itself dismisses immediately
        el.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          dismissOnce();
        });

        document.addEventListener('click', dismissOnce, true);
        document.addEventListener('touchstart', dismissOnce, true);
        document.addEventListener('keydown', dismissOnce, true);
      }

      function wireAuto(el, ms) {
        // Click-to-dismiss
        el.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          bsClose(el);
        });

        window.setTimeout(function () {
          bsClose(el);
        }, ms);
      }

      // Optional: highlight a specific field if the message includes a token like: [field=phone]
      alerts.forEach(function (alertEl) {
        try {
          var msgEl = alertEl.querySelector('.js-flash-msg');
          if (!msgEl) return;

          var raw = msgEl.textContent || '';
          var m = raw.match(/\[field=([^\]]+)\]\s*/i);
          if (!m) return;

          var fieldName = (m[1] || '').trim();
          if (!fieldName) return;

          // Remove token from displayed message
          msgEl.textContent = raw.replace(m[0], '');

          var target = document.querySelector('[name="' + CSS.escape(fieldName) + '"]') ||
                       document.getElementById(fieldName);

          if (target) {
            target.classList.add('is-invalid');
            target.classList.add('flash-field-highlight');
            window.setTimeout(function () {
              target.classList.remove('flash-field-highlight');
            }, 2500);
          }
        } catch (e) {
          // ignore
        }
      });

      // Promote ONLY "save/delete" success flashes into the floating alert.
      // Everything else stays in the normal flash stack and auto-dismisses.
      try {
        var successAlerts = document.querySelectorAll('.flash-container .alert-success');
        if (successAlerts && successAlerts.length && window.showFloatingAlert) {
          var keepKeywords = ['saved', 'changes saved', 'deleted', 'removed'];
          var promoted = [];

          successAlerts.forEach(function (el) {
            var txt = normalizeText(el);
            if (textIncludesAny(txt, keepKeywords)) {
              // Keep original casing in floating alert
              var msgEl = el.querySelector('.js-flash-msg');
              var raw = msgEl ? (msgEl.textContent || '').trim() : (el.textContent || '').trim();
              if (raw) promoted.push(raw);

              // Remove from regular flashes to avoid duplicates
              bsClose(el);
            }
          });

          if (promoted.length) {
            window.showFloatingAlert(promoted.join('\n'), 'success', { persistent: true });
          }
        }
      } catch (e) {
        // ignore
      }

      // Recompute after promotions
      alerts = document.querySelectorAll('.js-auto-dismiss');
      if (!alerts || !alerts.length) return;

      alerts.forEach(function (el) {
        var isDanger = el.classList.contains('alert-danger');
        var isWarn = el.classList.contains('alert-warning');
        var isSuccess = el.classList.contains('alert-success');

        // Validation/errors: persistent until interaction
        if (isDanger || isWarn) {
          wirePersistent(el);
          return;
        }

        // Everything else auto-dismiss
        if (isSuccess) {
          wireAuto(el, 2500);
          return;
        }

        if (el.classList.contains('alert-info') || el.classList.contains('alert-primary') || el.classList.contains('alert-secondary')) {
          wireAuto(el, 3000);
          return;
        }

        wireAuto(el, 3000);
      });

    } catch (e) {
      // ignore
    }
  });
  </script>
  {% endblock %}
</body>