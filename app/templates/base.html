<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Impact CMS{% endblock %}</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  >

  <!-- App stylesheet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Centered flash messages (fixed overlay) */
    .flash-container {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1080;
      width: min(720px, calc(100vw - 2rem));
      pointer-events: none; /* allow clicks through except the alerts */
    }

    .flash-container .alert {
      pointer-events: auto;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25);
    }

    /* Stronger error emphasis */
    .flash-container .alert-danger {
      border-width: 2px;
    }

    /* Temporary highlight for invalid fields when flash includes [field=...] */
    .flash-field-highlight {
      outline: 3px solid rgba(220, 53, 69, 0.55); /* bootstrap danger-ish */
      outline-offset: 2px;
      animation: flashOutline 900ms ease-in-out 0s 2;
    }

    @keyframes flashOutline {
      0%   { outline-color: rgba(220, 53, 69, 0.15); }
      50%  { outline-color: rgba(220, 53, 69, 0.75); }
      100% { outline-color: rgba(220, 53, 69, 0.15); }
    }
  </style>
</head>
<body class="bg-light">

  <!-- Top navbar -->
  <header>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <!-- Brand / Logo -->
        {% set brand_name_raw = settings.business_name if settings and settings.business_name else 'Impact Medical CMS' %}
        {#
          Defensive: if Settings.business_name accidentally contains pasted code (newlines, decorators, imports),
          donâ€™t render it across every page.
        #}
        {% set brand_name_clean = (brand_name_raw or '') | replace('\r', ' ') | replace('\n', ' ') | trim %}
        {% if ('from flask import' in brand_name_clean) or ('@app.route' in brand_name_clean) or ('def ' in brand_name_clean and 'route' in brand_name_clean) %}
          {% set brand_name_clean = 'Impact Medical CMS' %}
        {% endif %}
        {% if brand_name_clean|length > 80 %}
          {% set brand_name_clean = brand_name_clean[:77] ~ 'â€¦' %}
        {% endif %}
        <a class="navbar-brand d-flex flex-column align-items-center" href="{{ url_for('main.claims_list') }}">
          <span style="line-height: 1.1;">{{ brand_name_clean }}</span>
        </a>

        <!-- Mobile nav toggle -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
                aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Nav links -->
        <div class="collapse navbar-collapse d-flex align-items-center" id="mainNavbar">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'claims' %}active{% endif %}"
                 href="{{ url_for('main.claims_list') }}">Claims</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'billing' %}active{% endif %}"
                 href="{{ url_for('main.billing_list') }}">Billing</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'carriers' %}active{% endif %}"
                 href="{{ url_for('main.carriers_list') }}">Carriers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'employers' %}active{% endif %}"
                 href="{{ url_for('main.employers_list') }}">Employers</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'providers' %}active{% endif %}"
                 href="{{ url_for('main.providers_list') }}">Providers</a>
            </li>

            <li class="nav-item">
              <a class="nav-link {% if active_page == 'forms' %}active{% endif %}"
                 href="{{ url_for('main.forms_index') }}">Forms</a>
            </li>

            <li class="nav-item">
              <a class="nav-link {% if active_page == 'reporting' %}active{% endif %}"
                 href="{{ url_for('main.reporting_dashboard') }}">Reporting</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'analysis' %}active{% endif %}"
                 href="{{ url_for('main.analysis_view') }}">Analysis</a>
            </li>
            <li class="nav-item">
              <a class="nav-link {% if active_page == 'settings' %}active{% endif %}"
                 href="{{ url_for('main.settings_view') }}">Settings</a>
            </li>
          </ul>

          <!-- Right side: theme toggle + version -->
          <div class="d-flex align-items-center gap-2">
            <button id="themeToggle"
                    type="button"
                    class="btn btn-sm btn-outline-light"
                    aria-label="Toggle dark mode">
              ðŸŒ“
            </button>
            <span class="navbar-text text-secondary small">
              v{{ config.APP_VERSION }}
            </span>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <!-- Page content -->
  <main class="container-fluid py-3">

    {# Flash messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            {% set bs_category = 'info' %}
            {% if category in ['success','info','warning','danger','primary','secondary','light','dark'] %}
              {% set bs_category = category %}
            {% elif category in ['error'] %}
              {% set bs_category = 'danger' %}
            {% endif %}
            <div class="alert alert-{{ bs_category }} alert-dismissible fade show mb-2 js-auto-dismiss" role="alert">
              <span class="js-flash-msg">{{ message }}</span>
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% block content %}{% endblock %}
  </main>

  {% block scripts %}
  <!-- Bootstrap 5 JS bundle -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"
  ></script>

  <!-- Simple reusable table search helper -->
  <script>
    /**
     * Attach simple text filter to a table.
     * Hides <tbody><tr> rows whose text doesn't include the search value.
     */
    function attachTableSearch(inputId, tableId) {
      var input = document.getElementById(inputId);
      var table = document.getElementById(tableId);
      if (!input || !table) {
        return;
      }

      input.addEventListener('input', function () {
        var value = (input.value || '').toLowerCase().trim();
        var rows = table.querySelectorAll('tbody tr');

        rows.forEach(function (row) {
          var text = (row.textContent || '').toLowerCase();
          row.style.display = text.indexOf(value) !== -1 ? '' : 'none';
        });
      });
    }
  </script>

  <script>
    // Simple dark-mode toggle with localStorage persistence.
    document.addEventListener('DOMContentLoaded', function () {
      var root = document.documentElement;
      var toggle = document.getElementById('themeToggle');
      if (!toggle) {
        return;
      }

      var saved = null;
      try {
        saved = window.localStorage.getItem('impact_theme');
      } catch (e) {
        saved = null;
      }

      function applyTheme(theme) {
        if (theme === 'dark') {
          root.classList.add('dark-mode');
          toggle.textContent = 'â˜€';
        } else {
          root.classList.remove('dark-mode');
          toggle.textContent = 'ðŸŒ“';
        }
      }

      // Initialize from saved preference (default light).
      if (saved === 'dark') {
        applyTheme('dark');
      } else {
        applyTheme('light');
      }

      toggle.addEventListener('click', function () {
        var isDark = root.classList.contains('dark-mode');
        var next = isDark ? 'light' : 'dark';
        applyTheme(next);
        try {
          window.localStorage.setItem('impact_theme', next);
        } catch (e) {
          // Ignore storage errors
        }
      });
    });
  </script>
  <script>
    // Auto-format date and phone inputs and auto-advance when complete.
    document.addEventListener('DOMContentLoaded', function () {
      function focusNextField(input) {
        if (!input || !input.form) return;
        var elements = Array.prototype.filter.call(input.form.elements, function (el) {
          if (!el) return false;
          if (el.disabled) return false;
          if (el.type === 'hidden') return false;
          if (typeof el.offsetParent === 'undefined') return true;
          return el.offsetParent !== null;
        });
        var index = elements.indexOf(input);
        if (index >= 0 && index + 1 < elements.length) {
          elements[index + 1].focus();
        }
      }

      function setupAutoDate(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          var digits = (input.value || '').replace(/\D/g, '').slice(0, 8);
          var mm = '';
          var dd = '';
          var yyyy = '';

          if (digits.length >= 2) {
            mm = digits.slice(0, 2);
            if (digits.length >= 4) {
              dd = digits.slice(2, 4);
              if (digits.length > 4) {
                yyyy = digits.slice(4);
              }
            } else if (digits.length > 2) {
              dd = digits.slice(2);
            }
          } else {
            mm = digits;
          }

          var parts = [];
          if (mm) parts.push(mm);
          if (dd) parts.push(dd);
          if (yyyy) parts.push(yyyy);
          input.value = parts.join('/');

          if (digits.length === 8) {
            focusNextField(input);
          }
        });
      }

      function setupAutoPhone(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          var digits = (input.value || '').replace(/\D/g, '').slice(0, 10);
          var formatted = '';

          if (digits.length > 0) {
            formatted = '(' + digits.slice(0, Math.min(3, digits.length));
          }
          if (digits.length >= 4) {
            formatted += ') ' + digits.slice(3, Math.min(6, digits.length));
          } else if (digits.length > 3) {
            formatted += ') ' + digits.slice(3);
          }
          if (digits.length >= 7) {
            formatted += '-' + digits.slice(6);
          }

          input.value = formatted;

          if (digits.length === 10) {
            focusNextField(input);
          }
        });
        input.addEventListener('keypress', function (evt) {
          var ch = evt.key;
          if (!ch) return;
          // Allow control keys (Backspace, Arrow keys, etc.)
          if (ch.length > 1) return;
          if (!/[0-9]/.test(ch)) {
            evt.preventDefault();
          }
        });
      }

      var dateInputs = document.querySelectorAll('input[data-auto-date="1"], input.js-date-autofmt');
      Array.prototype.forEach.call(dateInputs, function (input) {
        setupAutoDate(input);
      });

      var phoneInputs = document.querySelectorAll('input[type="tel"], input[data-auto-phone="1"], input.js-phone-autofmt, input.phone-input, input.js-phone, input.js-fax');
      Array.prototype.forEach.call(phoneInputs, function (input) {
        // Avoid attaching handlers multiple times if this script runs more than once
        // Skip extension fields (we don't auto-format extensions)
        var nm = (input.getAttribute('name') || '').toLowerCase();
        var id = (input.getAttribute('id') || '').toLowerCase();
        if (nm.includes('ext') || id.includes('ext') || nm.includes('phone_ext') || id.includes('phone_ext')) {
          return;
        }
        if (input.dataset && input.dataset.phoneWired === '1') {
          return;
        }
        setupAutoPhone(input);
        // Tag for later validation hooks (phone vs fax)
        if (input.classList && input.classList.contains('js-fax')) {
          input.dataset.maskType = 'fax';
        } else {
          input.dataset.maskType = 'phone';
        }
        if (input.dataset) {
          input.dataset.phoneWired = '1';
        }
      });
    });
  </script>

  <script>
    // Preserve scroll position per page using sessionStorage.
    (function () {
      try {
        var pathKey = 'scrollPos:' + window.location.pathname;

        function restoreScroll() {
          try {
            if (!window.sessionStorage) return;
            var saved = window.sessionStorage.getItem(pathKey);
            if (saved !== null) {
              var y = parseInt(saved, 10);
              if (!isNaN(y)) {
                window.scrollTo(0, y);
              }
            }
          } catch (e) {
            // Ignore storage errors
          }
        }

        function saveScroll() {
          try {
            if (!window.sessionStorage) return;
            var y = window.scrollY || window.pageYOffset || 0;
            window.sessionStorage.setItem(pathKey, String(y));
          } catch (e) {
            // Ignore storage errors
          }
        }

        document.addEventListener('DOMContentLoaded', restoreScroll);
        window.addEventListener('scroll', saveScroll);
        window.addEventListener('beforeunload', saveScroll);
      } catch (e) {
        if (window.console && console.warn) {
          console.warn('Scroll persistence failed:', e);
        }
      }
    })();
  </script>

  <script>
  // Dismiss flash messages on first click anywhere or any keypress.
  document.addEventListener('DOMContentLoaded', function () {
    try {
      var alerts = document.querySelectorAll('.js-auto-dismiss');

      // Optional: highlight a specific field if the message includes a token like: [field=phone]
      alerts.forEach(function (alertEl) {
        try {
          var msgEl = alertEl.querySelector('.js-flash-msg');
          if (!msgEl) return;

          var raw = msgEl.textContent || '';
          var m = raw.match(/\[field=([^\]]+)\]\s*/i);
          if (!m) return;

          var fieldName = (m[1] || '').trim();
          if (!fieldName) return;

          // Remove token from displayed message
          msgEl.textContent = raw.replace(m[0], '');

          // Try to find input by name or id
          var target = document.querySelector('[name="' + CSS.escape(fieldName) + '"]') ||
                       document.getElementById(fieldName);

          if (target) {
            target.classList.add('is-invalid');
            target.classList.add('flash-field-highlight');
            // Remove the extra highlight after a moment (keep is-invalid)
            window.setTimeout(function () {
              target.classList.remove('flash-field-highlight');
            }, 2500);
          }
        } catch (e) {
          // ignore
        }
      });

      if (!alerts || !alerts.length) return;

      function dismissAll() {
        try {
          alerts.forEach(function (el) {
            try {
              if (window.bootstrap && window.bootstrap.Alert) {
                var inst = window.bootstrap.Alert.getOrCreateInstance(el);
                inst.close();
              } else {
                el.classList.remove('show');
                el.classList.add('hide');
                el.remove();
              }
            } catch (e) {
              // ignore
            }
          });
        } finally {
          // Only dismiss once
          document.removeEventListener('click', dismissAll, true);
          document.removeEventListener('keydown', dismissAll, true);
        }
      }

      // Dismiss when user interacts anywhere (click or keystroke)
      document.addEventListener('click', dismissAll, true);
      document.addEventListener('keydown', dismissAll, true);

    } catch (e) {
      // ignore
    }
  });
  </script>
  {% endblock %}
</body>
</html>