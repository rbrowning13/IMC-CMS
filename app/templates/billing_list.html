{% extends "base.html" %}
{% block title %}Billing - Impact CMS{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Billing</h1>
    <div class="d-flex flex-wrap gap-2 mt-2 mt-sm-0">
      <input
        id="invoices-search"
        type="text"
        class="form-control form-control-sm"
        style="min-width: 220px;"
        placeholder="Search invoices..."
        aria-label="Search invoices"
      >
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header">
      <h2 class="h6 mb-0">All Invoices</h2>
    </div>
    <div class="card-body p-0">
      {% if invoices %}
        <div class="table-responsive">
          <table id="invoices-table" class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-sort-key="invoice_number"><span>Invoice #</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="claim"><span>Claim</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="carrier"><span>Carrier</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="status"><span>Status</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="invoice_date"><span>Invoice Date</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable text-end" data-sort-key="total"><span>Total</span> <span class="sort-indicator">↕</span></th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
                <tr>
                  <td>
                    <a href="{{ url_for('main.invoice_detail', invoice_id=invoice.id) }}">
                      {{ invoice.invoice_number }}
                    </a>
                  </td>
                  <td>
                    {% if invoice.claim %}
                      <a href="{{ url_for('main.claim_detail', claim_id=invoice.claim.id) }}">
                        {{ invoice.claim.claim_number }} · {{ invoice.claim.claimant_name }}
                      </a>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if invoice.claim and invoice.claim.carrier %}
                      {{ invoice.claim.carrier.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {{ invoice.status or "Draft" }}
                  </td>
                  <td>
                    {% if invoice.invoice_date %}
                      {{ invoice.invoice_date }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    {% if invoice.total_amount is not none %}
                      ${{ "%.2f"|format(invoice.total_amount) }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3">
          <p class="text-muted mb-0">No invoices have been created yet.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    attachTableSearch('invoices-search', 'invoices-table');

    const table = document.getElementById('invoices-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.forEach((row, idx) => row.dataset.originalIndex = idx);

    document.querySelectorAll('th.sortable').forEach(th => {
      th.style.cursor = 'pointer';

      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort-key');
        const indicator = th.querySelector('.sort-indicator');

        const isAsc = th.classList.contains('sorted-asc');
        const isDesc = th.classList.contains('sorted-desc');

        document.querySelectorAll('th.sortable').forEach(h => {
          h.classList.remove('sorted-asc', 'sorted-desc');
          const ind = h.querySelector('.sort-indicator');
          if (ind) ind.textContent = '↕';
        });

        let newState;
        if (!isAsc && !isDesc) newState = 'asc';
        else if (isAsc) newState = 'desc';
        else newState = 'none';

        if (newState === 'none') {
          const restored = rows.slice().sort((a,b) =>
            Number(a.dataset.originalIndex) - Number(b.dataset.originalIndex)
          );
          restored.forEach(r => tbody.appendChild(r));
          indicator.textContent = '↕';
          return;
        }

        th.classList.add(newState === 'asc' ? 'sorted-asc' : 'sorted-desc');
        indicator.textContent = newState === 'asc' ? '↑' : '↓';

        const sorted = rows.slice().sort((a,b) => {
          const cellA = getValue(a, key);
          const cellB = getValue(b, key);

          if (cellA < cellB) return newState === 'asc' ? -1 : 1;
          if (cellA > cellB) return newState === 'asc' ? 1 : -1;
          return 0;
        });

        sorted.forEach(r => tbody.appendChild(r));
      });
    });

    function getValue(row, key) {
      switch (key) {
        case 'invoice_number':
          return row.children[0].innerText.trim().toLowerCase();
        case 'claim':
          return row.children[1].innerText.trim().toLowerCase();
        case 'carrier':
          return row.children[2].innerText.trim().toLowerCase();
        case 'status':
          return row.children[3].innerText.trim().toLowerCase();
        case 'invoice_date':
          return row.children[4].innerText.trim().toLowerCase();
        case 'total':
          return row.children[5].innerText.trim().replace('$','').toLowerCase();
        default:
          return row.innerText.trim().toLowerCase();
      }
    }
  });
</script>
{% endblock %}