{% extends "base.html" %}
{% block title %}Billing - Impact CMS{% endblock %}
{% block content %}
{% set _endpoint = request.endpoint %}
{% set _bucket = bucket if bucket is defined and bucket else 'all' %}
{% set _summary = summary if summary is defined and summary else {} %}
{% set _rows = rows if rows is defined and rows else [] %}
{% set _math_map = invoice_math_by_id if invoice_math_by_id is defined and invoice_math_by_id else {} %}

<div class="container-fluid">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Billing</h1>
      <div class="text-muted small">Accounts receivable overview</div>
    </div>

    <div class="d-flex flex-wrap gap-2 mt-2 mt-sm-0">
      <input
        id="invoices-search"
        type="text"
        class="form-control form-control-sm"
        style="min-width: 220px;"
        placeholder="Search invoices..."
        aria-label="Search invoices"
      >
    </div>
  </div>

  {# A/R summary strip (reports) #}
  {% if _summary %}
    {# Canonical summary values from billing.py #}
    {% set _draft_count = summary.get('draft_count', 0) %}
    {% set _open_count = summary.get('open_count', 0) %}
    {% set _overdue_count = summary.get('overdue_count', 0) %}
    {% set _paid_count = summary.get('paid_count', 0) %}

    {% set _outstanding_total = summary.get('outstanding_total', 0) %}
    {% set _past_due_total = summary.get('past_due_total', 0) %}

    <div class="row g-2 mb-3">
      <div class="col-6 col-md-2">
        <div class="card shadow-sm">
          <div class="card-body py-2">
            <div class="small text-muted">Draft</div>
            <div class="fw-semibold">{{ _draft_count }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-2">
        <div class="card shadow-sm">
          <div class="card-body py-2">
            <div class="small text-muted">Open</div>
            <div class="fw-semibold">{{ _open_count }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-2">
        <div class="card shadow-sm">
          <div class="card-body py-2">
            <div class="small text-muted">Overdue</div>
            <div class="fw-semibold">{{ _overdue_count }}</div>
          </div>
        </div>
      </div>

      <div class="col-6 col-md-2">
        <div class="card shadow-sm">
          <div class="card-body py-2">
            <div class="small text-muted">Paid</div>
            <div class="fw-semibold">{{ _paid_count }}</div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-4">
        <div class="card shadow-sm">
          <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-baseline">
              <div>
                <div class="small text-muted">Outstanding Balance</div>
                <div class="fw-semibold">${{ "%.2f"|format(_outstanding_total or 0) }}</div>
              </div>
              <div class="text-end">
                <div class="small text-muted">Past Due Balance</div>
                <div class="fw-semibold">${{ "%.2f"|format(_past_due_total or 0) }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# Bucket tabs #}
  <div class="mb-2">
    <div class="btn-group" role="group" aria-label="Billing buckets">
      <a class="btn btn-sm btn-outline-secondary {% if _bucket == 'all' %}active{% endif %}" href="{{ url_for(_endpoint, bucket='all') }}">All</a>
      <a class="btn btn-sm btn-outline-secondary {% if _bucket == 'draft' %}active{% endif %}" href="{{ url_for(_endpoint, bucket='draft') }}">Draft</a>
      <a class="btn btn-sm btn-outline-secondary {% if _bucket == 'open' %}active{% endif %}" href="{{ url_for(_endpoint, bucket='open') }}">Open</a>
      <a class="btn btn-sm btn-outline-secondary {% if _bucket == 'overdue' %}active{% endif %}" href="{{ url_for(_endpoint, bucket='overdue') }}">Overdue</a>
      <a class="btn btn-sm btn-outline-secondary {% if _bucket == 'paid' %}active{% endif %}" href="{{ url_for(_endpoint, bucket='paid') }}">Paid</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h2 class="h6 mb-0">Invoices</h2>
      <span class="text-muted small">{{ _rows|length if _rows else (invoices|length if invoices is defined and invoices else 0) }} shown</span>
    </div>

    <div class="card-body p-0">

      {# Preferred path: A/R rows from billing.py #}
      {% if _rows %}
        <div class="table-responsive">
          <table id="invoices-table" class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-sort-key="invoice_number"><span>Invoice #</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="claim"><span>Claim</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="carrier"><span>Carrier</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="status"><span>Status</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="invoice_date"><span>Invoice Date</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="due_date"><span>Due</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable text-end" data-sort-key="total"><span>Total</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable text-end" data-sort-key="paid"><span>Paid</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable text-end" data-sort-key="balance"><span>Balance</span> <span class="sort-indicator">↕</span></th>
                <th><span>Actions</span></th>
              </tr>
            </thead>
            <tbody>
              {% for row in _rows %}
                {% set inv = row.invoice %}
                {% set _m = _math_map.get(inv.id) if _math_map else None %}
                <tr>
                  <td>
                    <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}">{{ row.invoice_number or inv.invoice_number }}</a>
                  </td>
                  <td>
                    {% if inv.claim %}
                      <a href="{{ url_for('main.claim_detail', claim_id=inv.claim.id) }}">{{ inv.claim.claim_number }} · {{ inv.claim.claimant_name }}</a>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if inv.claim and inv.claim.carrier %}
                      {{ inv.claim.carrier.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge text-bg-{% if row.bucket == 'paid' %}success{% elif row.bucket == 'overdue' %}danger{% elif row.bucket == 'open' %}warning{% elif row.bucket == 'draft' %}secondary{% else %}secondary{% endif %}">
                      {{ row.status_label or (inv.status or 'Draft') }}
                    </span>
                  </td>
                  <td>
                    {% if row.invoice_date %}{{ row.invoice_date }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                  <td>
                    {% if row.due_date %}{{ row.due_date }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                  <td class="text-end">
                    {% set _total = (_m['invoice_total'] if _m is not none and 'invoice_total' in _m else row.total) %}
                    {% if _total is not none %}${{ "%.2f"|format(_total) }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                  <td class="text-end">
                    {% set _paid = (_m['amount_paid'] if _m is not none and 'amount_paid' in _m else row.paid) %}
                    {% if _paid is not none %}${{ "%.2f"|format(_paid) }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                  <td class="text-end">
                    {% set _bal = (_m['balance_due'] if _m is not none and 'balance_due' in _m else row.balance) %}
                    {% if _bal is not none %}${{ "%.2f"|format(_bal) }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                  <td>
                    <div class="d-flex gap-2 flex-wrap">
                      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}">View</a>

                      {% set _bal_for_paid = (_m['balance_due'] if _m is not none and 'balance_due' in _m else row.balance) %}
                      {% set _is_paid = (row.bucket == 'paid') or ((_bal_for_paid is not none) and (_bal_for_paid <= 0)) %}
                      {% if _is_paid %}
                        <button type="button" class="btn btn-sm btn-secondary" disabled title="Invoice is already paid">Record payment</button>
                      {% else %}
                        <a
                          class="btn btn-sm btn-primary"
                          href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}"
                          title="View invoice and record payment"
                        >
                          Record payment
                        </a>
                      {% endif %}
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      {# Fallback: old invoices list (kept for safety) #}
      {% elif invoices is defined and invoices %}
        <div class="table-responsive">
          <table id="invoices-table" class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-sort-key="invoice_number"><span>Invoice #</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="claim"><span>Claim</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="carrier"><span>Carrier</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="status"><span>Status</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="invoice_date"><span>Invoice Date</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable text-end" data-sort-key="total"><span>Total</span> <span class="sort-indicator">↕</span></th>
              </tr>
            </thead>
            <tbody>
              {% for invoice in invoices %}
                {% set _m = _math_map.get(invoice.id) if _math_map else None %}
                <tr>
                  <td>
                    <a href="{{ url_for('main.invoice_detail', invoice_id=invoice.id) }}">{{ invoice.invoice_number }}</a>
                  </td>
                  <td>
                    {% if invoice.claim %}
                      <a href="{{ url_for('main.claim_detail', claim_id=invoice.claim.id) }}">{{ invoice.claim.claim_number }} · {{ invoice.claim.claimant_name }}</a>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if invoice.claim and invoice.claim.carrier %}
                      {{ invoice.claim.carrier.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                  <td>{{ invoice.status or "Draft" }}</td>
                  <td>
                    {% if invoice.invoice_date %}{{ invoice.invoice_date }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                  <td class="text-end">
                    {% set _total = (_m['invoice_total'] if _m is not none and 'invoice_total' in _m else invoice.total_amount) %}
                    {% if _total is not none %}${{ "%.2f"|format(_total) }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3">
          <p class="text-muted mb-0">No invoices found for this view.</p>
        </div>
      {% endif %}

    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    attachTableSearch('invoices-search', 'invoices-table');

    const table = document.getElementById('invoices-table');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    rows.forEach((row, idx) => row.dataset.originalIndex = idx);

    document.querySelectorAll('th.sortable').forEach(th => {
      th.style.cursor = 'pointer';

      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort-key');
        const indicator = th.querySelector('.sort-indicator');

        const isAsc = th.classList.contains('sorted-asc');
        const isDesc = th.classList.contains('sorted-desc');

        document.querySelectorAll('th.sortable').forEach(h => {
          h.classList.remove('sorted-asc', 'sorted-desc');
          const ind = h.querySelector('.sort-indicator');
          if (ind) ind.textContent = '↕';
        });

        let newState;
        if (!isAsc && !isDesc) newState = 'asc';
        else if (isAsc) newState = 'desc';
        else newState = 'none';

        if (newState === 'none') {
          const restored = rows.slice().sort((a,b) =>
            Number(a.dataset.originalIndex) - Number(b.dataset.originalIndex)
          );
          restored.forEach(r => tbody.appendChild(r));
          if (indicator) indicator.textContent = '↕';
          return;
        }

        th.classList.add(newState === 'asc' ? 'sorted-asc' : 'sorted-desc');
        if (indicator) indicator.textContent = newState === 'asc' ? '↑' : '↓';

        const sorted = rows.slice().sort((a,b) => {
          const cellA = getValue(a, key);
          const cellB = getValue(b, key);

          if (cellA < cellB) return newState === 'asc' ? -1 : 1;
          if (cellA > cellB) return newState === 'asc' ? 1 : -1;
          return 0;
        });

        sorted.forEach(r => tbody.appendChild(r));
      });
    });

    function getValue(row, key) {
      // NOTE: The A/R table has more columns than the legacy table.
      // We map by column index based on the current rendered header.
      const cols = row.children;
      const txt = (i) => (cols[i] ? cols[i].innerText.trim().toLowerCase() : '');

      switch (key) {
        case 'invoice_number': return txt(0);
        case 'claim': return txt(1);
        case 'carrier': return txt(2);
        case 'status': return txt(3);
        case 'invoice_date': return txt(4);
        case 'due_date': return txt(5);
        case 'total': return txt(6).replace('$','');
        case 'paid': return txt(7).replace('$','');
        case 'balance': return txt(8).replace('$','');
        default: return row.innerText.trim().toLowerCase();
      }
    }
  });
</script>
{% endblock %}