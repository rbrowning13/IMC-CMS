{% extends "base.html" %}

{# ---- Safe defaults so the page can render while analysis.py is being built ---- #}
{% set settings = settings if settings is defined else None %}
{% set active_claims_count = active_claims_count if active_claims_count is defined else 0 %}
{% set total_claims = total_claims if total_claims is defined else 0 %}
{% set avg_open_claim_age_days = avg_open_claim_age_days if avg_open_claim_age_days is defined else none %}
{% set stale_claims_count = stale_claims_count if stale_claims_count is defined else 0 %}
{% set uninvoiced_billables = uninvoiced_billables if uninvoiced_billables is defined else 0 %}
{% set hours_last_30_days = hours_last_30_days if hours_last_30_days is defined else 0 %}
{% set hours_target_min_30 = hours_target_min_30 if hours_target_min_30 is defined else none %}
{% set hours_target_max_30 = hours_target_max_30 if hours_target_max_30 is defined else none %}
{% set total_outstanding_ar = total_outstanding_ar if total_outstanding_ar is defined else 0 %}
{% set open_invoices = open_invoices if open_invoices is defined else 0 %}
{% set total_invoices = total_invoices if total_invoices is defined else 0 %}
{% set ar_aging = ar_aging if ar_aging is defined else {'current': 0, 'days_31_60': 0, 'days_61_90': 0, 'over_90': 0} %}
{% set ar_by_carrier = ar_by_carrier if ar_by_carrier is defined else [] %}

{% block content %}
<div class="container-fluid mt-4">
  <h2 class="mb-4">Analysis Dashboard</h2>

  <!-- Summary Cards -->
  {% if settings and settings.dormant_claim_days %}
    {% set dormant_days = settings.dormant_claim_days %}
  {% else %}
    {% set dormant_days = 60 %}
  {% endif %}
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center">
        <div class="card-body">
          <div class="stat-label">Active Claims</div>
          <div class="stat-value">{{ active_claims_count }}</div>
          <div class="small text-muted mt-2">
            Total claims: {{ total_claims }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center">
        <div class="card-body">
          <div class="stat-label">Avg Open Claim Age</div>
          <div class="stat-value">
            {% if avg_open_claim_age_days is not none %}
              {{ avg_open_claim_age_days|round(1) }} days
            {% else %}
              &mdash;
            {% endif %}
          </div>
          <div class="small text-muted mt-2">
            Based on open claims only
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center">
        <div class="card-body">
          <div class="stat-label">Inactive Claims (>{{ dormant_days }} days)</div>
          <div class="stat-value">{{ stale_claims_count }}</div>
          <div class="small text-muted mt-2">&nbsp;</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center">
        <div class="card-body">
          <div class="stat-label">Uninvoiced Billables</div>
          <div class="stat-value">${{ "%.2f"|format(uninvoiced_billables or 0) }}</div>
          <div class="small text-muted mt-2">&nbsp;</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Workload Summary -->
  <div class="row mb-4">
    <div class="col-md-6 mb-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="stat-label mb-2">Hours Worked (Last 30 Days)</div>
          <div class="stat-value mb-2">
            {{ "%.1f"|format(hours_last_30_days or 0) }}
          </div>
          {% if hours_target_min_30 and hours_target_max_30 %}
            {% if hours_last_30_days < hours_target_min_30 %}
              {% set hours_status = "Below target" %}
            {% elif hours_last_30_days > hours_target_max_30 %}
              {% set hours_status = "Above target" %}
            {% else %}
              {% set hours_status = "Within target" %}
            {% endif %}

            <div class="mb-1">
              {% if hours_status == "Below target" %}
                <span class="badge bg-danger">Below target</span>
              {% elif hours_status == "Above target" %}
                <span class="badge bg-warning text-dark">Above target</span>
              {% else %}
                <span class="badge bg-success">Within target</span>
              {% endif %}
            </div>
            <div class="small text-muted">
              Target range for 30 days:
              {{ "%.1f"|format(hours_target_min_30) }}&ndash;{{ "%.1f"|format(hours_target_max_30) }} hrs
            </div>
          {% else %}
            <div class="small text-muted">
              No weekly hour targets configured in Settings.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Billing Summary -->
    <div class="col-md-6 mb-3">
      <div class="card stat-card h-100">
        <div class="card-body">
          <div class="stat-label mb-2">Outstanding Accounts Receivable</div>
          <div class="stat-value mb-2">
            ${{ "%.2f"|format(total_outstanding_ar or 0) }}
          </div>
          <div class="small text-muted">
            Open invoices: {{ open_invoices }}<br>
            Total invoices: {{ total_invoices }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Aging Summary -->
  <h4 class="mt-4 mb-3">Aging Summary</h4>
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center h-100">
        <div class="card-body">
          <div class="stat-label">Current (0-30 days)</div>
          <div class="stat-value">${{ "%.2f"|format(ar_aging['current'] or 0) }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center h-100">
        <div class="card-body">
          <div class="stat-label">31-60 days</div>
          <div class="stat-value">${{ "%.2f"|format(ar_aging['days_31_60'] or 0) }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center h-100">
        <div class="card-body">
          <div class="stat-label">61-90 days</div>
          <div class="stat-value">${{ "%.2f"|format(ar_aging['days_61_90'] or 0) }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 mb-3">
      <div class="card stat-card text-center h-100">
        <div class="card-body">
          <div class="stat-label">Over 90 days</div>
          <div class="stat-value">${{ "%.2f"|format(ar_aging['over_90'] or 0) }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receivables by Carrier Table -->
  <h4 class="mt-4 mb-3">Outstanding A/R by Carrier</h4>
  <div class="table-responsive">
    <table class="table table-sm table-bordered">
      <thead>
        <tr>
          <th>Carrier</th>
          <th class="text-end">Total Outstanding</th>
        </tr>
      </thead>
      <tbody>
        {% for row in ar_by_carrier %}
          <tr>
            <td>{{ row.carrier_name }}</td>
            <td class="text-end">
              ${{ "%.2f"|format(row.total_outstanding or 0) }}
            </td>
          </tr>
        {% else %}
          <tr>
            <td colspan="2" class="text-center text-muted">No open invoices.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
