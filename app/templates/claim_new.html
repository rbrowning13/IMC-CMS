{% extends "base.html" %}
{% block title %}New Claim{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">New Claim</h1>
    <a href="{{ url_for('main.claims_list') }}" class="btn btn-sm btn-outline-secondary">
      Cancel
    </a>
  </div>

  {% if error %}
    <div class="alert alert-danger alert-sm py-2 mb-3">
      {{ error }}
    </div>
  {% endif %}

  <div class="card">
    <div class="card-body">
      <form method="post">
        {% include "_claim_form.html" %}

        <div class="d-flex justify-content-end mt-3">
          <a href="{{ url_for('main.claims_list') }}" class="btn btn-sm btn-outline-secondary me-2">
            Cancel
          </a>
          <button type="submit" class="btn btn-sm btn-primary">
            Create Claim
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      const carrierSelect = document.querySelector('select[name="carrier_id"]');
      function ensureClaimantPhoneExtField() {
        const phoneInput = document.querySelector('input[name="claimant_phone"]');
        if (!phoneInput) return;

        // If already added, do nothing
        if (document.querySelector('input[name="claimant_phone_ext"]')) return;

        // Try to place the ext field next to the phone field by using the closest row/container.
        const phoneGroup = phoneInput.closest('.mb-3, .form-group, .col, .col-md-6, .col-md-4, .col-md-3') || phoneInput.parentElement;
        const row = phoneInput.closest('.row');

        // Build ext field
        const extWrapper = document.createElement('div');
        // If we're inside a Bootstrap row, use a narrow column. Otherwise, fall back to margin-top.
        if (row) {
          extWrapper.className = 'col-12 col-sm-3 col-md-2';
        } else {
          extWrapper.className = 'mt-2';
        }

        extWrapper.innerHTML = `
          <label class="form-label" for="claimant_phone_ext">Ext</label>
          <input type="text" class="form-control" name="claimant_phone_ext" id="claimant_phone_ext" maxlength="20" autocomplete="tel-extension" />
        `;

        // If we have a row, insert right after the phone field's column
        if (row) {
          const phoneCol = phoneInput.closest('[class*="col-"]') || phoneInput.parentElement;
          if (phoneCol && phoneCol.parentElement === row) {
            phoneCol.insertAdjacentElement('afterend', extWrapper);
            return;
          }
        }

        // Otherwise just append after the phone group
        (phoneGroup || phoneInput.parentElement).appendChild(extWrapper);
      }
      if (!carrierSelect) return;

      ensureClaimantPhoneExtField();

      // Pre-cache options for contacts and employers, if those selects exist
      const contactSelect = document.getElementById('carrier_contact_select');
      const employerSelect = document.querySelector('select[name="employer_id"]');

      const contactOptions = contactSelect
        ? Array.from(contactSelect.querySelectorAll('option[data-carrier-id]'))
        : [];
      const employerOptions = employerSelect
        ? Array.from(employerSelect.querySelectorAll('option[data-carrier-id]'))
        : [];

      function updateContacts() {
        if (!contactSelect || contactOptions.length === 0) return;

        const carrierId = carrierSelect.value || '';
        contactSelect.value = '';
        let hasOptions = false;

        contactOptions.forEach(function(opt) {
          const optCarrierId = opt.getAttribute('data-carrier-id') || '';
          if (carrierId && optCarrierId === carrierId) {
            opt.hidden = false;
            hasOptions = true;
          } else {
            opt.hidden = true;
          }
        });

        contactSelect.disabled = !hasOptions;
      }

      function updateEmployers() {
        if (!employerSelect || employerOptions.length === 0) return;

        const carrierId = carrierSelect.value || '';
        // Clear current selection any time the carrier changes
        employerSelect.value = '';
        let hasOptions = false;

        employerOptions.forEach(function(opt) {
          const optCarrierId = opt.getAttribute('data-carrier-id') || '';
          const show = carrierId && optCarrierId === carrierId;
          opt.hidden = !show;
          if (show) {
            hasOptions = true;
          }
        });

        employerSelect.disabled = !hasOptions;
      }

      // Initialize: hide all contact/employer options and disable selects until a carrier is chosen
      if (contactSelect && contactOptions.length > 0) {
        contactOptions.forEach(function(opt) { opt.hidden = true; });
        contactSelect.disabled = true;
      }

      if (employerSelect && employerOptions.length > 0) {
        employerOptions.forEach(function(opt) { opt.hidden = true; });
        employerSelect.disabled = true;
      }

      carrierSelect.addEventListener('change', function() {
        updateContacts();
        updateEmployers();
      });

      ensureClaimantPhoneExtField();
    })();
  </script>
{% endblock %}