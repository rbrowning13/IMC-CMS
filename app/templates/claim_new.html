{% extends "base.html" %}
{% block title %}New Claim{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">New Claim</h1>
    <a href="{{ url_for('main.claims_list') }}" class="btn btn-sm btn-outline-secondary">
      Cancel
    </a>
  </div>

  {% if error %}
    <div class="alert alert-danger alert-sm py-2 mb-3">
      {{ error }}
    </div>
  {% endif %}

  <div class="card">
    <div class="card-body">
      <form method="post">
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label class="form-label form-label-sm">Claim Number</label>
            <input type="text"
                   name="claim_number"
                   class="form-control form-control-sm"
                   required>
          </div>
          <div class="col-md-8">
            <label class="form-label form-label-sm">Claimant Name</label>
            <input type="text"
                   name="claimant_name"
                   class="form-control form-control-sm"
                   required>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label form-label-sm">Date of Birth</label>
            <input type="date"
                   name="dob"
                   class="form-control form-control-sm">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-sm">Date of Injury</label>
            <input type="date"
                   name="doi"
                   class="form-control form-control-sm">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-sm">Claim State</label>
            <select name="claim_state" class="form-select form-select-sm">
              {{ state_options() }}
            </select>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-8">
            <label class="form-label form-label-sm">Claimant Address</label>
            <input type="text"
                   name="claimant_address1"
                   class="form-control form-control-sm mb-1"
                   placeholder="Address line 1">
            <input type="text"
                   name="claimant_address2"
                   class="form-control form-control-sm"
                   placeholder="Address line 2 (optional)">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-sm">City / State / ZIP</label>
            <div class="d-flex gap-2">
              <input type="text"
                     name="claimant_city"
                     class="form-control form-control-sm"
                     placeholder="City">
              <select name="claimant_state" class="form-select form-select-sm" style="max-width: 90px;">
                {{ state_options() }}
              </select>
              <input type="text"
                     name="claimant_postal_code"
                     class="form-control form-control-sm"
                     placeholder="ZIP">
            </div>
          </div>

          <div class="col-md-4">
            <label class="form-label form-label-sm">Claimant Phone</label>
            <input type="text"
                   name="claimant_phone"
                   class="form-control form-control-sm"
                   placeholder="(555) 555-5555">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-sm">Claimant Email</label>
            <input type="email"
                   name="claimant_email"
                   class="form-control form-control-sm"
                   placeholder="name@example.com">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-sm">Primary Care Provider</label>
            <input type="text"
                   name="primary_care_provider"
                   class="form-control form-control-sm"
                   placeholder="PCP / treating physician">
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label form-label-sm">Carrier</label>
            <select name="carrier_id" class="form-select form-select-sm">
              <option value="">Select carrier…</option>
              {% for c in carriers %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label form-label-sm">Employer</label>
            <select name="employer_id" class="form-select form-select-sm">
              <option value="">Select employer…</option>
              {% for e in employers %}
                <option value="{{ e.id }}">{{ e.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label class="form-label form-label-sm">Carrier Contact (Adjuster)</label>
            <select name="carrier_contact_id" id="carrier_contact_select" class="form-select form-select-sm" disabled>
              <option value="">Select carrier contact…</option>
              {% for c in carriers %}
                {% for contact in c.contacts %}
                  <option value="{{ contact.id }}" data-carrier-id="{{ c.id }}">
                    {{ contact.name }}{% if contact.role %} – {{ contact.role }}{% endif %}
                  </option>
                {% endfor %}
              {% endfor %}
            </select>
            <div class="form-text">
              Only contacts for the selected carrier will be shown.
            </div>
          </div>
        </div>

        <div class="d-flex justify-content-end mt-3">
          <a href="{{ url_for('main.claims_list') }}" class="btn btn-sm btn-outline-secondary me-2">
            Cancel
          </a>
          <button type="submit" class="btn btn-sm btn-primary">
            Create Claim
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script>
    (function() {
      const carrierSelect = document.querySelector('select[name="carrier_id"]');
      const contactSelect = document.getElementById('carrier_contact_select');
      if (!carrierSelect || !contactSelect) return;

      const allOptions = Array.from(contactSelect.querySelectorAll('option[data-carrier-id]'));

      function updateContacts() {
        const carrierId = carrierSelect.value;
        contactSelect.value = '';
        let hasOptions = false;

        allOptions.forEach(function(opt) {
          if (opt.getAttribute('data-carrier-id') === carrierId) {
            opt.hidden = false;
            hasOptions = true;
          } else {
            opt.hidden = true;
          }
        });

        contactSelect.disabled = !hasOptions;
      }

      // Initialize: hide all contact options and disable select until a carrier is chosen
      allOptions.forEach(function(opt) { opt.hidden = true; });
      contactSelect.disabled = true;

      carrierSelect.addEventListener('change', updateContacts);
    })();
  </script>
{% endblock %}