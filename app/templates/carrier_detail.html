{% extends "base.html" %}
{% block title %}Carrier {{ carrier.name }} - Impact CMS{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Carrier: {{ carrier.name }}</h1>
      <div class="text-muted small">
        {% if carrier.city or carrier.state %}
          {{ carrier.city or '' }}{% if carrier.city and carrier.state %}, {% endif %}{{ carrier.state or '' }}
        {% else %}
          No location on file
        {% endif %}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.carriers_list') }}" class="btn btn-outline-secondary btn-sm">
        Back to Carriers
      </a>
      <a href="{{ url_for('main.carrier_edit', carrier_id=carrier.id) }}" class="btn btn-primary btn-sm">
        Edit
      </a>
      <form method="post"
            action="{{ url_for('main.carrier_delete', carrier_id=carrier.id) }}"
            onsubmit="return confirm('Are you sure you want to delete this carrier? This cannot be undone.');">
        <button type="submit" class="btn btn-outline-danger btn-sm">
          Delete
        </button>
      </form>
    </div>
  </div>

  <div class="row">
    <div class="col-12 mb-3">
      <!-- Carrier summary -->
      <div class="card shadow-sm mb-3">
        <div class="card-header">
          <h2 class="h6 mb-0">Carrier Info</h2>
        </div>
        <div class="card-body small">
          <div class="row g-3">

            <!-- Left column: address/contact info -->
            <div class="col-12 col-md-6">
              <dl class="row mb-0">

                <dt class="col-sm-4">Name</dt>
                <dd class="col-sm-8">{{ carrier.name }}</dd>

                <dt class="col-sm-4">Address 1</dt>
                <dd class="col-sm-8">{{ carrier.address1 or "—" }}</dd>

                <dt class="col-sm-4">Address 2</dt>
                <dd class="col-sm-8">{{ carrier.address2 or "—" }}</dd>

                <dt class="col-sm-4">City</dt>
                <dd class="col-sm-8">{{ carrier.city or "—" }}</dd>

                <dt class="col-sm-4">State</dt>
                <dd class="col-sm-8">{{ carrier.state or "—" }}</dd>

                <dt class="col-sm-4">Postal Code</dt>
                <dd class="col-sm-8">{{ carrier.postal_code or "—" }}</dd>

                <dt class="col-sm-4">Phone</dt>
                <dd class="col-sm-8">
                  {% if carrier.phone %}
                    {{ carrier.phone|format_phone }}{% if carrier.phone_ext %} x{{ carrier.phone_ext }}{% endif %}
                  {% else %}
                    —
                  {% endif %}
                </dd>

                <dt class="col-sm-4">Fax</dt>
                <dd class="col-sm-8">{{ carrier.fax or "—" }}</dd>

                <dt class="col-sm-4">Email</dt>
                <dd class="col-sm-8">
                  {% if carrier.email %}
                    <a href="mailto:{{ carrier.email }}">{{ carrier.email }}</a>
                  {% else %}
                    —
                  {% endif %}
                </dd>

              </dl>
            </div>

            <!-- Right column: rates + counts -->
            <div class="col-12 col-md-6">
              <dl class="row mb-0">

                <dt class="col-sm-5">Hourly Rate</dt>
                <dd class="col-sm-7">
                  {% if carrier.hourly_rate is not none %}
                    ${{ '%.2f'|format(carrier.hourly_rate|float) }}
                  {% else %}
                    <span class="text-muted">Default:</span> ${{ '%.2f'|format(effective_hourly_rate|float) }}
                  {% endif %}
                </dd>

                <dt class="col-sm-5">Telephonic Rate</dt>
                <dd class="col-sm-7">
                  {% if carrier.telephonic_rate is not none %}
                    ${{ '%.2f'|format(carrier.telephonic_rate|float) }}
                  {% else %}
                    <span class="text-muted">Default:</span> ${{ '%.2f'|format(effective_telephonic_rate|float) }}
                  {% endif %}
                </dd>

                <dt class="col-sm-5">Mileage Rate</dt>
                <dd class="col-sm-7">
                  {% if carrier.mileage_rate is not none %}
                    ${{ '%.4f'|format(carrier.mileage_rate|float) }}/mi
                  {% else %}
                    <span class="text-muted">Default:</span> ${{ '%.4f'|format(effective_mileage_rate|float) }}/mi
                  {% endif %}
                </dd>

                <dt class="col-sm-5">Claims</dt>
                <dd class="col-sm-7">{{ carrier.claims|length }}</dd>

                <dt class="col-sm-5">Invoices</dt>
                <dd class="col-sm-7">{{ carrier.invoices|length }}</dd>

              </dl>
            </div>

          </div>
        </div>

      </div>

      <!-- Contacts -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Contacts</h2>
        </div>
        <div class="card-body small d-flex flex-column">
          {% if carrier.contacts %}
            <div class="table-responsive mb-3" style="max-height: 260px; overflow-y: auto;">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Phone</th>
                    <th>Fax</th>
                    <th>Email</th>
                    <th style="width: 30%;">Notes</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for contact in carrier.contacts %}
                    <tr>
                      <td>{{ contact.name }}</td>
                      <td>
                        {% if contact.contact_role and contact.contact_role.label %}
                          {{ contact.contact_role.label }}
                        {% elif contact.contact_role_id is defined and contact.contact_role_id %}
                          {# Fallback if relationship isn't loaded #}
                          {{ contact.role or "—" }}
                        {% else %}
                          {{ contact.role or "—" }}
                        {% endif %}
                      </td>
                      <td>
                        {% if contact.phone %}
                          {{ contact.phone|format_phone }}{% if contact.phone_ext %} x{{ contact.phone_ext }}{% endif %}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        {% if contact.fax %}
                          {{ contact.fax|format_phone }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        {% if contact.email %}
                          <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        {% if contact.notes %}
                          <span class="text-muted text-truncate d-inline-block"
                                style="max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ contact.notes }}
                          </span>
                        {% else %}
                          <span class="text-muted fst-italic">No notes</span>
                        {% endif %}
                      </td>
                      <td class="text-end">
                        <a href="{{ url_for('main.carrier_detail', carrier_id=carrier.id, edit_contact_id=contact.id) }}"
                           class="btn btn-sm btn-outline-secondary me-1">
                          Edit
                        </a>
                        <form method="post"
                              action="{{ url_for('main.contact_delete', contact_id=contact.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this contact? This cannot be undone.');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-3">
              No contacts yet for this carrier.
            </p>
          {% endif %}

          <hr class="my-2">

          <!-- Add / Edit contact form -->
          <h3 class="h6 mt-2 mb-2">
            {% if edit_contact %}
              Edit Contact
            {% else %}
              Add Contact
            {% endif %}
          </h3>
          {% set _cf = contact_form if contact_form is defined and contact_form else (form if form is defined and form else {}) %}
          <form method="post"
                action="{% if edit_contact %}{{ url_for('main.contact_update', contact_id=edit_contact.id, parent_type='carrier', parent_id=carrier.id) }}{% else %}{{ url_for('main.contact_new', parent_type='carrier', parent_id=carrier.id) }}{% endif %}"
                class="row g-2">
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">Name</label>
              <input type="text" name="name" class="form-control form-control-sm" required
                     value="{{ edit_contact.name if edit_contact else (_cf.get('name','') if _cf is mapping else '') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-0">Role</label>
              {% set _roles = contact_role_options if contact_role_options is defined and contact_role_options else (contact_roles if contact_roles is defined and contact_roles else []) %}
              <select name="contact_role_id" class="form-select form-select-sm">
                <option value="">Select role…</option>
                {% for r in _roles %}
                  {# Support strings, dicts (e.g. {id,label}), and SQLAlchemy objects with .id/.label #}
                  {% if r is mapping %}
                    {% set role_id = r.get('id') %}
                    {% set role_label = r.get('label') %}
                  {% else %}
                    {% set role_id = (r.id if r is not string and r is not number and (r.id is defined) else None) %}
                    {% set role_label = (r.label if r is not string and r is not number and (r.label is defined) else r) %}
                  {% endif %}
                  {% set role_label = (role_label or '') %}
                  {% if role_label %}
                    <option value="{{ role_id }}"
                            {% if edit_contact and ((edit_contact.contact_role_id is defined and edit_contact.contact_role_id == role_id) or (edit_contact.contact_role and edit_contact.contact_role.id == role_id)) %}selected{% endif %}
                            {% if (not edit_contact) and (_cf is mapping) and (_cf.get('contact_role_id','')|string == role_id|string) %}selected{% endif %}>
                      {{ role_label }}
                    </option>
                  {% endif %}
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-0">Phone</label>
              <input type="tel"
                     name="phone"
                     class="form-control form-control-sm"
                     data-auto-phone="1"
                     inputmode="numeric"
                     autocomplete="tel"
                     value="{{ edit_contact.phone if edit_contact else (_cf.get('phone','') if _cf is mapping else '') }}">
            </div>
            <div class="col-md-2">
              <label class="form-label form-label-sm mb-0">Ext</label>
              <input type="text"
                     name="phone_ext"
                     class="form-control form-control-sm"
                     inputmode="numeric"
                     autocomplete="off"
                     value="{{ edit_contact.phone_ext if edit_contact else (_cf.get('phone_ext','') if _cf is mapping else '') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-0">Fax</label>
              <input type="tel"
                     name="fax"
                     class="form-control form-control-sm"
                     data-auto-phone="1"
                     inputmode="numeric"
                     autocomplete="tel"
                     value="{{ edit_contact.fax if edit_contact else (_cf.get('fax','') if _cf is mapping else '') }}">
            </div>
            <div class="col-md-5">
              <label class="form-label form-label-sm mb-0">Email</label>
              <input type="email" name="email" class="form-control form-control-sm"
                     value="{{ edit_contact.email if edit_contact else (_cf.get('email','') if _cf is mapping else '') }}">
            </div>
            <div class="col-md-7">
              <label class="form-label form-label-sm mb-0">Notes</label>
              <textarea name="notes"
                        class="form-control form-control-sm"
                        rows="2"
                        placeholder="Best time to reach them, etc.">{{ edit_contact.notes if edit_contact else (_cf.get('notes','') if _cf is mapping else '') }}</textarea>
            </div>
            <div class="col-12 d-flex justify-content-end gap-2">
              {% if edit_contact %}
                <a href="{{ url_for('main.carrier_detail', carrier_id=carrier.id) }}" class="btn btn-sm btn-outline-secondary">
                  Cancel
                </a>
                <button type="submit" class="btn btn-sm btn-primary">
                  Save Changes
                </button>
              {% else %}
                <button type="submit" class="btn btn-sm btn-primary">
                  Add Contact
                </button>
              {% endif %}
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}