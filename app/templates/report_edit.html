{% extends "base.html" %}
{% block title %}
  {% if display_report_number is defined and display_report_number %}
    Report #{{ display_report_number }} – Impact CMS
  {% else %}
    Report – Impact CMS
  {% endif %}
{% endblock %}

{% block content %}


<div class="container-fluid">

  {# Flash messages (warnings/errors/success) #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% set _cat = category or 'info' %}
        {% if _cat == 'message' %}{% set _cat = 'info' %}{% endif %}
        <div class="alert alert-{{ _cat }} small js-auto-dismiss" role="alert">
          <span class="js-flash-msg">{{ message }}</span>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if error %}
    <div class="alert alert-danger small js-auto-dismiss" role="alert">
      <span class="js-flash-msg">{{ error }}</span>
    </div>
  {% endif %}

  <!-- Header / breadcrumb -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">
        {% if display_report_number is defined and display_report_number %}
          Report #{{ display_report_number }}
        {% else %}
          Report
        {% endif %}
      </h1>
      <div class="text-muted small">
        Claim: {{ claim.claimant_name }} · Claim #{{ claim.claim_number }}
        {% if report.report_type %}
          · Type: {{ (report.report_type or '')|capitalize }}
        {% endif %}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="btn btn-outline-secondary btn-sm">
        Cancel
      </a>
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="btn btn-outline-secondary btn-sm">
        Back to Claim
      </a>
      <a href="{{ url_for('main.report_print', claim_id=claim.id, report_id=report.id) }}"
         class="btn btn-outline-secondary btn-sm">
        Preview / Print
      </a>
      <a href="{{ url_for('main.report_print', claim_id=claim.id, report_id=report.id, download=1) }}"
         class="btn btn-outline-primary btn-sm">
        Download PDF
      </a>
    </div>
  </div>

  <form method="post" action="{{ url_for('main.report_edit', claim_id=claim.id, report_id=report.id) }}" enctype="multipart/form-data">
    {{ csrf_field() if csrf_field is defined }}

    <div class="row">
      <!-- Left column: core fields -->
      <div class="col-lg-8 mb-3">
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Report Metadata</h2>
          </div>
          <div class="card-body small">
            <div class="row g-3">

            {# Keep report_type value for POST handling, but don't show it in the metadata UI #}
            <input type="hidden" name="report_type" value="{{ report.report_type }}">

            <!-- Treating Provider(s) selector (checkbox list) -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-1">Treating Provider(s)</label>
              <input
                type="text"
                id="provider_search"
                class="form-control form-control-sm mb-2"
                placeholder="Search providers…"
                autocomplete="off"
              >

              {# Prefer ids passed in from the route; fallback to existing single treating_provider_id #}
              {% set _sel_ids = approved_provider_ids if approved_provider_ids is defined else [] %}
              {% if (not _sel_ids) and report.treating_provider_id %}
                {% set _sel_ids = [report.treating_provider_id] %}
              {% endif %}

              <div class="border rounded p-2">
                <div class="small text-muted mb-1">Selected</div>
                <div id="provider_selected" class="mb-2">
                  {# rows will be moved here by JS on load #}
                </div>

                <div class="small text-muted mb-1">Search results</div>
                <div id="provider_results" style="max-height: 180px; overflow-y: auto;">
                  {% for provider in providers %}
                    <div class="form-check mb-1 provider-row" style="position: relative;">
                      <input
                        class="form-check-input js-accent-check provider-checkbox"
                        type="checkbox"
                        name="approved_provider_ids"
                        id="provider_{{ provider.id }}"
                        value="{{ provider.id }}"
                        {% if provider.id in _sel_ids %}checked{% endif %}
                        style="position: relative; z-index: 5; pointer-events: auto; accent-color: var(--accent-color);"
                      >
                      <label class="form-check-label provider-label" for="provider_{{ provider.id }}" style="position: relative; z-index: 5; pointer-events: auto; cursor: pointer;">
                        {{ provider.name }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              </div>
            </div>


            <!-- DOS range -->
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">DOS Start</label>
              <input type="text"
                     name="dos_start"
                     class="form-control form-control-sm js-date"
                     placeholder="MM/DD/YYYY"
                     value="{{ report.dos_start.strftime('%m/%d/%Y') if report and report.dos_start else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">DOS End</label>
              <input type="text"
                     name="dos_end"
                     class="form-control form-control-sm js-date"
                     placeholder="MM/DD/YYYY"
                     value="{{ report.dos_end.strftime('%m/%d/%Y') if report and report.dos_end else '' }}">
            </div>

            <!-- Next report due -->
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">Next Report Due</label>
              <input type="text"
                     name="next_report_due"
                     class="form-control form-control-sm js-date"
                     placeholder="MM/DD/YYYY"
                     value="{{ report.next_report_due.strftime('%m/%d/%Y') if report and report.next_report_due else '' }}">
            </div>

            </div>
          </div>
        </div>

        <!-- Clinical content -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Clinical Content</h2>
          </div>
          <div class="card-body small">
            <div class="row g-3">
            {% if report.report_type == 'initial' %}
            <!-- Primary Care Provider / Family Doctor (Initial report only) -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Primary Care Provider / Family Doctor</label>
              <input type="text"
                     name="primary_care_provider"
                     class="form-control form-control-sm"
                     value="{{ (report.primary_care_provider if report.primary_care_provider is defined else '') or (claim.primary_care_provider if claim.primary_care_provider is defined else '') or '' }}">
              <div class="form-text">Initial report only (not shown on later reports).</div>
            </div>
            <!-- Diagnosis -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Diagnosis</label>
              <textarea name="initial_diagnosis"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_diagnosis or "" }}</textarea>
            </div>

            <!-- Mechanism of injury -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Mechanism of Injury</label>
              <textarea name="initial_mechanism_of_injury"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_mechanism_of_injury or "" }}</textarea>
            </div>

            <!-- Co-existing conditions -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Concurrent Conditions</label>
              <textarea name="initial_coexisting_conditions"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_coexisting_conditions or "" }}</textarea>
            </div>

            <!-- Surgical history -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Surgical History</label>
              <textarea name="initial_surgical_history"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_surgical_history or "" }}</textarea>
            </div>

            <!-- Medications -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Medications</label>
              <textarea name="initial_medications"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_medications or "" }}</textarea>
            </div>

            <!-- Diagnostics -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Diagnostics</label>
              <textarea name="initial_diagnostics"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_diagnostics or "" }}</textarea>
            </div>

            <!-- Employment status (Initial only) -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Employment Status</label>
              <textarea name="employment_status"
                        id="employment_status_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.employment_status or "" }}</textarea>
            </div>
            {% endif %}

            <!-- Current status / treatment plan -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Current Status / Treatment Plan</label>
                {% if report.report_type != 'initial' %}
                <button type="button"
                        class="btn btn-link btn-sm p-0"
                        onclick="rollForwardField('status_treatment_plan', 'status_treatment_plan_field')">
                  Roll forward from last report
                </button>
                {% endif %}
              </div>
              <textarea name="status_treatment_plan"
                        id="status_treatment_plan_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.status_treatment_plan or "" }}</textarea>
            </div>

            <!-- Work status -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Work Status</label>
                {% if report.report_type != 'initial' %}
                <button type="button"
                        class="btn btn-link btn-sm p-0"
                        onclick="rollForwardField('work_status', 'work_status_field')">
                  Roll forward from last report
                </button>
                {% endif %}
              </div>
              <textarea name="work_status"
                        id="work_status_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.work_status or "" }}</textarea>
            </div>


            {% if report.report_type != 'closure' %}
            <!-- Case management plan -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Case Management Plan</label>
                {% if report.report_type != 'initial' %}
                <button type="button"
                        class="btn btn-link btn-sm p-0"
                        onclick="rollForwardField('case_management_plan', 'case_management_plan_field')">
                  Roll forward from last report
                </button>
                {% endif %}
              </div>
              <textarea name="case_management_plan"
                        id="case_management_plan_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.case_management_plan or "" }}</textarea>
            </div>
            {% endif %}
            </div>
          </div>
        </div>

        {% if report.report_type != 'closure' %}
        <!-- Barriers -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Possible Barriers to Recovery</h2>
          </div>
          <div class="card-body small scroll-area" style="max-height: 360px;">
            {% set selected_ids = selected_barrier_ids if selected_barrier_ids is defined else [] %}
            {% if barriers_by_category %}
              {% for category, options in barriers_by_category.items() %}
                {% set cat = category if category and category|trim else "Uncategorized" %}
                <div class="mb-2">
                  <div class="fw-semibold small">{{ cat }}</div>
                  {% for opt in options %}
                    <div class="form-check mb-1" style="position: relative;">
                      <input class="form-check-input js-accent-check"
                             type="checkbox"
                             name="barrier_ids"
                             id="barrier_{{ opt.id }}"
                             value="{{ opt.id }}"
                             {% if opt.id in selected_ids %}checked{% endif %}
                             style="position: relative; z-index: 5; pointer-events: auto; accent-color: var(--accent-color);">
                      <label class="form-check-label" for="barrier_{{ opt.id }}" style="position: relative; z-index: 5; pointer-events: auto; cursor: pointer;">
                        {{ opt.label }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">No barrier options configured.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if report.report_type == 'closure' %}
        <!-- Closure-only fields (they can stay empty for Initial/Progress) -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Closure</h2>
          </div>
          <div class="card-body small">
            <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label form-label-sm mb-0">Closure Reason</label>
              <select name="closure_reason" class="form-select form-select-sm">
                <option value="">— Not closed —</option>
                {% set closure = report.closure_reason or "" %}
                {% for opt in [
                  "AMA",
                  "Death",
                  "MMI",
                  "RTW",
                  "RTW Modified Duty",
                  "RTW FULL DUTY",
                  "Task Fulfilled",
                  "Treatment Completed",
                  "Patient Non-compliance",
                  "Lack of Contact",
                  "Transferred care",
                  "Claim Closure"
                ] %}
                  <option value="{{ opt }}"
                          {% if closure == opt %}selected{% endif %}>
                    {{ opt }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Closure Details</label>
              <textarea name="closure_details"
                        id="closure_details_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.closure_details or "" }}</textarea>
            </div>
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Case Management Impact</label>
              <textarea name="closure_case_management_impact"
                        id="closure_case_management_impact_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.closure_case_management_impact or "" }}</textarea>
            </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Report Documents -->
        <div class="row mb-3">
          <div class="col-lg-12">
            <div class="card shadow-sm">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h6 mb-0">Report Documents</h2>
              </div>
              <div class="card-body small">
                {% if report.documents %}
                  <div class="table-responsive mb-3">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 40%">File Name</th>
                          <th style="width: 35%">Description</th>
                          <th style="width: 15%">Uploaded</th>
                          <th style="width: 10%" class="text-end">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for d in report.documents %}
                          <tr>
                            <td class="small">{{ d.original_filename or "(unnamed)" }}</td>
                            <td class="small">{{ d.description or "—" }}</td>
                            <td class="small">
                              {% if d.uploaded_at %}
                                {{ d.uploaded_at.strftime('%m/%d/%Y %I:%M %p') }}
                              {% else %}
                                —
                              {% endif %}
                            </td>
                            <td class="text-end">
                              <a href="{{ url_for('main.report_document_download', report_document_id=d.id) }}"
                                 class="btn btn-sm btn-outline-secondary me-1">
                                Open
                              </a>

                              <button
                                type="submit"
                                class="btn btn-sm btn-outline-secondary me-1"
                                formaction="{{ url_for('main.report_document_open_location', report_document_id=d.id) }}"
                                formmethod="post"
                              >
                                Open Location
                              </button>

                              <button
                                type="submit"
                                class="btn btn-sm btn-outline-danger"
                                formaction="{{ url_for('main.report_document_delete', report_document_id=d.id) }}"
                                formmethod="post"
                                onclick="return confirm('Delete this document? This cannot be undone.');"
                              >
                                Delete
                              </button>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted mb-3">No documents uploaded for this report yet.</p>
                {% endif %}

                <hr class="my-2">

                <div class="row g-2 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label form-label-sm mb-0">Select File</label>
                    <input type="file" name="file" class="form-control form-control-sm">
                  </div>
                  <div class="col-12 mt-2">
                    <label class="form-label form-label-sm mb-0">Description (optional)</label>
                    <input type="text" name="description" class="form-control form-control-sm" placeholder="e.g., Clinic notes, imaging, correspondence">
                  </div>
                  <div class="col-md-2 text-end">
                    <button
                      type="submit"
                      class="btn btn-primary btn-sm w-100 mt-4 mt-md-2"
                      formaction="{{ url_for('main.report_document_upload', claim_id=claim.id, report_id=report.id) }}"
                      formmethod="post"
                      formenctype="multipart/form-data"
                    >
                      Upload
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right column: barriers + next appointment + actions -->
      <div class="col-lg-4 mb-3">


        <!-- Next appointment -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Next Appointment</h2>
          </div>
          <div class="card-body small">
            <div class="row g-2">
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Date / Time</label>
              <input type="datetime-local"
                     id="initial_next_appt_datetime"
                     name="initial_next_appt_datetime"
                     class="form-control form-control-sm"
                     value="{% if report.initial_next_appt_datetime %}{{ report.initial_next_appt_datetime.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
            </div>
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Provider</label>
              <select
                name="initial_next_appt_provider_name"
                class="form-select form-select-sm"
              >
                <option value="">— Select provider… —</option>
                {% for p in providers %}
                  <option value="{{ p.name }}"
                          {% if report.initial_next_appt_provider_name == p.name %}selected{% endif %}>
                    {{ p.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted">Generate a calendar event for this appointment.</small>
              <a href="{{ url_for('main.report_next_appointment_ics', claim_id=claim.id, report_id=report.id) }}"
                 id="download_ics_btn"
                 class="btn btn-outline-secondary btn-sm"
                 {% if not report.initial_next_appt_datetime %}disabled{% endif %}>
                Download .ics
              </a>
            </div>
            </div>
          </div>
        </div>

        <!-- Billing / invoice actions -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Billing &amp; Invoice</h2>
          </div>
          <div class="card-body small d-flex flex-column gap-2">
            <p class="mb-1 text-muted">
              Create an invoice for this report using all uninvoiced, complete billable items
              within this report's date-of-service range.
            </p>
            <a href="{{ url_for('main.invoice_new_for_report', claim_id=claim.id, report_id=report.id) }}"
               class="btn btn-sm btn-outline-primary">
              Create Invoice for this Report
            </a>
          </div>
        </div>

        <!-- Save / cancel -->
        <div class="card shadow-sm">
          <div class="card-body d-flex justify-content-between align-items-center">
            <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
               class="btn btn-outline-secondary btn-sm">
              Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-sm">
              Save Changes
            </button>
          </div>
        </div>

    </div>
  </div>

  <!-- Bottom Save / Cancel (full-width) -->
  <div class="card shadow-sm mt-3">
    <div class="card-body d-flex justify-content-between align-items-center">
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
         class="btn btn-outline-secondary btn-sm">
        Cancel
      </a>
      <button type="submit" class="btn btn-primary btn-sm">
        Save Changes
      </button>
    </div>
  </div>

</div>

      </div>
    </div>
  </form>

</div>
<script>
  (function () {
    const baseUrl = "{{ url_for('main.report_roll_forward', claim_id=claim.id, report_id=report.id, field_name='__FIELD__') }}";

    function showNotice(message, level) {
      if (!message) return;

      // Remove any previous roll-forward notice.
      const existing = document.getElementById("rf-floating-alert");
      if (existing) existing.remove();

      // Build a lightweight floating alert.
      const el = document.createElement("div");
      el.id = "rf-floating-alert";
      el.setAttribute("role", "alert");

      const lvl = (level || "info").toLowerCase();
      const bsClass =
        lvl === "success" ? "alert-success" :
        lvl === "warning" ? "alert-warning" :
        lvl === "danger" ? "alert-danger" :
        "alert-info";

      el.className = "alert " + bsClass + " small";
      // Inline positioning so this works even if the global helper isn't available.
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.top = "20px";
      el.style.transform = "translateX(-50%)";
      el.style.zIndex = "9999";
      el.style.maxWidth = "min(720px, calc(100vw - 24px))";
      el.style.width = "fit-content";
      el.style.boxShadow = "0 10px 30px rgba(0,0,0,0.15)";

      el.textContent = message;
      document.body.appendChild(el);

      const lvl2 = (level || "info").toLowerCase();

      // Dismiss behavior:
      // - danger/warning: dismiss on first interaction (sticky)
      // - success/info: auto-dismiss quickly (less noisy)
      const dismiss = function () {
        const cur = document.getElementById("rf-floating-alert");
        if (cur) cur.remove();
        document.removeEventListener("mousedown", dismiss, true);
        document.removeEventListener("keydown", dismiss, true);
        document.removeEventListener("touchstart", dismiss, true);
      };

      if (lvl2 === "danger" || lvl2 === "warning") {
        document.addEventListener("mousedown", dismiss, true);
        document.addEventListener("touchstart", dismiss, true);
        document.addEventListener("keydown", dismiss, true);
      } else {
        window.setTimeout(dismiss, 2200);
      }
    }

    function setFieldValue(el, value) {
      if (!el) return;

      const v = (value === null || value === undefined) ? "" : String(value);

      // Standard inputs / textarea
      if ("value" in el) {
        el.value = v;
      }

      // Fire events so any listeners (validation, enable/disable buttons, etc.) react.
      try {
        el.dispatchEvent(new Event("input", { bubbles: true }));
        el.dispatchEvent(new Event("change", { bubbles: true }));
      } catch (e) {
        // ignore
      }

      // Visual cue + scroll
      try {
        el.classList.add("is-invalid");
        setTimeout(function () {
          el.classList.remove("is-invalid");
        }, 800);
      } catch (e) {
        // ignore
      }

      try {
        el.scrollIntoView({ behavior: "smooth", block: "center" });
        el.focus({ preventScroll: true });
      } catch (e) {
        // ignore
      }
    }

    window.rollForwardField = function (fieldName, elementId) {
      const url = baseUrl.replace("__FIELD__", fieldName);
      const el = document.getElementById(elementId);

      if (!el) {
        showNotice("Roll forward failed: field not found on page.", "danger");
        return;
      }

      fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json"
        }
      })
        .then(function (response) {
          // If we got redirected to HTML (login page, error page, etc.), JSON parsing will fail.
          const ct = (response.headers.get("content-type") || "").toLowerCase();
          if (!response.ok) {
            throw new Error("Request failed (" + response.status + ")");
          }
          if (ct.indexOf("application/json") === -1) {
            throw new Error("Unexpected response type");
          }
          return response.json();
        })
        .then(function (data) {
          // Backend returns: { value: <string|null> }
          if (!data || !("value" in data)) {
            showNotice("Nothing to roll forward.", "warning");
            return;
          }

          const v = data.value;
          if (v === null || v === undefined || String(v).trim() === "") {
            // Clear the field (explicitly) and notify.
            setFieldValue(el, "");
            showNotice("No prior value found for that field.", "warning");
            return;
          }

          setFieldValue(el, String(v));
          showNotice("Rolled forward from last report.", "success");
        })
        .catch(function (error) {
          console.error("Roll forward failed:", error);
          showNotice("Roll forward failed. Try refreshing the page.", "danger");
        });
    };

    // Enable/disable the ICS download button based on the next appointment datetime field
    const dtInput = document.getElementById("initial_next_appt_datetime");
    const icsButton = document.getElementById("download_ics_btn");

    function updateIcsButtonState() {
      if (!dtInput || !icsButton) return;
      if (!dtInput.value) {
        icsButton.setAttribute("disabled", "disabled");
      } else {
        icsButton.removeAttribute("disabled");
      }
    }

    if (dtInput) {
      dtInput.addEventListener("input", updateIcsButtonState);
      dtInput.addEventListener("change", updateIcsButtonState);
    }

    // Run once on load
    updateIcsButtonState();
  })();
</script>
<script>
  (function () {
    // Treating Provider(s) UX:
    // - Selected providers persist in a dedicated list
    // - Search shows matching unselected providers
    // - By default (no search), hide unselected providers

    const providerSearch = document.getElementById("provider_search");
    const selectedBox = document.getElementById("provider_selected");
    const resultsBox = document.getElementById("provider_results");

    function normalize(str) {
      return (str || "").toString().toLowerCase().trim();
    }

    function rowLabelText(row) {
      const label = row ? row.querySelector(".provider-label") : null;
      return normalize(label ? label.textContent : "");
    }

    function isChecked(row) {
      const cb = row ? row.querySelector(".provider-checkbox") : null;
      return !!(cb && cb.checked);
    }

    function ensureSelectedPlaceholder() {
      if (!selectedBox) return;
      let ph = selectedBox.querySelector(".provider-selected-empty");
      const anySelected = selectedBox.querySelectorAll(".provider-row").length > 0;
      if (anySelected) {
        if (ph) ph.remove();
        return;
      }
      if (!ph) {
        ph = document.createElement("div");
        ph.className = "text-muted small provider-selected-empty";
        ph.textContent = "No providers selected.";
        selectedBox.appendChild(ph);
      }
    }

    function moveRows() {
      if (!selectedBox || !resultsBox) return;
      const rows = resultsBox.querySelectorAll(".provider-row");

      // Move checked rows into selectedBox.
      rows.forEach(function (row) {
        if (isChecked(row)) {
          selectedBox.appendChild(row);
        }
      });

      // Also check selectedBox in case something was there already.
      const selectedRows = selectedBox.querySelectorAll(".provider-row");
      selectedRows.forEach(function (row) {
        // If unchecked, move back to results.
        if (!isChecked(row)) {
          resultsBox.appendChild(row);
        }
      });

      ensureSelectedPlaceholder();
    }

    function applyFilter() {
      if (!providerSearch || !resultsBox) return;
      const q = normalize(providerSearch.value);

      // Always keep selected list visible; only filter results list.
      const rows = resultsBox.querySelectorAll(".provider-row");
      rows.forEach(function (row) {
        if (isChecked(row)) {
          // Shouldn't happen (checked rows should be moved), but be safe.
          row.style.display = "";
          return;
        }

        if (!q) {
          // Default view: hide unselected providers.
          row.style.display = "none";
          return;
        }

        // Searching: show matches.
        const text = rowLabelText(row);
        row.style.display = text.includes(q) ? "" : "none";
      });
    }

    function wireCheckboxes() {
      if (!resultsBox || !selectedBox) return;
      const allRows = document.querySelectorAll(".provider-row");
      allRows.forEach(function (row) {
        const cb = row.querySelector(".provider-checkbox");
        if (!cb || cb.dataset.wired === "1") return;
        cb.dataset.wired = "1";
        cb.addEventListener("change", function () {
          moveRows();
          applyFilter();
        });
      });
    }

    if (providerSearch) {
      providerSearch.addEventListener("input", function () {
        // On first search keystroke, ensure any checked items are moved.
        moveRows();
        applyFilter();
      });

      providerSearch.addEventListener("keydown", function (e) {
        if (e.key === "Escape") {
          providerSearch.value = "";
          moveRows();
          applyFilter();
          providerSearch.blur();
        }
      });
    }

    // Init on load
    wireCheckboxes();
    moveRows();
    applyFilter();
  })();
</script>
{% endblock %}