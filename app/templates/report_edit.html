{% extends "base.html" %}
{% block title %}
  {% if display_report_number is defined and display_report_number %}
    Report #{{ display_report_number }} – Impact CMS
  {% else %}
    Report – Impact CMS
  {% endif %}
{% endblock %}

{% block content %}


<div class="container-fluid">

  {# Flash messages (warnings/errors/success) #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% set _cat = category or 'info' %}
        {% if _cat == 'message' %}{% set _cat = 'info' %}{% endif %}
        <div class="alert alert-{{ _cat }} small js-auto-dismiss" role="alert">
          <span class="js-flash-msg">{{ message }}</span>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if error %}
    <div class="alert alert-danger small js-auto-dismiss" role="alert">
      <span class="js-flash-msg">{{ error }}</span>
    </div>
  {% endif %}

  <!-- Header / breadcrumb -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">
        {% if display_report_number is defined and display_report_number %}
          Report #{{ display_report_number }}
        {% else %}
          Report
        {% endif %}
      </h1>
      <div class="text-muted small">
        Claim:
        {% if (claim.claimant_last_name or '')|trim or (claim.claimant_first_name or '')|trim %}
          {{ (claim.claimant_last_name or '')|trim }}{% if (claim.claimant_first_name or '')|trim %}, {{ (claim.claimant_first_name or '')|trim }}{% endif %}
        {% else %}
          {{ claim.claimant_name }}
        {% endif %}
        · Claim #{{ claim.claim_number }}
        {% if report.report_type %}
          · Type: {{ (report.report_type or '')|capitalize }}
        {% endif %}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="btn btn-outline-secondary btn-sm">
        Cancel
      </a>
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="btn btn-outline-secondary btn-sm">
        Back to Claim
      </a>
      <a href="{{ url_for('main.report_pdf', claim_id=claim.id, report_id=report.id, view=1) }}"
         class="btn btn-outline-secondary btn-sm"
         target="_blank"
         rel="noopener">
        View PDF
      </a>
      <a href="{{ url_for('main.report_pdf', claim_id=claim.id, report_id=report.id) }}"
         class="btn btn-outline-primary btn-sm">
        Download PDF
      </a>

      <form method="post"
            action="{{ url_for('main.report_pdf_regenerate', claim_id=claim.id, report_id=report.id) }}"
            class="d-inline"
            target="_blank"
            onsubmit="return confirm('Regenerate the report PDF? This will create a new saved PDF version.');">
        <button type="submit" class="btn btn-outline-warning btn-sm">
          Regenerate PDF
        </button>
      </form>
    </div>
  </div>

  <form method="post" action="{{ url_for('main.report_edit', claim_id=claim.id, report_id=report.id) }}" enctype="multipart/form-data">
    {{ csrf_field() if csrf_field is defined }}

    <div class="row">
      <!-- Left column: core fields -->
      <div class="col-lg-8 mb-3">
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Report Metadata</h2>
          </div>
          <div class="card-body small">
            <div class="row g-3">

            {# Keep report_type value for POST handling, but don't show it in the metadata UI #}
            <input type="hidden" name="report_type" value="{{ report.report_type }}">

            
            <div class="col-12">
              <div class="small text-muted mb-1">Treating Providers</div>
              <div class="fw-semibold">
                {% if claim_providers is defined and claim_providers %}
                  {% set ns = namespace(labels=[]) %}
                  {% for p in claim_providers %}
                    {% set _label = (p.organization if (p.organization is defined and p.organization) else p.name) %}
                    {% set ns.labels = ns.labels + [_label] %}
                  {% endfor %}
                  {{ ns.labels|join(', ') }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </div>
            </div>


            <!-- DOS range -->
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">DOS Start</label>
              <input type="text"
                     name="dos_start"
                     class="form-control form-control-sm js-date"
                     placeholder="MM/DD/YYYY"
                     value="{{ report.dos_start.strftime('%m/%d/%Y') if report and report.dos_start else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">DOS End</label>
              <input type="text"
                     name="dos_end"
                     class="form-control form-control-sm js-date"
                     placeholder="MM/DD/YYYY"
                     value="{{ report.dos_end.strftime('%m/%d/%Y') if report and report.dos_end else '' }}">
            </div>

            <!-- Next report due -->
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">Next Report Due</label>
              <input type="text"
                     name="next_report_due"
                     class="form-control form-control-sm js-date"
                     placeholder="MM/DD/YYYY"
                     value="{{ report.next_report_due.strftime('%m/%d/%Y') if report and report.next_report_due else '' }}">
            </div>

            </div>
          </div>
        </div>

        <!-- Clinical content -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Clinical Content</h2>
          </div>
          <div class="card-body small">
            <div class="row g-3">
              <div class="col-12">
  <label class="form-label form-label-sm mb-1">AI instructions (optional)</label>
  <input
    type="text"
    id="ai_user_prompt"
    class="form-control form-control-sm"
    placeholder="Optional: tell AI what to do (e.g., ‘summarize my notes, 2 sentences, no filler’)">
  <div class="form-text">
    Tip: Gina can type quick instructions here before clicking any <span class="fw-semibold">AI draft</span>.
  </div>
</div>
            {% if report.report_type == 'initial' %}
            <!-- Primary Care Provider / Family Doctor (Initial report only) -->
            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Primary Care Provider / Family Doctor</label>
              <input type="text"
                     name="primary_care_provider"
                     id="primary_care_provider_field"
                     class="form-control form-control-sm"
                     value="{{ (report.primary_care_provider if report.primary_care_provider is defined else '') or (claim.primary_care_provider if claim.primary_care_provider is defined else '') or '' }}">
              <div class="form-text">Initial report only (not shown on later reports).</div>
            </div>
            <!-- Diagnosis -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Diagnosis</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('initial_diagnosis', 'initial_diagnosis_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="initial_diagnosis"
                        id="initial_diagnosis_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_diagnosis or "" }}</textarea>
            </div>

            <!-- Mechanism of injury -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Mechanism of Injury</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('initial_mechanism_of_injury', 'initial_mechanism_of_injury_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="initial_mechanism_of_injury"
                        id="initial_mechanism_of_injury_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_mechanism_of_injury or "" }}</textarea>
            </div>

            <!-- Co-existing conditions -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Health and Lifestyle Overview</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('initial_coexisting_conditions', 'initial_coexisting_conditions_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="initial_coexisting_conditions"
                        id="initial_coexisting_conditions_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_coexisting_conditions or "" }}</textarea>
            </div>

            <!-- Surgical history -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Surgical History</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('initial_surgical_history', 'initial_surgical_history_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="initial_surgical_history"
                        id="initial_surgical_history_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_surgical_history or "" }}</textarea>
            </div>

            <!-- Medications -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Medications</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('initial_medications', 'initial_medications_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="initial_medications"
                        id="initial_medications_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_medications or "" }}</textarea>
            </div>

            <!-- Diagnostics -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Diagnostics</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('initial_diagnostics', 'initial_diagnostics_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="initial_diagnostics"
                        id="initial_diagnostics_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.initial_diagnostics or "" }}</textarea>
            </div>

            <!-- Employment status (Initial only) -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Work and Employment Overview</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('employment_status', 'employment_status_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="employment_status"
                        id="employment_status_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.employment_status or "" }}</textarea>
            </div>
            {% endif %}

            {% if report.report_type != 'initial' %}
            <!-- Current status / treatment plan -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Current Status and Care Coordination</label>
                <div>
                  {% if report.report_type != 'initial' %}
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-action"
                          onclick="rollForwardField('status_treatment_plan', 'status_treatment_plan_field')">
                    Roll forward
                  </button>
                  {% endif %}
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('status_treatment_plan', 'status_treatment_plan_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="status_treatment_plan"
                        id="status_treatment_plan_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.status_treatment_plan or "" }}</textarea>
            </div>
            {% endif %}

            {% if report.report_type != 'initial' %}
            <!-- Work status -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Work Status</label>
                <div>
                  {% if report.report_type != 'initial' %}
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-action"
                          onclick="rollForwardField('work_status', 'work_status_field')">
                    Roll forward
                  </button>
                  {% endif %}
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('work_status', 'work_status_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="work_status"
                        id="work_status_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.work_status or "" }}</textarea>
            </div>
            {% endif %}


            {% if report.report_type != 'closure' and report.report_type != 'initial' %}
            <!-- Case management plan -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Case Management Plan</label>
                <div>
                  {% if report.report_type != 'initial' %}
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm btn-action"
                          onclick="rollForwardField('case_management_plan', 'case_management_plan_field')">
                    Roll forward
                  </button>
                  {% endif %}
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('case_management_plan', 'case_management_plan_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="case_management_plan"
                        id="case_management_plan_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.case_management_plan or "" }}</textarea>
            </div>
            {% endif %}
            {% if report.report_type == 'initial' %}

            <!-- Current status / treatment plan (Initial) -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Current Status and Care Coordination</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('status_treatment_plan', 'status_treatment_plan_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="status_treatment_plan"
                        id="status_treatment_plan_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.status_treatment_plan or "" }}</textarea>
            </div>

            <!-- Work status (Initial) -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Work Status</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('work_status', 'work_status_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="work_status"
                        id="work_status_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.work_status or "" }}</textarea>
            </div>

            <!-- Case management plan (Initial) -->
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Case Management Plan</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('case_management_plan', 'case_management_plan_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="case_management_plan"
                        id="case_management_plan_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.case_management_plan or "" }}</textarea>
            </div>

            {% endif %}
            </div>
          </div>
        </div>

        {% if report.report_type != 'closure' %}
        <!-- Barriers -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Possible Barriers to Recovery</h2>
          </div>
          <div class="card-body small scroll-area" style="max-height: 360px;">
            {% set selected_ids = selected_barrier_ids if selected_barrier_ids is defined else [] %}
            {% if barriers_by_category %}
              {% for category, options in barriers_by_category.items() %}
                {% set cat = category if category and category|trim else "Uncategorized" %}
                <div class="mb-2">
                  <div class="fw-semibold small">{{ cat }}</div>
                  {% for opt in options %}
                    <div class="form-check mb-1" style="position: relative;">
                      <input class="form-check-input js-accent-check"
                             type="checkbox"
                             name="barrier_ids"
                             id="barrier_{{ opt.id }}"
                             value="{{ opt.id }}"
                             {% if opt.id in selected_ids %}checked{% endif %}
                             style="position: relative; z-index: 5; pointer-events: auto; accent-color: var(--accent-color);">
                      <label class="form-check-label" for="barrier_{{ opt.id }}" style="position: relative; z-index: 5; pointer-events: auto; cursor: pointer;">
                        {{ opt.label }}
                      </label>
                    </div>
                  {% endfor %}
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted mb-0">No barrier options configured.</p>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% if report.report_type == 'closure' %}
        <!-- Closure-only fields (they can stay empty for Initial/Progress) -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Closure</h2>
          </div>
          <div class="card-body small">
            <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label form-label-sm mb-0">Closure Reason</label>
              <select name="closure_reason" class="form-select form-select-sm">
                <option value="">— Not closed —</option>
                {% set closure = report.closure_reason or "" %}
                {% for opt in [
                  "AMA",
                  "Death",
                  "MMI",
                  "RTW",
                  "RTW Modified Duty",
                  "RTW FULL DUTY",
                  "Task Fulfilled",
                  "Treatment Completed",
                  "Patient Non-compliance",
                  "Lack of Contact",
                  "Transferred care",
                  "Claim Closure"
                ] %}
                  <option value="{{ opt }}"
                          {% if closure == opt %}selected{% endif %}>
                    {{ opt }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Closure Details</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('closure_details', 'closure_details_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="closure_details"
                        id="closure_details_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.closure_details or "" }}</textarea>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label form-label-sm mb-0">Case Management Impact</label>
                <div>
                  <button type="button"
                          class="btn btn-outline-accent btn-sm btn-action"
                          onclick="aiDraftField('closure_case_management_impact', 'closure_case_management_impact_field')">
                    AI draft
                  </button>
                </div>
              </div>
              <textarea name="closure_case_management_impact"
                        id="closure_case_management_impact_field"
                        class="form-control form-control-sm"
                        rows="2">{{ report.closure_case_management_impact or "" }}</textarea>
            </div>
            </div>
          </div>
        </div>
        {% endif %}

        <!-- Report Documents -->
        <div class="row mb-3">
          <div class="col-lg-12">
            <div class="card shadow-sm">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="h6 mb-0">Report Documents</h2>
              </div>
              <div class="card-body small">
                {% if report.documents %}
                  <div class="table-responsive mb-3">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 40%">File Name</th>
                          <th style="width: 35%">Description</th>
                          <th style="width: 15%">Uploaded</th>
                          <th style="width: 10%" class="text-end">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for d in report.documents %}
                          <tr>
                            <td class="small">{{ d.original_filename or "(unnamed)" }}</td>
                            <td class="small">{{ d.description or "—" }}</td>
                            <td class="small">
                              {% if d.uploaded_at %}
                                {{ d.uploaded_at.strftime('%m/%d/%Y %I:%M %p') }}
                              {% else %}
                                —
                              {% endif %}
                            </td>
                            <td class="text-end">
                              <a href="{{ url_for('main.report_document_download', report_document_id=d.id) }}"
                                 class="btn btn-sm btn-outline-secondary me-1">
                                Download
                              </a>

                              <button
                                type="submit"
                                class="btn btn-sm btn-outline-danger"
                                formaction="{{ url_for('main.report_document_delete', report_document_id=d.id) }}"
                                formmethod="post"
                                onclick="return confirm('Delete this document? This cannot be undone.');"
                              >
                                Delete
                              </button>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted mb-3">No documents uploaded for this report yet.</p>
                {% endif %}

                <hr class="my-2">

                <div class="row g-2 align-items-end">
                  <div class="col-md-6">
                    <label class="form-label form-label-sm mb-0">Select File</label>
                    <input type="file" name="file" class="form-control form-control-sm">
                  </div>
                  <div class="col-12 mt-2">
                    <label class="form-label form-label-sm mb-0">Description (optional)</label>
                    <input type="text" name="description" class="form-control form-control-sm" placeholder="e.g., Clinic notes, imaging, correspondence">
                  </div>
                  <div class="col-md-2 text-end">
                    <button
                      type="submit"
                      class="btn btn-primary btn-sm w-100 mt-4 mt-md-2"
                      formaction="{{ url_for('main.report_document_upload', claim_id=claim.id, report_id=report.id) }}"
                      formmethod="post"
                      formenctype="multipart/form-data"
                    >
                      Upload
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>

      <!-- Right column: barriers + next appointment + actions -->
      <div class="col-lg-4 mb-3">


        <!-- Next appointment -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Next Appointment</h2>
          </div>
          <div class="card-body small">
            <div class="row g-2">

            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Notes</label>
              <input type="text"
                     id="initial_next_appt_notes"
                     name="initial_next_appt_notes"
                     class="form-control form-control-sm"
                     placeholder="e.g., Pending surgery scheduling / patient to call to confirm"
                     value="{{ report.initial_next_appt_notes if report.initial_next_appt_notes is defined and report.initial_next_appt_notes else '' }}">
            </div>

            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Date / Time</label>
              <input type="datetime-local"
                     id="initial_next_appt_datetime"
                     name="initial_next_appt_datetime"
                     class="form-control form-control-sm"
                     value="{% if report.initial_next_appt_datetime %}{{ report.initial_next_appt_datetime.strftime('%Y-%m-%dT%H:%M') }}{% endif %}">
            </div>

            <div class="col-12">
              <label class="form-label form-label-sm mb-0">Provider</label>
              <select
                id="initial_next_appt_provider_name"
                name="initial_next_appt_provider_name"
                class="form-select form-select-sm"
              >
                <option value="">— Select provider… —</option>

                {% if claim_providers is defined and claim_providers %}
                  {% for p in claim_providers %}
                    {% set _label = (p.organization if (p.organization is defined and p.organization) else p.name) %}
                    <option value="{{ _label }}"
                            {% if report.initial_next_appt_provider_name == _label %}selected{% endif %}>
                      {{ _label }}
                    </option>
                  {% endfor %}
                {% else %}
                  {% for p in providers %}
                    {% set _label = (p.organization if (p.organization is defined and p.organization) else p.name) %}
                    <option value="{{ _label }}"
                            {% if report.initial_next_appt_provider_name == _label %}selected{% endif %}>
                      {{ _label }}
                    </option>
                  {% endfor %}
                {% endif %}
              </select>
            </div>

            <div class="col-12 d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted">Generate a calendar event for this appointment.</small>
              <a href="#"
                 id="download_ics_btn"
                 class="btn btn-outline-secondary btn-sm{% if (not report.initial_next_appt_datetime) or (not report.initial_next_appt_provider_name) %} disabled{% endif %}"
                 aria-disabled="{% if (not report.initial_next_appt_datetime) or (not report.initial_next_appt_provider_name) %}true{% else %}false{% endif %}"
                 {% if (not report.initial_next_appt_datetime) or (not report.initial_next_appt_provider_name) %}tabindex="-1"{% endif %}>
                Download .ics
              </a>
            </div>

            </div>
          </div>
        </div>

        <!-- Billing / invoice actions -->
        <div class="card shadow-sm mb-3">
          <div class="card-header">
            <h2 class="h6 mb-0">Billing &amp; Invoice</h2>
          </div>
          <div class="card-body small d-flex flex-column gap-2">
            <p class="mb-1 text-muted">
              Create an invoice for this report using all uninvoiced, complete billable items
              within this report's date-of-service range.
            </p>
            <a href="{{ url_for('main.invoice_new_for_report', claim_id=claim.id, report_id=report.id) }}"
               class="btn btn-sm btn-outline-primary">
              Create Invoice for this Report
            </a>
          </div>
        </div>

        <!-- Save / cancel -->
        <div class="card shadow-sm">
          <div class="card-body d-flex justify-content-between align-items-center">
            <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
               class="btn btn-outline-secondary btn-sm">
              Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-sm">
              Save Changes
            </button>
          </div>
        </div>

    </div>
  </div>

  <!-- Bottom Save / Cancel (full-width) -->
  <div class="card shadow-sm mt-3">
    <div class="card-body d-flex justify-content-between align-items-center">
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
         class="btn btn-outline-secondary btn-sm">
        Cancel
      </a>
      <button type="submit" class="btn btn-primary btn-sm">
        Save Changes
      </button>
    </div>
  </div>

</div>

      </div>
    </div>
  </form>

<style>
  .btn-action {
    font-size: .75rem;
    padding: .18rem .55rem;
    line-height: 1.2;
    border-radius: 999px;
  }
  .btn-outline-accent {
    border-color: var(--accent-color);
    color: var(--accent-color);
    background: transparent;
  }
  .btn-outline-accent:hover,
  .btn-outline-accent:focus {
    background: var(--accent-color);
    color: #fff;
  }
</style>
</div>
<script>
  (function () {
    const baseUrl = "{{ url_for('main.report_roll_forward', claim_id=claim.id, report_id=report.id, field_name='__FIELD__') }}";
    const aiBaseUrl = "{{ url_for('main.report_ai_draft_field', claim_id=claim.id, report_id=report.id, field_name='__FIELD__') }}";

    function showNotice(message, level) {
      if (!message) return;

      // Remove any previous roll-forward notice.
      const existing = document.getElementById("rf-floating-alert");
      if (existing) existing.remove();
      // Remove any previous undo pill.
      const existingUndo = document.getElementById("ai-undo-pill");
      if (existingUndo) existingUndo.remove();

      // Build a lightweight floating alert.
      const el = document.createElement("div");
      el.id = "rf-floating-alert";
      el.setAttribute("role", "alert");

      const lvl = (level || "info").toLowerCase();
      const bsClass =
        lvl === "success" ? "alert-success" :
        lvl === "warning" ? "alert-warning" :
        lvl === "danger" ? "alert-danger" :
        "alert-info";

      el.className = "alert " + bsClass + " small";
      // Inline positioning so this works even if the global helper isn't available.
      el.style.position = "fixed";
      el.style.left = "50%";
      el.style.top = "20px";
      el.style.transform = "translateX(-50%)";
      el.style.zIndex = "9999";
      el.style.maxWidth = "min(720px, calc(100vw - 24px))";
      el.style.width = "fit-content";
      el.style.boxShadow = "0 10px 30px rgba(0,0,0,0.15)";

      el.textContent = message;
      document.body.appendChild(el);

      const lvl2 = (level || "info").toLowerCase();

      // Dismiss behavior:
      // - danger/warning: dismiss on first interaction (sticky)
      // - success/info: auto-dismiss quickly (less noisy)
      const dismiss = function () {
        const cur = document.getElementById("rf-floating-alert");
        if (cur) cur.remove();
        document.removeEventListener("mousedown", dismiss, true);
        document.removeEventListener("keydown", dismiss, true);
        document.removeEventListener("touchstart", dismiss, true);
      };

      if (lvl2 === "danger" || lvl2 === "warning") {
        document.addEventListener("mousedown", dismiss, true);
        document.addEventListener("touchstart", dismiss, true);
        document.addEventListener("keydown", dismiss, true);
      } else {
        window.setTimeout(dismiss, 2200);
      }
    }

    function showAiUndo(el, previousValue) {
      if (!el) return;

      // Remove any existing undo pill.
      const existingUndo = document.getElementById("ai-undo-pill");
      if (existingUndo) existingUndo.remove();

      const pill = document.createElement("div");
      pill.id = "ai-undo-pill";
      pill.style.position = "fixed";
      pill.style.left = "50%";
      pill.style.top = "62px";
      pill.style.transform = "translateX(-50%)";
      pill.style.zIndex = "9999";
      pill.style.maxWidth = "min(720px, calc(100vw - 24px))";
      pill.style.width = "fit-content";
      pill.style.boxShadow = "0 10px 30px rgba(0,0,0,0.15)";

      pill.className = "alert alert-secondary small";
      pill.style.padding = "6px 10px";
      pill.style.display = "flex";
      pill.style.alignItems = "center";
      pill.style.gap = "10px";

      const label = document.createElement("span");
      label.textContent = "AI draft inserted.";

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-sm btn-outline-secondary";
      btn.textContent = "Undo";
      btn.style.padding = ".15rem .55rem";
      btn.style.borderRadius = "999px";

      btn.addEventListener("click", function () {
        setFieldValue(el, previousValue);
        const cur = document.getElementById("ai-undo-pill");
        if (cur) cur.remove();
        showNotice("Restored previous text.", "success");
      });

      const hint = document.createElement("span");
      hint.className = "text-muted";
      hint.style.fontSize = ".8em";
      hint.textContent = "Tip: Ctrl+Z also works.";

      pill.appendChild(label);
      pill.appendChild(btn);
      pill.appendChild(hint);

      document.body.appendChild(pill);

      // Auto-dismiss after a bit.
      window.setTimeout(function () {
        const cur = document.getElementById("ai-undo-pill");
        if (cur) cur.remove();
      }, 8000);
    }

    function setFieldValue(el, value) {
      if (!el) return;

      const v = (value === null || value === undefined) ? "" : String(value);

      // Standard inputs / textarea
      if ("value" in el) {
        el.value = v;
      }

      // Fire events so any listeners (validation, enable/disable buttons, etc.) react.
      try {
        el.dispatchEvent(new Event("input", { bubbles: true }));
        el.dispatchEvent(new Event("change", { bubbles: true }));
      } catch (e) {
        // ignore
      }

      // Visual cue + scroll
      try {
        el.classList.add("is-invalid");
        setTimeout(function () {
          el.classList.remove("is-invalid");
        }, 800);
      } catch (e) {
        // ignore
      }

      try {
        el.scrollIntoView({ behavior: "smooth", block: "center" });
        el.focus({ preventScroll: true });
      } catch (e) {
        // ignore
      }
    }

    window.aiDraftField = function (fieldName, elementId) {
      const url = aiBaseUrl.replace("__FIELD__", fieldName);
      const el = document.getElementById(elementId);

      if (!el) {
        showNotice("AI draft failed: field not found on page.", "danger");
        return;
      }

      // Provide current field text + optional user instructions.
      const userPromptEl = document.getElementById("ai_user_prompt");
      const userPrompt = userPromptEl ? (userPromptEl.value || "").trim() : "";

      const payload = {
        current_text: (el.value || "")
      };

      if (userPrompt) {
        payload.user_prompt = userPrompt;
      }

      fetch(url, {
        method: "POST",
        headers: {
          "Accept": "application/json",
          "Content-Type": "application/json"
        },
        body: JSON.stringify(payload)
      })
        .then(function (response) {
          const ct = (response.headers.get("content-type") || "").toLowerCase();

          if (response.status === 403) {
            throw new Error("AI is disabled in Settings.");
          }
          if (!response.ok) {
            // Try to surface a JSON error message if present.
            return response.json().then(function (errData) {
              const msg = (errData && (errData.error || errData.message)) ? (errData.error || errData.message) : null;
              throw new Error(msg ? String(msg) : ("Request failed (" + response.status + ")"));
            }).catch(function () {
              throw new Error("Request failed (" + response.status + ")");
            });
          }
          if (ct.indexOf("application/json") === -1) {
            throw new Error("Unexpected response type");
          }
          return response.json();
        })
        .then(function (data) {
          // Preferred: server returns a generated draft.
          const draft = (data && (data.draft || data.text || data.completion))
            ? (data.draft || data.text || data.completion)
            : null;

          if (draft && String(draft).trim() !== "") {
            const prev = (el && (el.value || "")) ? String(el.value) : "";
            setFieldValue(el, String(draft));
            showNotice("AI draft inserted.", "success");

            // Provide a quick undo option (plus Ctrl+Z still works).
            showAiUndo(el, prev);

            // clear instructions
            if (userPromptEl) {
              userPromptEl.value = "";
            }

            return;
          }

          // Legacy/back-compat: server returns a prompt to paste into ChatGPT.
          // If we ever hit this path again, make it explicit so it doesn't confuse users.
          const prompt = (data && (data.prompt || data.system_prompt || data.user_prompt))
            ? (data.prompt || data.system_prompt || data.user_prompt)
            : null;

          if (prompt && String(prompt).trim() !== "") {
            if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(String(prompt))
                .then(function () {
                  showNotice("AI prompt copied to clipboard (legacy mode).", "success");
                })
                .catch(function () {
                  showNotice("AI prompt generated (legacy mode). Clipboard copy failed.", "warning");
                });
            } else {
              showNotice("AI prompt generated (legacy mode). Clipboard unavailable.", "warning");
            }
            return;
          }

          // If neither draft nor prompt exists, show any server-provided message.
          const msg = (data && (data.error || data.message)) ? (data.error || data.message) : null;
          if (msg) {
            showNotice(String(msg), "warning");
          } else {
            showNotice("AI draft returned nothing.", "warning");
          }
        })
        .catch(function (error) {
          console.error("AI draft failed:", error);
          const msg = (error && error.message) ? error.message : "AI draft failed. Try refreshing the page.";
          showNotice(msg, "danger");
        });
    };

    window.rollForwardField = function (fieldName, elementId) {
      const url = baseUrl.replace("__FIELD__", fieldName);
      const el = document.getElementById(elementId);

      if (!el) {
        showNotice("Roll forward failed: field not found on page.", "danger");
        return;
      }

      fetch(url, {
        method: "GET",
        headers: {
          "Accept": "application/json"
        }
      })
        .then(function (response) {
          // If we got redirected to HTML (login page, error page, etc.), JSON parsing will fail.
          const ct = (response.headers.get("content-type") || "").toLowerCase();
          if (!response.ok) {
            throw new Error("Request failed (" + response.status + ")");
          }
          if (ct.indexOf("application/json") === -1) {
            throw new Error("Unexpected response type");
          }
          return response.json();
        })
        .then(function (data) {
          // Backend returns: { value: <string|null> }
          if (!data || !("value" in data)) {
            showNotice("Nothing to roll forward.", "warning");
            return;
          }

          const v = data.value;
          if (v === null || v === undefined || String(v).trim() === "") {
            // Clear the field (explicitly) and notify.
            setFieldValue(el, "");
            showNotice("No prior value found for that field.", "warning");
            return;
          }

          setFieldValue(el, String(v));
          showNotice("Rolled forward from last report.", "success");
        })
        .catch(function (error) {
          console.error("Roll forward failed:", error);
          showNotice("Roll forward failed. Try refreshing the page.", "danger");
        });
    };

    // Enable/disable the ICS download button based on datetime field
    const dtInput = document.getElementById("initial_next_appt_datetime");
    const icsButton = document.getElementById("download_ics_btn");
    const providerSelect = document.getElementById("initial_next_appt_provider_name");
    const notesInput = document.getElementById("initial_next_appt_notes");

    function updateIcsButtonState() {
      if (!dtInput || !icsButton || !providerSelect) return;

      const hasDt = !!dtInput.value;
      const hasProvider = !!providerSelect.value;
      const shouldDisableIcs = !(hasDt && hasProvider);

      if (shouldDisableIcs) {
        icsButton.classList.add("disabled");
        icsButton.setAttribute("aria-disabled", "true");
        icsButton.setAttribute("tabindex", "-1");
      } else {
        icsButton.classList.remove("disabled");
        icsButton.setAttribute("aria-disabled", "false");
        icsButton.removeAttribute("tabindex");
      }
    }

    if (dtInput) {
      dtInput.addEventListener("input", updateIcsButtonState);
      dtInput.addEventListener("change", updateIcsButtonState);
    }
    if (providerSelect) {
      providerSelect.addEventListener("change", updateIcsButtonState);
    }

    updateIcsButtonState();

    function pad2(n) {
      return String(n).padStart(2, "0");
    }

    function icsEscape(text) {
      return String(text || "")
        .replace(/\\/g, "\\\\")
        .replace(/\r\n|\r|\n/g, "\\n")
        .replace(/,/g, "\\,")
        .replace(/;/g, "\\;");
    }

    function toIcsLocal(dt) {
      // Floating local time (no TZ) — works well for quick downloads.
      return (
        dt.getFullYear() +
        pad2(dt.getMonth() + 1) +
        pad2(dt.getDate()) +
        "T" +
        pad2(dt.getHours()) +
        pad2(dt.getMinutes()) +
        "00"
      );
    }

    function buildNextApptIcs() {
      if (!dtInput || !providerSelect) return null;
      if (!dtInput.value || !providerSelect.value) return null;

      const providerName = providerSelect.value;
      const notes = notesInput ? (notesInput.value || "").trim() : "";

      // dtInput is datetime-local => parse as local
      const dt = new Date(dtInput.value);
      if (isNaN(dt.getTime())) return null;

      // Default duration: 30 minutes
      const end = new Date(dt.getTime() + 30 * 60 * 1000);

      const dtstamp = new Date();
      const dtstampUtc =
        dtstamp.getUTCFullYear() +
        pad2(dtstamp.getUTCMonth() + 1) +
        pad2(dtstamp.getUTCDate()) +
        "T" +
        pad2(dtstamp.getUTCHours()) +
        pad2(dtstamp.getUTCMinutes()) +
        pad2(dtstamp.getUTCSeconds()) +
        "Z";

      const uid =
        "next-appt-" +
        Math.random().toString(36).slice(2) +
        "-" +
        Date.now().toString(36) +
        "@impactcms";

      const summary = "Next appointment: " + providerName;

      const descParts = [];
      descParts.push("Provider: " + providerName);
      if (notes) descParts.push("Notes: " + notes);

      const description = descParts.join("\n");

      const ics =
        "BEGIN:VCALENDAR\r\n" +
        "VERSION:2.0\r\n" +
        "PRODID:-//Impact CMS//Next Appointment//EN\r\n" +
        "CALSCALE:GREGORIAN\r\n" +
        "METHOD:PUBLISH\r\n" +
        "BEGIN:VEVENT\r\n" +
        "UID:" + icsEscape(uid) + "\r\n" +
        "DTSTAMP:" + dtstampUtc + "\r\n" +
        "DTSTART:" + toIcsLocal(dt) + "\r\n" +
        "DTEND:" + toIcsLocal(end) + "\r\n" +
        "SUMMARY:" + icsEscape(summary) + "\r\n" +
        "DESCRIPTION:" + icsEscape(description) + "\r\n" +
        "END:VEVENT\r\n" +
        "END:VCALENDAR\r\n";

      const ymd = dt.getFullYear() + pad2(dt.getMonth() + 1) + pad2(dt.getDate());
      const fname = "next-appointment-" + ymd + ".ics";

      return { ics, filename: fname };
    }

    if (icsButton) {
      icsButton.addEventListener("click", function (e) {
        const isDisabled =
          icsButton.classList.contains("disabled") ||
          icsButton.getAttribute("aria-disabled") === "true";

        if (isDisabled) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }

        // Generate from current form values (no save required)
        const built = buildNextApptIcs();
        if (!built) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }

        e.preventDefault();
        e.stopPropagation();

        try {
          const blob = new Blob([built.ics], { type: "text/calendar;charset=utf-8" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = built.filename;
          document.body.appendChild(a);
          a.click();
          a.remove();

          setTimeout(function () {
            try { URL.revokeObjectURL(url); } catch (err) {}
          }, 1500);
        } catch (err) {
          console.error("ICS download failed:", err);
        }
      });
    }
  })();
</script>
{% endblock %}