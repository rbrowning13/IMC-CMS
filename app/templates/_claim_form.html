<!-- _claim_form.html -->

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <label class="form-label form-label-sm">Claim Number</label>
    <input type="text" name="claim_number" class="form-control form-control-sm"
           value="{{ claim.claim_number if claim and claim.claim_number and claim.claim_number != 'None' else '' }}">
  </div>
  <div class="col-md-8">
    <label class="form-label form-label-sm">Claimant Name</label>
    <input type="text" name="claimant_name" class="form-control form-control-sm"
           value="{{ claim.claimant_name if claim and claim.claimant_name and claim.claimant_name != 'None' else '' }}">
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <label class="form-label form-label-sm">Date of Birth</label>
    <input
      type="text"
      name="dob"
      class="form-control form-control-sm"
      placeholder="MM/DD/YYYY"
      inputmode="numeric"
      data-auto-date="1"
      value="{{ claim.dob.strftime('%m/%d/%Y') if claim and claim.dob else '' }}"
    >
  </div>

  <div class="col-md-3">
    <label class="form-label form-label-sm">Date of Injury</label>
    <input
      type="text"
      name="doi"
      class="form-control form-control-sm"
      placeholder="MM/DD/YYYY"
      inputmode="numeric"
      data-auto-date="1"
      value="{{ claim.doi.strftime('%m/%d/%Y') if claim and claim.doi else '' }}"
    >
  </div>

  <div class="col-md-3">
    <label class="form-label form-label-sm">Claim State</label>
    <select name="claim_state" class="form-select form-select-sm">
      {{ state_options(claim.claim_state if claim else "ID") }}
    </select>
  </div>
</div>

<div class="row g-3 mb-3">

  <div class="col-md-8">
    <label class="form-label form-label-sm">Claimant Address</label>

    <input type="text" name="claimant_address1"
           class="form-control form-control-sm mb-1"
           placeholder="Address line 1"
           value="{{ claim.claimant_address1 if claim and claim.claimant_address1 and claim.claimant_address1 != 'None' else '' }}">

    <input type="text" name="claimant_address2"
           class="form-control form-control-sm"
           placeholder="Address line 2 (optional)"
           value="{{ claim.claimant_address2 if claim and claim.claimant_address2 and claim.claimant_address2 != 'None' else '' }}">
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">City / State / ZIP</label>
    <div class="d-flex gap-2">

      <input type="text" name="claimant_city"
             class="form-control form-control-sm"
             placeholder="City"
             value="{{ claim.claimant_city if claim and claim.claimant_city and claim.claimant_city != 'None' else '' }}">

      <select name="claimant_state" class="form-select form-select-sm" style="max-width: 90px;">
        {{ state_options(claim.claimant_state if claim else "ID") }}
      </select>

      <input type="text" name="claimant_postal_code"
             class="form-control form-control-sm"
             placeholder="ZIP"
             value="{{ claim.claimant_postal_code if claim and claim.claimant_postal_code and claim.claimant_postal_code != 'None' else '' }}">
    </div>
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">Claimant Phone</label>
    <input
      type="text"
      name="claimant_phone"
      class="form-control form-control-sm"
      placeholder="(555) 555-5555"
      inputmode="tel"
      data-auto-phone="1"
      value="{{ claim.claimant_phone if claim and claim.claimant_phone and claim.claimant_phone != 'None' else '' }}"
    >
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">Claimant Email</label>
    <input type="email" name="claimant_email" class="form-control form-control-sm"
           placeholder="name@example.com"
           value="{{ claim.claimant_email if claim and claim.claimant_email and claim.claimant_email != 'None' else '' }}">
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">Primary Care Provider</label>
    <input type="text" name="primary_care_provider" class="form-control form-control-sm"
           placeholder="PCP / treating physician"
           value="{{ claim.primary_care_provider if claim and claim.primary_care_provider and claim.primary_care_provider != 'None' else '' }}">
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <label class="form-label form-label-sm">Carrier</label>
    <select name="carrier_id" class="form-select form-select-sm" id="carrier_select">
      <option value="">Select carrier…</option>
      {% for c in carriers %}
        <option value="{{ c.id }}"
          {% if claim and claim.carrier_id == c.id %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label form-label-sm">Employer</label>
    <select
      name="employer_id"
      id="employer_select"
      class="form-select form-select-sm"
      {% if not claim or not claim.carrier_id %}disabled{% endif %}
    >
      <option value="">Select employer…</option>
      {% for e in employers %}
        <option
          value="{{ e.id }}"
          data-carrier-id="{{ e.carrier_id or '' }}"
          {% if claim and claim.employer_id == e.id %}selected{% endif %}
        >
          {{ e.name }}
        </option>
      {% endfor %}
    </select>
    <div class="form-text">
      Only employers linked to the selected carrier are shown.
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <label class="form-label form-label-sm">Carrier Contact (Adjuster)</label>

    <select name="carrier_contact_id"
            id="carrier_contact_select"
            class="form-select form-select-sm"
            {% if not claim or not claim.carrier_id %}disabled{% endif %}>

      <option value="">Select contact…</option>

      {% for c in carriers %}
        {% for contact in c.contacts %}
          <option value="{{ contact.id }}"
                  data-carrier-id="{{ c.id }}"
                  {% if claim and claim.carrier_contact_id == contact.id %}selected{% endif %}>
            {{ contact.name }}{% if contact.role %} – {{ contact.role }}{% endif %}
          </option>
        {% endfor %}
      {% endfor %}
    </select>

    <div class="form-text">
      Only contacts for the selected carrier will be shown.
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const carrierSelect = document.getElementById("carrier_select");
  const contactSelect = document.getElementById("carrier_contact_select");
  const employerSelect = document.getElementById("employer_select");

  if (!carrierSelect) {
    return;
  }

  // Save all original options for contacts and employers
  const allContactOptions = contactSelect ? Array.from(contactSelect.options) : [];
  const allEmployerOptions = employerSelect ? Array.from(employerSelect.options) : [];

  function rebuildSelect(selectEl, allOptions, filterFn, placeholderText, disableIfEmpty) {
    if (!selectEl) return;

    const previouslySelected = selectEl.value || "";

    // Clear current options
    selectEl.innerHTML = "";

    // Always add placeholder
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = placeholderText;
    selectEl.appendChild(placeholder);

    const filtered = allOptions.filter(filterFn);

    if (filtered.length === 0 && disableIfEmpty) {
      selectEl.disabled = true;
      return;
    }

    filtered.forEach(opt => {
      // Preserve the original selected value if it still exists
      if (opt.value === previouslySelected) {
        opt.selected = true;
      }
      selectEl.appendChild(opt);
    });

    selectEl.disabled = false;
  }

  function updateContacts() {
    if (!contactSelect) return;

    const carrierId = carrierSelect.value;

    if (!carrierId) {
      // No carrier selected: disable contacts and just show placeholder
      contactSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select contact…";
      contactSelect.appendChild(placeholder);
      contactSelect.disabled = true;
      return;
    }

    rebuildSelect(
      contactSelect,
      allContactOptions,
      opt => opt.dataset && opt.dataset.carrierId === carrierId,
      "Select contact…",
      true
    );
  }

  function updateEmployers() {
    if (!employerSelect) return;

    const carrierId = carrierSelect.value;

    if (!carrierId) {
      // No carrier selected: disable employers and just show placeholder
      employerSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select employer…";
      employerSelect.appendChild(placeholder);
      employerSelect.disabled = true;
      return;
    }

    rebuildSelect(
      employerSelect,
      allEmployerOptions,
      opt => opt.dataset && opt.dataset.carrierId === carrierId,
      "Select employer…",
      true
    );
  }

  carrierSelect.addEventListener("change", () => {
    updateContacts();
    updateEmployers();
  });

  // Run on page load (edit claim / initial page render)
  updateContacts();
  updateEmployers();
});
</script>