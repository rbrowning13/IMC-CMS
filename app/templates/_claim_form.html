<!-- _claim_form.html -->

<div class="row g-3 mb-3">
  <div class="col-md-4">
    <label class="form-label form-label-sm">Claim Number</label>
    <input type="text" name="claim_number" class="form-control form-control-sm"
           value="{{ claim.claim_number if claim and claim.claim_number and claim.claim_number != 'None' else '' }}">
  </div>
  <div class="col-md-8">
    <label class="form-label form-label-sm">Claimant Name</label>
    <input type="text" name="claimant_name" class="form-control form-control-sm"
           value="{{ claim.claimant_name if claim and claim.claimant_name and claim.claimant_name != 'None' else '' }}">
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <label class="form-label form-label-sm">Date of Birth</label>
    <input type="date" name="dob" class="form-control form-control-sm"
           value="{{ claim.dob.strftime('%Y-%m-%d') if claim and claim.dob else '' }}">
  </div>

  <div class="col-md-3">
    <label class="form-label form-label-sm">Date of Injury</label>
    <input type="date" name="doi" class="form-control form-control-sm"
           value="{{ claim.doi.strftime('%Y-%m-%d') if claim and claim.doi else '' }}">
  </div>

  <div class="col-md-3">
    <label class="form-label form-label-sm">Claim State</label>
    <select name="claim_state" class="form-select form-select-sm">
      {{ state_options(claim.claim_state if claim else "ID") }}
    </select>
  </div>
</div>

<div class="row g-3 mb-3">

  <div class="col-md-8">
    <label class="form-label form-label-sm">Claimant Address</label>

    <input type="text" name="claimant_address1"
           class="form-control form-control-sm mb-1"
           placeholder="Address line 1"
           value="{{ claim.claimant_address1 if claim and claim.claimant_address1 and claim.claimant_address1 != 'None' else '' }}">

    <input type="text" name="claimant_address2"
           class="form-control form-control-sm"
           placeholder="Address line 2 (optional)"
           value="{{ claim.claimant_address2 if claim and claim.claimant_address2 and claim.claimant_address2 != 'None' else '' }}">
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">City / State / ZIP</label>
    <div class="d-flex gap-2">

      <input type="text" name="claimant_city"
             class="form-control form-control-sm"
             placeholder="City"
             value="{{ claim.claimant_city if claim and claim.claimant_city and claim.claimant_city != 'None' else '' }}">

      <select name="claimant_state" class="form-select form-select-sm" style="max-width: 90px;">
        {{ state_options(claim.claimant_state if claim else "ID") }}
      </select>

      <input type="text" name="claimant_postal_code"
             class="form-control form-control-sm"
             placeholder="ZIP"
             value="{{ claim.claimant_postal_code if claim and claim.claimant_postal_code and claim.claimant_postal_code != 'None' else '' }}">
    </div>
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">Claimant Phone</label>
    <input type="text" name="claimant_phone" class="form-control form-control-sm"
           placeholder="(555) 555-5555"
           value="{{ claim.claimant_phone if claim and claim.claimant_phone and claim.claimant_phone != 'None' else '' }}">
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">Claimant Email</label>
    <input type="email" name="claimant_email" class="form-control form-control-sm"
           placeholder="name@example.com"
           value="{{ claim.claimant_email if claim and claim.claimant_email and claim.claimant_email != 'None' else '' }}">
  </div>

  <div class="col-md-4">
    <label class="form-label form-label-sm">Primary Care Provider</label>
    <input type="text" name="primary_care_provider" class="form-control form-control-sm"
           placeholder="PCP / treating physician"
           value="{{ claim.primary_care_provider if claim and claim.primary_care_provider and claim.primary_care_provider != 'None' else '' }}">
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <label class="form-label form-label-sm">Carrier</label>
    <select name="carrier_id" class="form-select form-select-sm" id="carrier_select">
      <option value="">Select carrier…</option>
      {% for c in carriers %}
        <option value="{{ c.id }}"
          {% if claim and claim.carrier_id == c.id %}selected{% endif %}>
          {{ c.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-6">
    <label class="form-label form-label-sm">Employer</label>
    <select name="employer_id" class="form-select form-select-sm">
      <option value="">Select employer…</option>
      {% for e in employers %}
        <option value="{{ e.id }}"
          {% if claim and claim.employer_id == e.id %}selected{% endif %}>
          {{ e.name }}
        </option>
      {% endfor %}
    </select>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-6">
    <label class="form-label form-label-sm">Carrier Contact (Adjuster)</label>

    <select name="carrier_contact_id"
            id="carrier_contact_select"
            class="form-select form-select-sm"
            {% if not claim or not claim.carrier_id %}disabled{% endif %}>

      <option value="">Select contact…</option>

      {% for c in carriers %}
        {% for contact in c.contacts %}
          <option value="{{ contact.id }}"
                  data-carrier-id="{{ c.id }}"
                  {% if claim and claim.carrier_contact_id == contact.id %}selected{% endif %}>
            {{ contact.name }}{% if contact.role %} – {{ contact.role }}{% endif %}
          </option>
        {% endfor %}
      {% endfor %}
    </select>

    <div class="form-text">
      Only contacts for the selected carrier will be shown.
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const carrierSelect = document.getElementById("carrier_select");
  const contactSelect = document.getElementById("carrier_contact_select");

  // Save all contact options
  const allOptions = Array.from(contactSelect.options);

  function updateContacts() {
    const carrierId = carrierSelect.value;

    // Clear current options
    contactSelect.innerHTML = "";

    // Always add placeholder
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Select contact…";
    contactSelect.appendChild(placeholder);

    if (!carrierId) {
      contactSelect.disabled = true;
      return;
    }

    // Add only contacts that match
    allOptions.forEach(opt => {
      if (opt.dataset.carrierId === carrierId) {
        contactSelect.appendChild(opt);
      }
    });

    contactSelect.disabled = false;
  }

  carrierSelect.addEventListener("change", updateContacts);

  // Run on page load (edit claim)
  updateContacts();
});
</script>