{% extends "base.html" %}
{% block title %}Provider {{ provider.name }} - Impact CMS{% endblock %}

{% block content %}
<div class="container-fluid">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">Provider: {{ provider.name }}</h1>
      <div class="text-muted small">
        {% if provider.city or provider.state %}
          {{ provider.city or '' }}{% if provider.city and provider.state %}, {% endif %}{{ provider.state or '' }}
        {% else %}
          No location on file
        {% endif %}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('main.providers_list') }}" class="btn btn-outline-secondary btn-sm">
        Back to Providers
      </a>
      <a href="{{ url_for('main.provider_edit', provider_id=provider.id) }}" class="btn btn-primary btn-sm">
        Edit
      </a>
      <form method="post"
            action="{{ url_for('main.provider_delete', provider_id=provider.id) }}"
            onsubmit="return confirm('Are you sure you want to delete this provider? This cannot be undone.') && confirm('Really delete this provider and all related contacts?');">
        <button type="submit" class="btn btn-outline-danger btn-sm">
          Delete
        </button>
      </form>
    </div>
  </div>

  <div class="row">
    <div class="col-12 mb-3">
      <!-- Provider summary -->
      <div class="card shadow-sm mb-3">
        <div class="card-header">
          <h2 class="h6 mb-0">Provider Info</h2>
        </div>
        <div class="card-body small">
          <dl class="row mb-0">
            <dt class="col-sm-4">Name</dt>
            <dd class="col-sm-8">{{ provider.name }}</dd>

            <dt class="col-sm-4">City</dt>
            <dd class="col-sm-8">{{ provider.city or "—" }}</dd>

            <dt class="col-sm-4">State</dt>
            <dd class="col-sm-8">{{ provider.state or "—" }}</dd>

            <dt class="col-sm-4">Postal Code</dt>
            <dd class="col-sm-8">{{ provider.postal_code or "—" }}</dd>

            <dt class="col-sm-4">Phone</dt>
            <dd class="col-sm-8">{{ provider.phone or "—" }}</dd>

            <dt class="col-sm-4">Fax</dt>
            <dd class="col-sm-8">{{ provider.fax or "—" }}</dd>

            <dt class="col-sm-4">Email</dt>
            <dd class="col-sm-8">
              {% if provider.email %}
                <a href="mailto:{{ provider.email }}">{{ provider.email }}</a>
              {% else %}
                —
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>

      <!-- Contacts -->
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Contacts</h2>
        </div>
        <div class="card-body small d-flex flex-column">
          {% if contacts %}
            <div class="table-responsive mb-3">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Phone</th>
                    <th>Fax</th>
                    <th>Email</th>
                    <th style="width: 30%;">Notes</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for contact in contacts %}
                    <tr>
                      <td>{{ contact.name }}</td>
                      <td>{{ contact.role or "—" }}</td>
                      <td>{{ contact.phone or "—" }}</td>
                      <td>{{ contact.fax or "—" }}</td>
                      <td>
                        {% if contact.email %}
                          <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td>
                        {% if contact.notes %}
                          <span class="text-muted text-truncate d-inline-block"
                                style="max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            {{ contact.notes }}
                          </span>
                        {% else %}
                          <span class="text-muted fst-italic">No notes</span>
                        {% endif %}
                      </td>
                      <td class="text-end">
                        <a href="{{ url_for('main.provider_detail', provider_id=provider.id, edit_contact_id=contact.id) }}"
                           class="btn btn-sm btn-outline-secondary me-1">
                          Edit
                        </a>
                        <form method="post"
                              action="{{ url_for('main.contact_delete', contact_id=contact.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this contact?') && confirm('This cannot be undone. Continue?');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="text-muted mb-3">
              No contacts yet for this provider.
            </p>
          {% endif %}

          <hr class="my-2">

          <!-- Add contact form -->
          <h3 class="h6 mt-2 mb-2">
            {% if edit_contact %}
              Edit Contact
            {% else %}
              Add Contact
            {% endif %}
          </h3>
          <form method="post"
                action="{% if edit_contact %}{{ url_for('main.contact_update', contact_id=edit_contact.id, parent_type='provider', parent_id=provider.id) }}{% else %}{{ url_for('main.contact_new', parent_type='provider', parent_id=provider.id) }}{% endif %}"
                class="row g-2">
            <div class="col-md-4">
              <label class="form-label form-label-sm mb-0">Name</label>
              <input type="text" name="name" class="form-control form-control-sm" required
                     value="{{ edit_contact.name if edit_contact else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-0">Role</label>
              <select name="role" class="form-select form-select-sm">
                <option value="">Select role...</option>
                {% for r in contact_roles %}
                  <option value="{{ r }}" {% if edit_contact and edit_contact.role == r %}selected{% endif %}>{{ r }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-0">Phone</label>
              <input type="text" name="phone" class="form-control form-control-sm"
                     value="{{ edit_contact.phone if edit_contact else '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label form-label-sm mb-0">Fax</label>
              <input type="text" name="fax" class="form-control form-control-sm"
                     value="{{ edit_contact.fax if edit_contact else '' }}">
            </div>
            <div class="col-md-5">
              <label class="form-label form-label-sm mb-0">Email</label>
              <input type="email" name="email" class="form-control form-control-sm"
                     value="{{ edit_contact.email if edit_contact else '' }}">
            </div>
            <div class="col-md-7">
              <label class="form-label form-label-sm mb-0">Notes</label>
              <textarea name="notes"
                class="form-control form-control-sm"
                rows="2"
                placeholder="Billing contact, scheduling, etc.">{{ edit_contact.notes if edit_contact else '' }}</textarea>
            </div>
            <div class="col-12 d-flex justify-content-end">
              {% if edit_contact %}
                <a href="{{ url_for('main.provider_detail', provider_id=provider.id) }}"
                   class="btn btn-sm btn-outline-secondary me-2">
                  Cancel
                </a>
                <button type="submit" class="btn btn-sm btn-primary">
                  Save Changes
                </button>
              {% else %}
                <button type="submit" class="btn btn-sm btn-primary">
                  Add Contact
                </button>
              {% endif %}
            </div>
          </form>

        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}