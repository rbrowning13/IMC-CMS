{% extends "base.html" %}
{% block title %}Claim {{ claim.claim_number }} - Impact CMS{% endblock %}

{% block content %}
{# Claimant display name: prefer structured fields; fallback to legacy claimant_name #}
{% set _fn = (claim.claimant_first_name if claim.claimant_first_name is defined and claim.claimant_first_name else '')|trim %}
{% set _ln = (claim.claimant_last_name if claim.claimant_last_name is defined and claim.claimant_last_name else '')|trim %}
{% if _ln and _fn %}
  {% set claimant_display = _ln ~ ', ' ~ _fn %}
{% elif _ln %}
  {% set claimant_display = _ln %}
{% elif _fn %}
  {% set claimant_display = _fn %}
{% else %}
  {% set claimant_display = (claim.claimant_name or '—') %}
{% endif %}
<div class="container-fluid">
  <style>

    #billables-table tr.billable-locked .btn {
      opacity: 0.55;
      pointer-events: none; /* belt + suspenders even though they're disabled */
    }
    #billables-table tr.billable-locked .badge {
      opacity: 0.9;
    }

    /* AI citation highlight color (prefer Settings accent_color; fallback to Bootstrap warning) */
    :root {
      --ai-highlight-color: {{
        (settings.accent_color
          if settings is defined and settings and settings.accent_color is defined and settings.accent_color
          else '#ffc107')
      }};
    }

    /* More-visible AI citation jump highlight (persistent until click/clear) */
    .ai-jump-highlight {
      outline: 4px solid var(--ai-highlight-color);
      outline-offset: 3px;
      box-shadow:
        0 0 0 8px color-mix(in srgb, var(--ai-highlight-color) 22%, transparent),
        0 0 28px color-mix(in srgb, var(--ai-highlight-color) 55%, transparent);
      background: color-mix(in srgb, var(--ai-highlight-color) 12%, transparent);
      border-radius: 6px;
      transition: none;
      animation: aiJumpPulse 850ms ease-in-out 1;
    }

    @keyframes aiJumpPulse {
      0% {
        outline-color: color-mix(in srgb, var(--ai-highlight-color) 0%, transparent);
        box-shadow: 0 0 0 0 transparent;
        background: transparent;
      }
      35% {
        outline-color: var(--ai-highlight-color);
        box-shadow:
          0 0 0 14px color-mix(in srgb, var(--ai-highlight-color) 28%, transparent),
          0 0 40px color-mix(in srgb, var(--ai-highlight-color) 70%, transparent);
        background: color-mix(in srgb, var(--ai-highlight-color) 16%, transparent);
      }
      100% {
        outline-color: var(--ai-highlight-color);
        box-shadow:
          0 0 0 8px color-mix(in srgb, var(--ai-highlight-color) 22%, transparent),
          0 0 28px color-mix(in srgb, var(--ai-highlight-color) 55%, transparent);
        background: color-mix(in srgb, var(--ai-highlight-color) 12%, transparent);
      }
    }
  </style>
  <!-- Header row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">
        Claim {{ claim.claim_number }}
      </h1>
      <div class="text-muted small">
        {{ claimant_display }}
        {% if employer %}
          · Employer: {{ employer.name }}
        {% endif %}
        {% if carrier %}
          · Carrier: {{ carrier.name }}
        {% endif %}
      </div>
    </div>

    <div class="text-end">
      <!-- Invoice state badge -->
      {% if open_invoice_count > 0 %}
        <span class="badge bg-warning text-dark mb-1">
          {{ open_invoice_count }} Open Invoice{{ 's' if open_invoice_count != 1 else '' }}
        </span>
      {% else %}
        <span class="badge bg-success mb-1">
          All Invoices Closed
        </span>
      {% endif %}
      <div class="d-flex gap-2 justify-content-end">
        <a href="{{ url_for('main.billing_list') }}" class="btn btn-outline-secondary btn-sm">
          Billing
        </a>
        <a href="{{ url_for('main.claims_list') }}" class="btn btn-outline-secondary btn-sm">
          All Claims
        </a>
        <a href="{{ url_for('main.claim_edit', claim_id=claim.id) }}"
           class="btn btn-outline-secondary btn-sm">
          Edit Claim
        </a>
        <a href="{{ url_for('main.claim_delete', claim_id=claim.id) }}"
           class="btn btn-outline-danger btn-sm">
          Delete Claim
        </a>
      </div>
    </div>
  </div>

  <!-- Claim AI Q&A (claim-scoped, safest-first) -->
  <div class="mb-3">
    <div class="card shadow-sm">
      <div class="card-body py-2">
        <form id="claim-ai-form" class="row g-2 align-items-center mb-0" autocomplete="off">
          <div class="col-12 col-lg-8">
            <label for="claim-ai-q" class="form-label form-label-sm mb-1">Ask about this claim</label>
            <input
              type="text"
              id="claim-ai-q"
              class="form-control form-control-sm"
              placeholder="e.g., When was the last appointment? What did I say in the initial report about the injury?"
              maxlength="300"
              required
            >
            <div class="form-text mb-0 text-muted">
              Answers include citations. Claimant identifiers (name, phone, email, address, claim #) are not searched.
              <span class="text-muted ms-2">Shortcuts: <strong>Enter</strong>=Ask, <strong>Esc</strong>=Clear.</span>
            </div>
          </div>
          <div class="col-12 col-lg-4 d-flex gap-2 align-items-end">
            <button type="submit" id="claim-ai-submit" class="btn btn-sm btn-outline-primary w-100">
              Ask
            </button>
            <button type="button" id="claim-ai-clear" class="btn btn-sm btn-outline-secondary" title="Clear">
              Clear
            </button>
          </div>
        </form>

        <div id="claim-ai-status" class="small text-muted mt-2" style="display:none;"></div>
        <div id="claim-ai-error" class="alert alert-danger py-2 mt-2 mb-0" style="display:none;"></div>
        <div id="claim-ai-result" class="mt-2" style="display:none;">
          <div class="border rounded p-2 bg-light">
            <div class="d-flex justify-content-between align-items-start gap-2 mb-1">
              <div class="d-flex align-items-center flex-wrap gap-2" id="claim-ai-meta" style="display:none;">
                <span class="badge bg-warning text-dark" id="claim-ai-guess-badge" style="display:none;">Best guess</span>
                <span class="d-inline-flex align-items-center gap-1">
                  <span class="badge bg-secondary"
                        id="claim-ai-confidence"
                        style="display:none;">
                  </span>
                  <button
                    type="button"
                    class="btn btn-link p-0 text-muted"
                    id="claim-ai-confidence-info"
                    aria-label="Confidence info"
                    title="What does confidence mean?"
                    style="line-height: 1; text-decoration: none;"
                  >
                    ⓘ
                  </button>
                  <span
                    class="small text-muted"
                    id="claim-ai-confidence-help"
                    style="display:none; max-width: 44rem;"
                  >
                    Confidence is based on citations and whether the answer required inference.
                  </span>
                </span>
                <span class="small text-muted" id="claim-ai-meta-text"></span>
              </div>
              <div class="d-flex gap-2">
                <button type="button" id="claim-ai-copy" class="btn btn-sm btn-outline-secondary" style="display:none;" title="Copy answer + citations">
                  Copy
                </button>
              </div>
            </div>

            <div class="small" id="claim-ai-answer" style="white-space: pre-wrap;"></div>
            <div class="small text-muted mt-2" id="claim-ai-citations"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Claim summary row -->
  <div class="row mb-3">
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm">
        <div class="card-header">
          <h2 class="h6 mb-0">Claim Summary</h2>
        </div>
        <div class="card-body small">
          {% set _is_closed = (claim.is_closed if claim.is_closed is defined else false) %}
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <dl class="row mb-0">
                <dt class="col-sm-5">Claimant</dt>
                <dd class="col-sm-7">{{ claimant_display }}</dd>

                <dt class="col-sm-5">Claim #</dt>
                <dd class="col-sm-7">{{ claim.claim_number }}</dd>

                <dt class="col-sm-5">DOB</dt>
                <dd class="col-sm-7">{{ claim.dob|format_date or "—" }}</dd>

                <dt class="col-sm-5">DOI</dt>
                <dd class="col-sm-7">{{ claim.doi|format_date or "—" }}</dd>

                <dt class="col-sm-5">Claim State</dt>
                <dd class="col-sm-7">{{ claim.claim_state or "—" }}</dd>

                <dt class="col-sm-5">Adjuster</dt>
                <dd class="col-sm-7">
                  {% if claim.carrier_contact %}
                    {{ claim.carrier_contact.name }}
                    {% if claim.carrier_contact.phone %}
                      {% set adj_ext = claim.carrier_contact.phone_ext or claim.carrier_contact.phone_extension or claim.carrier_contact.phone_extn %}
                      · {{ claim.carrier_contact.phone }}{% if adj_ext %} ext {{ adj_ext }}{% endif %}
                    {% endif %}
                    {% if claim.carrier_contact.email %}
                      · {{ claim.carrier_contact.email }}
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </dl>
            </div>

            <div class="col-12 col-lg-6">
              <dl class="row mb-0">
                <dt class="col-sm-5" id="anchor-claim-status">Status</dt>
                <dd class="col-sm-7">
                  {% if _is_closed %}
                    <span class="badge bg-secondary">Closed</span>
                  {% else %}
                    <span class="badge bg-primary">Open</span>
                  {% endif %}
                </dd>

                <dt class="col-sm-5">Address</dt>
                <dd class="col-sm-7">
                  {% if claim.claimant_address1 %}
                    {{ claim.claimant_address1 }}{% if claim.claimant_address2 %}, {{ claim.claimant_address2 }}{% endif %}<br>
                    {{ claim.claimant_city or '' }}{% if claim.claimant_state %}, {{ claim.claimant_state }}{% endif %} {{ claim.claimant_postal_code or '' }}
                  {% else %}
                    —
                  {% endif %}
                </dd>

                <dt class="col-sm-5">Phone</dt>
                <dd class="col-sm-7">
                  {% set claimant_ext = claim.claimant_phone_ext or claim.claimant_phone_extension or claim.claimant_ext %}
                  {% if claim.claimant_phone %}
                    {{ claim.claimant_phone }}{% if claimant_ext %} ext {{ claimant_ext }}{% endif %}
                  {% else %}
                    —
                  {% endif %}
                </dd>

                <dt class="col-sm-5">Email</dt>
                <dd class="col-sm-7">{{ claim.claimant_email or "—" }}</dd>

                <dt class="col-sm-5" id="anchor-claim-surgeries">Surgery Date(s)</dt>
                <dd class="col-sm-7">
                  {% set _surgeries = claim_surgeries if claim_surgeries is defined else [] %}

                  {% if _surgeries and _surgeries|length > 0 %}
                    {% for s in _surgeries %}
                      <div>
                        {% if s.surgery_date is defined and s.surgery_date %}
                          {{ s.surgery_date|format_date }}
                        {% else %}
                          —
                        {% endif %}

                        {% if s.description is defined and s.description %}
                          <span class="text-muted">— {{ s.description }}</span>
                        {% endif %}
                      </div>
                    {% endfor %}
                  {% elif claim.surgery_date is defined and claim.surgery_date %}
                    {{ claim.surgery_date|format_date }}
                  {% else %}
                    —
                  {% endif %}
                </dd>

                <dt class="col-sm-5" id="anchor-claim-providers">Treating Providers</dt>
                <dd class="col-sm-7">
                  {% if claim_providers %}
                    {% set _labels = [] %}
                    {% for p in claim_providers %}
                      {% set _pname = (p.name if p.name is defined and p.name else '—') %}
                      {% if p.organization is defined and p.organization %}
                        {% set _labels = _labels + [p.organization ~ ' — ' ~ _pname] %}
                      {% else %}
                        {% set _labels = _labels + [_pname] %}
                      {% endif %}
                    {% endfor %}
                    {{ _labels | join(', ') }}
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Invoices for this claim -->
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Invoices for this Claim</h2>
          <a href="{{ url_for('main.invoice_new_for_claim', claim_id=claim.id) }}"
             class="btn btn-sm btn-primary">
            Create Invoice from Billable Items
          </a>
        </div>
        <div class="card-body small p-0">
          {% if invoices %}
            <div class="table-responsive">
              <table class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Status</th>
                    <th>DOS Range</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for inv in invoices %}
                    {% set status = inv.status or "Draft" %}
                    <tr id="invoice-row-{{ inv.id }}">
                      <td>
                        <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}">
                          {{ inv.invoice_number }}
                        </a>
                      </td>
                      <td>
                        {% if status == "Paid" %}
                          <span class="badge bg-success">Paid</span>
                        {% elif status == "Void" %}
                          <span class="badge bg-secondary">Void</span>
                        {% elif status == "Sent" %}
                          <span class="badge bg-info text-dark">Sent</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">Draft</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if inv.dos_start or inv.dos_end %}
                          {{ inv.dos_start|format_date or '—' }} &rarr; {{ inv.dos_end|format_date or '—' }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="text-end">
                        {# LOCKDOWN: always prefer canonical computed totals from inv.computed_financials.invoice_total #}
                        {% set _fin = (inv.computed_financials if inv.computed_financials is defined else none) %}
                        {% set _inv_total = none %}

                        {% if _fin %}
                          {% if _fin is mapping %}
                            {% set _inv_total = _fin.get('invoice_total') %}
                          {% else %}
                            {% if _fin.invoice_total is defined %}{% set _inv_total = _fin.invoice_total %}{% endif %}
                          {% endif %}
                        {% endif %}

                        {% if _inv_total is not none %}
                          ${{ "%.2f"|format(_inv_total or 0.0) }}
                        {% else %}
                          <span class="text-muted" title="Computed totals unavailable; showing stored invoice.total_amount.">
                            ${{ "%.2f"|format(inv.total_amount or 0.0) }}
                          </span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-3">
              <p class="text-muted mb-0">No invoices yet for this claim.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Accordions for Billable, Reports, Documents -->
  <div class="accordion" id="claimAccordion">

    <!-- Billable Items -->
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="billableHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#billableCollapse" aria-expanded="true"
                aria-controls="billableCollapse">
          Billable Items
        </button>
      </h2>
      <div id="billableCollapse" class="accordion-collapse collapse show"
           aria-labelledby="billableHeading">
        <div class="accordion-body">

          <!-- Existing items -->
          <div class="card shadow-sm mb-3">
            <div class="card-body p-0">
              {% if billable_items %}
                <div class="d-flex justify-content-between align-items-center px-3 pt-2 pb-1">
                  <div class="small text-muted">
                    Default sort: <strong>Entry date</strong> (newest first). Click a column header to sort by that column.
                  </div>
                </div>
                <div class="table-responsive" style="max-height: 28rem; min-height: 14rem; overflow-y: auto; resize: vertical;">
                  <table id="billables-table" class="table table-sm table-hover mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th class="sortable" data-sort-key="dos"><span>DOS</span> <span class="sort-indicator">
                            ↕
                          </span></th>
                        <th class="sortable" data-sort-key="activity"><span>Activity</span> <span class="sort-indicator">↕</span></th>
                        <th class="sortable text-end" data-sort-key="qty"><span>Qty</span> <span class="sort-indicator">↕</span></th>
                        <th>Units</th>
                        <th class="sortable" data-sort-key="description"><span>Description</span> <span class="sort-indicator">↕</span></th>
                        <th><span>Notes</span></th>
                        <th class="sortable" data-sort-key="invoice"><span>Invoice</span> <span class="sort-indicator">↕</span></th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in billable_items %}
                        {# Normalize code for consistent comparisons + display (db may store "Exp" etc.) #}
                        {% set code = ((item.activity_code or '')|upper) %}
                        {% if code == 'MIL' %}
                          {% set units = 'mi' %}
                        {% elif code == 'EXP' %}
                          {% set units = '$' %}
                        {% else %}
                          {% set units = 'hr' %}
                        {% endif %}
                        {# If the item is linked to an invoice that is not Draft, treat it as locked #}
                        {% set inv_row = invoice_map.get(item.invoice_id) if item.invoice_id else None %}
                        {% set inv_status = (inv_row.status if inv_row and inv_row.status else 'Draft') if item.invoice_id else 'Draft' %}
                        {% set is_locked = (item.invoice_id and inv_status != 'Draft') %}
                        {# Compute entry and DOS values for sorting (avoid undefined attribute() helper) #}
                        {% set entry_dt = none %}
                        {% if item.created_at is defined and item.created_at %}
                          {% set entry_dt = item.created_at %}
                        {% elif item.created is defined and item.created %}
                          {% set entry_dt = item.created %}
                        {% elif item.created_on is defined and item.created_on %}
                          {% set entry_dt = item.created_on %}
                        {% elif item.entered_at is defined and item.entered_at %}
                          {% set entry_dt = item.entered_at %}
                        {% elif item.entry_date is defined and item.entry_date %}
                          {% set entry_dt = item.entry_date %}
                        {% endif %}

                        {% set dos_dt = none %}
                        {% if item.service_date is defined and item.service_date %}
                          {% set dos_dt = item.service_date %}
                        {% elif item.date_of_service is defined and item.date_of_service %}
                          {% set dos_dt = item.date_of_service %}
                        {% elif item.dos is defined and item.dos %}
                          {% set dos_dt = item.dos %}
                        {% elif item.date is defined and item.date %}
                          {% set dos_dt = item.date %}
                        {% elif item.performed_on is defined and item.performed_on %}
                          {% set dos_dt = item.performed_on %}
                        {% elif item.service_dt is defined and item.service_dt %}
                          {% set dos_dt = item.service_dt %}
                        {% endif %}

                        {# Keys: prefer real date/datetime objects; fall back to digit-squash for strings #}
                        {% if entry_dt and entry_dt.strftime is defined %}
                          {% set entry_key = entry_dt.strftime('%Y%m%d%H%M%S') %}
                        {% else %}
                          {% set entry_key = (entry_dt|string)|replace('-', '')|replace('/', '')|replace(':', '')|replace(' ', '') %}
                        {% endif %}

                        {% if dos_dt and dos_dt.strftime is defined %}
                          {% set dos_key = dos_dt.strftime('%Y%m%d') %}
                        {% else %}
                          {% set dos_key = (dos_dt|string)|replace('-', '')|replace('/', '')|replace(':', '')|replace(' ', '') %}
                        {% endif %}
                        <tr id="billable-row-{{ item.id }}" class="{% if is_locked %}billable-locked{% endif %}" data-entry-key="{{ entry_key }}" data-dos-key="{{ dos_key }}">
                          <td>
                            {% if dos_dt %}
                              {% if dos_dt.strftime is defined %}
                                {{ dos_dt|format_date }}
                              {% else %}
                                {{ dos_dt }}
                              {% endif %}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>{{ code }}</td>
                          <td class="text-end">
                            {% if item.quantity is not none %}
                              {% if code == 'EXP' %}
                                {{ "%.2f"|format(item.quantity) }}
                              {% else %}
                                {{ "%.1f"|format(item.quantity) }}
                              {% endif %}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>{{ units }}</td>
                          <td style="max-width: 280px;">
                            {% if item.description %}
                              <span class="text-muted text-truncate d-inline-block"
                                    style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ item.description }}
                              </span>
                            {% else %}
                              <span class="text-muted fst-italic">No description</span>
                            {% endif %}
                          </td>
                          <td style="max-width: 280px;">
                            {% if item.notes %}
                              <div class="small text-muted" style="max-height: 6.5em; overflow: hidden;">
                                {{ item.notes }}
                              </div>
                            {% else %}
                              <span class="text-muted fst-italic">No notes</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if item.invoice_id %}
                              {% set inv = invoice_map.get(item.invoice_id) %}
                              {% if inv %}
                                <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}"
                                   class="badge bg-info text-dark text-decoration-none">
                                  {{ inv.invoice_number }} ({{ inv.status or 'Draft' }})
                                </a>
                              {% else %}
                                <span class="badge bg-secondary">Invoiced</span>
                              {% endif %}
                            {% else %}
                              <span class="badge bg-secondary">Not invoiced</span>
                            {% endif %}
                          </td>
                          <td class="text-end">
                            {% if is_locked %}
                              <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                      title="This billable item is locked because the invoice is {{ inv_status }}.">
                                Edit
                              </button>
                              <button type="button" class="btn btn-outline-danger btn-sm" disabled
                                      title="This billable item is locked because the invoice is {{ inv_status }}.">
                                Delete
                              </button>
                            {% else %}
                              <a href="{{ url_for('main.billable_edit', claim_id=claim.id, item_id=item.id) }}"
                                 class="btn btn-outline-secondary btn-sm">
                                Edit
                              </a>
                              <form method="post"
                                    action="{{ url_for('main.billable_delete', claim_id=claim.id, item_id=item.id) }}"
                                    class="d-inline"
                                    onsubmit="return confirm('Delete this item?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                  Delete
                                </button>
                              </form>
                            {% endif %}

                            <div class="small text-muted mt-1" style="white-space: nowrap;">
                              {% if entry_dt %}
                                Entered: {% if entry_dt.strftime is defined %}{{ entry_dt|format_date }}{% else %}{{ entry_dt }}{% endif %}
                              {% else %}
                                Entered: —
                              {% endif %}
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="p-3">
                  <p class="text-muted mb-0">No billable items yet.</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Add new billable item -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Add Billable Item</h3>
            </div>
            <div class="card-body small">
              <form method="post"
                    action="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
                    class="row g-2 align-items-end mb-0">
                <input type="hidden" name="form_type" value="billable_new">

                <!-- Date -->
                <div class="col-6 col-md-3">
                  <label for="service_date" class="form-label form-label-sm mb-1">Date</label>
                  <input type="text"
                         id="service_date"
                         name="service_date"
                         class="form-control form-control-sm js-date"
                         data-flatpickr="1"
                         inputmode="numeric"
                         maxlength="10"
                         placeholder="MM/DD/YYYY">
                </div>

                <!-- Activity -->
                <div class="col-6 col-md-3">
                  <label for="activity_code" class="form-label form-label-sm mb-1">Activity</label>
                  <select name="activity_code"
                          id="activity_code"
                          class="form-select form-select-sm"
                          required>
                    <option value="">Select activity…</option>
                    {% for code, label in billable_activity_choices %}
                      <option value="{{ code }}">{{ code }} – {{ label }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- Description -->
                <div class="col-12 col-md-4">
                  <label for="description" class="form-label form-label-sm mb-1">Description</label>
                  <input type="text"
                         id="description"
                         name="description"
                         class="form-control form-control-sm"
                         placeholder="e.g. CM – review records, phone calls…">
                </div>

                <!-- Quantity -->
                <div class="col-6 col-md-2">
                  <label for="quantity" class="form-label form-label-sm mb-1">Qty</label>
                  <input type="number"
                         step="0.1"
                         min="0"
                         id="quantity"
                         name="quantity"
                         class="form-control form-control-sm">
                </div>

                <!-- Notes and Submit button row -->
                <div class="col-12 col-md-10">
                  <label for="notes" class="form-label form-label-sm mb-1">Notes</label>
                  <textarea id="notes"
                            name="notes"
                            class="form-control form-control-sm"
                            rows="2"
                            placeholder="Optional detailed notes…"></textarea>
                </div>
                <div class="col-12 col-md-2 mt-2 mt-md-0 text-end">
                  <button type="submit" class="btn btn-primary btn-sm w-100 w-md-auto">
                    Add Item
                  </button>
                </div>
              </form>

              <p class="text-muted mt-2 mb-0 small">
                Mileage (MIL) is in miles; EXP is in dollars; all other codes are treated as hours.
                <br>
                <strong>NO&nbsp;BILL</strong> items are not invoiced, but they <em>do</em> appear in the CM Activities section of Reports for documentation and continuity.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>

    {# ------------------ REPORTS ------------------ #}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="reportsHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#reportsCollapse" aria-expanded="true"
                aria-controls="reportsCollapse">
          Reports
        </button>
      </h2>
      <div id="reportsCollapse" class="accordion-collapse collapse show"
           aria-labelledby="reportsHeading">
        <div class="accordion-body">

          <!-- Existing reports table -->
          <div class="card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h2 class="h6 mb-0">Reports</h2>

              <form method="post"
                    action="{{ url_for('main.claim_report_new', claim_id=claim.id) }}"
                    class="d-flex align-items-center gap-2 mb-0">
                <span class="small text-muted" style="white-space: nowrap;">New report:</span>
                <label for="report_type" class="visually-hidden">Report Type</label>
                <select id="report_type"
                        name="report_type"
                        class="form-select form-select-sm"
                        required>
                  <option value="">Select type…</option>
                  <option value="initial">Initial</option>
                  <option value="progress">Progress</option>
                  <option value="closure">Closure</option>
                </select>
                <button type="submit" class="btn btn-primary btn-sm">
                  New Report
                </button>
              </form>
            </div>
            <div class="card-body p-0">
              <table id="reports-table" class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 10%" class="sortable" data-sort-key="type"><span>Type</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 8%">Report #</th>
                    <th style="width: 22%" class="sortable" data-sort-key="dos"><span>DOS Range</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 18%" class="sortable" data-sort-key="next_appt"><span>Next Appointment</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 12%" class="sortable" data-sort-key="next_due"><span>Next Report</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 15%" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% if reports %}
                  {% for r in reports %}
                    <tr id="report-row-{{ r.id }}">
                      <td class="small" style="white-space: normal; word-break: break-word;">
                        {{ (r.report_type or "—")|capitalize }}
                      </td>
                      <td class="small">
                        {{ r.display_report_number if r.display_report_number is defined and r.display_report_number else '—' }}
                      </td>
                      <td class="small">
                        {% if r.dos_start or r.dos_end %}
                          {{ r.dos_start|format_date if r.dos_start else "?" }} – {{ r.dos_end|format_date if r.dos_end else "?" }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {% if r.initial_next_appt_datetime %}
                          {{ r.initial_next_appt_datetime.strftime('%m/%d/%Y %I:%M %p') }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {{ r.next_report_due|format_date or "—" }}
                      </td>
                      <td class="text-end">
                        <a href="{{ url_for('main.report_edit', claim_id=claim.id, report_id=r.id) }}"
                           class="btn btn-sm btn-primary me-1">
                          Edit
                        </a>

                        <form method="post"
                              action="{{ url_for('main.report_delete', claim_id=claim.id, report_id=r.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this report? This cannot be undone.');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-center text-muted small py-3">
                      No reports yet for this claim.
                    </td>
                  </tr>
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>


        </div>
      </div>
    </div>
    {# -------------- END REPORTS ------------------ #}

    <!-- Documents -->
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="documentsHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#documentsCollapse" aria-expanded="true"
                aria-controls="documentsCollapse">
          Documents
        </button>
      </h2>
      <div id="documentsCollapse" class="accordion-collapse collapse show"
           aria-labelledby="documentsHeading">
        <div class="accordion-body">

          <!-- List documents -->
          <div class="card shadow-sm mb-3">
            <div class="card-body p-0">
              {% if documents %}
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Uploaded</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>File</th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in documents %}
                        <tr>
                          <td>{{ d.uploaded_at|format_date or "—" }}</td>
                          <td>{{ d.doc_type or d.document_type or "—" }}</td>
                          <td style="max-width: 260px;">
                            {% if d.description %}
                              <span class="text-muted text-truncate d-inline-block"
                                    style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ d.description }}
                              </span>
                            {% else %}
                              <span class="text-muted fst-italic">No description</span>
                            {% endif %}
                          </td>
                          <td>
                            {%- set raw_name = d.original_filename or d.filename_original or "" -%}
                            {%- if raw_name %}
                              {%- set parts = raw_name.split("_", 1) -%}
                              {%- if parts|length == 2 and parts[0]|length == 8 -%}
                                {%- set display_name = parts[1] -%}
                              {%- else -%}
                                {%- set display_name = raw_name -%}
                              {%- endif -%}
                              <a href="{{ url_for('main.claim_document_download', claim_id=claim.id, doc_id=d.id) }}"
                                 target="_blank" rel="noopener"
                                 class="text-decoration-none">
                                {{ display_name }}
                              </a>
                            {%- else -%}
                              —
                            {%- endif -%}
                          </td>
<td class="text-end">
  <a href="{{ url_for('main.claim_document_download', claim_id=claim.id, doc_id=d.id, download=1) }}"
     class="btn btn-outline-secondary btn-sm">
    Download
  </a>

  <form method="post"
        action="{{ url_for('main.claim_document_delete', claim_id=claim.id, doc_id=d.id) }}"
        class="d-inline"
        onsubmit="return confirm('Delete this document? This cannot be undone.');">
    <button type="submit" class="btn btn-outline-danger btn-sm ms-1">
      Delete
    </button>
  </form>
</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="p-3">
                  <p class="text-muted mb-0">No documents uploaded yet.</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Upload document -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Upload Document</h3>
            </div>
            <div class="card-body small">
              <form method="post"
                    action="{{ url_for('main.claim_document_upload', claim_id=claim.id) }}"
                    enctype="multipart/form-data">
                <input type="hidden" name="form_type" value="document_upload">
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label for="doc_type" class="form-label form-label-sm mb-1">Type</label>
                    <input type="text"
                           id="doc_type"
                           name="doc_type"
                           class="form-control form-control-sm"
                           placeholder="e.g. Records, IME, Imaging, Form…">
                  </div>

                  <div class="col-md-5">
                    <label for="doc_description" class="form-label form-label-sm mb-1">Description</label>
                    <input type="text"
                           id="doc_description"
                           name="description"
                           class="form-control form-control-sm"
                           placeholder="Short description…">
                  </div>

                  <div class="col-md-4">
                    <label for="doc_file" class="form-label form-label-sm mb-1">File</label>
                    <input type="file"
                           id="doc_file"
                           name="file"
                           class="form-control form-control-sm"
                           required>
                  </div>

                  <div class="col-12 mt-2 text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                      Upload
                    </button>
                  </div>
                </div>
                <p class="text-muted mt-2 mb-0 small">
                  Allowed: pdf, doc, docx, rtf, txt, jpg, jpeg, png, mp4, mov, avi. Files are stored under your configured Documents Root on this computer.
                </p>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div> <!-- /accordion -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Claim AI Q&A (claim-scoped)
  (function wireClaimAI() {
    const form = document.getElementById('claim-ai-form');
    const qEl = document.getElementById('claim-ai-q');
    const btn = document.getElementById('claim-ai-submit');
    const clearBtn = document.getElementById('claim-ai-clear');

    const statusEl = document.getElementById('claim-ai-status');
    const errEl = document.getElementById('claim-ai-error');
    const resultEl = document.getElementById('claim-ai-result');
    const ansEl = document.getElementById('claim-ai-answer');
    const citEl = document.getElementById('claim-ai-citations');
    const metaEl = document.getElementById('claim-ai-meta');
    const guessBadgeEl = document.getElementById('claim-ai-guess-badge');
    const confidenceEl = document.getElementById('claim-ai-confidence');
    const metaTextEl = document.getElementById('claim-ai-meta-text');
    const copyBtn = document.getElementById('claim-ai-copy');
    const confidenceInfoBtn = document.getElementById('claim-ai-confidence-info');
    const confidenceHelpEl = document.getElementById('claim-ai-confidence-help');

    if (!form || !qEl || !btn) return;

    function setBusy(isBusy, msg) {
      if (btn) btn.disabled = !!isBusy;
      if (qEl) qEl.disabled = !!isBusy;
      if (statusEl) {
        statusEl.style.display = isBusy ? '' : 'none';
        statusEl.textContent = isBusy ? (msg || 'Working…') : '';
      }
    }

    function clearUI() {
      if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
      if (resultEl) resultEl.style.display = 'none';
      if (ansEl) ansEl.textContent = '';
      if (citEl) citEl.textContent = '';
      if (qEl) qEl.value = '';
      if (metaEl) metaEl.style.display = 'none';
      if (guessBadgeEl) guessBadgeEl.style.display = 'none';
      if (confidenceEl) { confidenceEl.style.display = 'none'; confidenceEl.textContent = ''; }
      if (copyBtn) copyBtn.style.display = 'none';
      if (metaTextEl) metaTextEl.textContent = '';
      if (confidenceHelpEl) confidenceHelpEl.style.display = 'none';
      if (typeof _clearAiJumpHighlight === 'function') { _clearAiJumpHighlight(); }
    }

    function setConfidence(level) {
      // level: 'low' | 'medium' | 'high'
      if (!confidenceEl) return;

      confidenceEl.style.display = '';
      confidenceEl.className = 'badge';

      if (level === 'high') {
        confidenceEl.textContent = 'High confidence';
        confidenceEl.classList.add('bg-success');
      } else if (level === 'medium') {
        confidenceEl.textContent = 'Medium confidence';
        confidenceEl.classList.add('bg-warning', 'text-dark');
      } else {
        confidenceEl.textContent = 'Low confidence';
        confidenceEl.classList.add('bg-danger');
      }
    }

    if (clearBtn) {
      clearBtn.addEventListener('click', function () { clearUI(); });
    }
    if (confidenceInfoBtn && confidenceHelpEl) {
      confidenceInfoBtn.addEventListener('click', function () {
        const isOpen = confidenceHelpEl.style.display !== 'none';
        confidenceHelpEl.style.display = isOpen ? 'none' : '';
      });
    }
    // Keyboard UX: Esc clears; Cmd/Ctrl+Enter submits (when focused in the question box)
document.addEventListener('keydown', function (ev) {
  if (ev.key === 'Escape') {
    clearUI();
    return;
  }

  const isCmdEnter = (ev.key === 'Enter') && (ev.metaKey || ev.ctrlKey);
  if (isCmdEnter) {
    if (document.activeElement === qEl) {
      ev.preventDefault();
      if (form.requestSubmit) {
        form.requestSubmit();
      } else {
        form.dispatchEvent(new Event('submit'));
      }
    }
  }
});

    form.addEventListener('submit', async function (ev) {
      ev.preventDefault();
      if (!qEl.value.trim()) return;

      // Client-side PHI guardrail (server should also enforce)
      const qLower = String(qEl.value || '').toLowerCase();
      const phiPatterns = [
        /\b(phone|telephone|cell|mobile)\b/i,
        /\b(address|street|mailing|zip|postal)\b/i,
        /\b(email|e-mail)\b/i,
        /\b(dob|date of birth|birthday)\b/i,
        /\bssn|social security\b/i
      ];
      const phiHit = phiPatterns.some(re => re.test(qLower));
      if (phiHit) {
        if (errEl) {
          errEl.style.display = '';
          errEl.textContent = 'Not available via AI. Use the Claim Summary for claimant contact info and identifiers.';
        }
        return;
      }

      // Reset UI
      if (errEl) { errEl.style.display = 'none'; errEl.textContent = ''; }
      if (resultEl) resultEl.style.display = 'none';
      if (metaEl) metaEl.style.display = 'none';
      if (guessBadgeEl) guessBadgeEl.style.display = 'none';
      if (confidenceEl) { confidenceEl.style.display = 'none'; confidenceEl.textContent = ''; }
      if (copyBtn) copyBtn.style.display = 'none';
      if (metaTextEl) metaTextEl.textContent = '';
      if (confidenceHelpEl) confidenceHelpEl.style.display = 'none';
      if (typeof _clearAiJumpHighlight === 'function') { _clearAiJumpHighlight(); }

      setBusy(true, 'Searching claim records…');

      try {
        const resp = await fetch("{{ url_for('main.claim_ai_query', claim_id=claim.id) }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: qEl.value.trim() })
        });

        if (!resp.ok) {
          const txt = await resp.text();
          throw new Error('Request failed (' + resp.status + '): ' + (txt || ''));
        }

        const data = await resp.json();
        const answer = (data && data.answer) ? String(data.answer) : '';
        const citations = (data && Array.isArray(data.citations)) ? data.citations : [];
        const isGuess = !!(data && data.is_guess);

        if (ansEl) {
          // Render as plain text but preserve newlines.
          ansEl.textContent = answer || 'No answer returned.';
        }

        if (metaEl) {
          metaEl.style.display = '';
        }
        if (guessBadgeEl) {
          guessBadgeEl.style.display = isGuess ? '' : 'none';
        }
        // Confidence indicator (simple + deterministic):
        // - High: has citations and not a guess
        // - Medium: has citations but marked guess
        // - Low: no citations
        const hasCitations = !!(citations && citations.length);
        if (!hasCitations) {
          setConfidence('low');
        } else if (isGuess) {
          setConfidence('medium');
        } else {
          setConfidence('high');
        }
        if (metaTextEl) {
          if (!hasCitations) {
            metaTextEl.textContent = 'No matching sources were found for this question.';
          } else if (isGuess) {
            metaTextEl.textContent = 'Verify using the citations below.';
          } else {
            metaTextEl.textContent = '';
          }
        }
        if (copyBtn) {
          copyBtn.style.display = '';
        }

function _maybeExpandAccordionFor(targetId) {
  // Expand Billables / Reports accordions if we’re about to jump into them.
  const billableCollapse = document.getElementById('billableCollapse');
  const reportsCollapse = document.getElementById('reportsCollapse');

  if (!targetId) return;

  // Billables rows look like "billable-row-123"
  if (targetId.startsWith('billable-row-') && billableCollapse && !billableCollapse.classList.contains('show')) {
    try {
      new bootstrap.Collapse(billableCollapse, { toggle: true });
    } catch (e) {
      billableCollapse.classList.add('show');
    }
  }

  // Report rows look like "report-row-51"
  if (targetId.startsWith('report-row-') && reportsCollapse && !reportsCollapse.classList.contains('show')) {
    try {
      new bootstrap.Collapse(reportsCollapse, { toggle: true });
    } catch (e) {
      reportsCollapse.classList.add('show');
    }
  }
}

let _aiHighlightedEl = null;

function _clearAiJumpHighlight() {
  if (_aiHighlightedEl) {
    try { _aiHighlightedEl.classList.remove('ai-jump-highlight'); } catch (e) {}
    _aiHighlightedEl = null;
  }
}

// Clear the persistent highlight on any click/tap anywhere.
document.addEventListener('click', function () {
  _clearAiJumpHighlight();
}, { capture: true });

function _scrollToId(targetId) {
  const el = document.getElementById(targetId);
  if (!el) return false;

  _maybeExpandAccordionFor(targetId);

  // Wait a tick in case collapse animation needs layout time
  setTimeout(() => {
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });

    // Persist highlight until click/clear/new ask
    _clearAiJumpHighlight();
    _aiHighlightedEl = el;

    // re-trigger animation if clicked twice
    el.classList.remove('ai-jump-highlight');
    void el.offsetWidth; // force reflow so animation restarts
    el.classList.add('ai-jump-highlight');
  }, 180);

  return true;
}

        function _targetForCitationId(cid) {
          const id = (cid || '').trim();
          if (!id) return null;

          // Claim-level anchors
          if (id === 'CLAIM.surgeries' || id === 'C.surgeries') return 'anchor-claim-surgeries';
          if (id === 'C.open_closed' || id === 'C.status' || id === 'CLAIM.status') return 'anchor-claim-status';
          if (id === 'C.providers' || id === 'CLAIM.providers') return 'anchor-claim-providers';

          // Report field sources like R51.status_plan
          const mR = id.match(/^R(\d+)(\.|$)/i);
          if (mR) return 'report-row-' + mR[1];

          // Billable sources like B123
          const mB = id.match(/^B(\d+)$/i);
          if (mB) return 'billable-row-' + mB[1];

          // Invoice sources like I45
          const mI = id.match(/^I(\d+)$/i);
          if (mI) return 'invoice-row-' + mI[1];

          return null;
        }

        function _renderCitations(citationsArr) {
          if (!citEl) return;
          citEl.innerHTML = '';

          if (!citationsArr || !citationsArr.length) {
            const none = document.createElement('span');
            none.textContent = 'No matching sources were found for this question.';
            citEl.appendChild(none);
            return;
          }

          const label = document.createElement('span');
          label.textContent = 'Citations: ';
          citEl.appendChild(label);

          citationsArr.forEach(function (c, idx) {
            const isStr = (typeof c === 'string');
            const cid = isStr ? '' : (c.id || c.ref || c.url || '');
            const lbl = isStr ? c : (c.label || c.title || ('Source ' + (idx + 1)));

            const pill = document.createElement('a');
            pill.href = '#';
            pill.className = 'badge rounded-pill bg-secondary text-light border text-decoration-none me-1';
            pill.textContent = '[' + (idx + 1) + '] ' + String(lbl);

            const targetId = _targetForCitationId(cid);
            if (targetId) {
              pill.title = 'Jump to source';
              pill.addEventListener('click', function (ev2) {
                ev2.preventDefault();
                _scrollToId(targetId);
              });
            } else {
              pill.title = (cid ? ('Source id: ' + cid) : 'Source');
              pill.addEventListener('click', function (ev2) { ev2.preventDefault(); });
            }

            citEl.appendChild(pill);
          });
        }

        if (copyBtn) {
          copyBtn.onclick = async function () {
            try {
              const lines = [];
              lines.push('Answer:');
              lines.push(answer || '');
              lines.push('');
              lines.push('Citations:');
              if (citations && citations.length) {
                citations.forEach((c, idx) => {
                  const cid = (typeof c === 'string') ? '' : (c.id || c.ref || '');
                  const lbl = (typeof c === 'string') ? c : (c.label || c.title || ('Source ' + (idx + 1)));
                  lines.push('[' + (idx + 1) + '] ' + String(lbl) + (cid ? (' (id: ' + cid + ')') : ''));
                });
              } else {
                lines.push('(none)');
              }
              await navigator.clipboard.writeText(lines.join('\n'));
              if (statusEl) {
                statusEl.style.display = '';
                statusEl.textContent = 'Copied.';
                setTimeout(() => {
                  statusEl.style.display = 'none';
                  statusEl.textContent = '';
                }, 900);
              }
            } catch (e2) {
              if (errEl) {
                errEl.style.display = '';
                errEl.textContent = 'Copy failed.';
              }
            }
          };
        }

        _renderCitations(citations);

        if (resultEl) resultEl.style.display = '';
      } catch (e) {
        if (errEl) {
          errEl.style.display = '';
          errEl.textContent = (e && e.message) ? e.message : String(e);
        }
      } finally {
        setBusy(false);
      }
    });
  })();
  // Persist Claim Detail accordion open/closed state per-claim
  (function persistAccordionState() {
    var accordion = document.getElementById('claimAccordion');
    if (!accordion) return;

    var storageKey = 'claimAccordionState_' + String({{ claim.id }});
    var saved = null;
    try {
      saved = JSON.parse(localStorage.getItem(storageKey) || 'null');
    } catch (e) {
      saved = null;
    }

    // Restore state only if we have saved data
    if (saved && typeof saved === 'object') {
      accordion.querySelectorAll('.accordion-collapse').forEach(function (el) {
        var id = el.id;
        if (!id) return;
        var shouldShow = !!saved[id];
        // Toggle via classes so we don't depend on bootstrap being loaded at this exact moment
        if (shouldShow) {
          el.classList.add('show');
        } else {
          el.classList.remove('show');
        }
      });
    }

    function saveState() {
      var state = {};
      accordion.querySelectorAll('.accordion-collapse').forEach(function (el) {
        if (!el.id) return;
        state[el.id] = el.classList.contains('show');
      });
      try {
        localStorage.setItem(storageKey, JSON.stringify(state));
      } catch (e) {}
    }

    // Bootstrap collapse events (if bootstrap is present)
    accordion.querySelectorAll('.accordion-collapse').forEach(function (el) {
      el.addEventListener('shown.bs.collapse', saveState);
      el.addEventListener('hidden.bs.collapse', saveState);
    });
  })();
  // Date auto-formatting for inputs with class .js-date-autofmt
  document.querySelectorAll('.js-date-autofmt').forEach(function (input) {
    input.addEventListener('input', function () {
      var digits = input.value.replace(/\D/g, '').slice(0, 8);
      var parts = [];

      if (digits.length > 4) {
        parts = [digits.slice(0, 2), digits.slice(2, 4), digits.slice(4)];
      } else if (digits.length > 2) {
        parts = [digits.slice(0, 2), digits.slice(2)];
      } else if (digits.length > 0) {
        parts = [digits];
      }

      input.value = parts.join('/');

      // Auto-tab when full date (MMDDYYYY) is entered
      if (digits.length === 8) {
        var form = input.form;
        if (form) {
          var elements = Array.from(form.elements);
          var idx = elements.indexOf(input);
          if (idx !== -1 && idx + 1 < elements.length) {
            var next = elements[idx + 1];
            if (next && typeof next.focus === 'function') {
              next.focus();
              if (typeof next.select === 'function') {
                next.select();
              }
            }
          }
        }
      }
    });
  });

  // Helpers to normalize date strings for sorting (MM/DD/YYYY -> YYYYMMDD, etc.)
  function dateTextToKey(txt) {
    if (!txt) return '';
    txt = txt.trim();
    if (!txt || txt === '—' || txt === '?') return '';
    var m = txt.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (!m) return txt.toLowerCase();
    var mm = m[1].padStart(2, '0');
    var dd = m[2].padStart(2, '0');
    var yyyy = m[3];
    return yyyy + mm + dd;
  }

  function dateTimeTextToKey(txt) {
    if (!txt) return '';
    txt = txt.trim();
    if (!txt || txt === '—') return '';
    // Expect "MM/DD/YYYY HH:MM AM"; fall back to date-only if needed
    var parts = txt.split(/\s+/);
    if (parts.length < 2) return dateTextToKey(txt);
    var dateKey = dateTextToKey(parts[0]);
    var timePart = parts[1] || '';
    var ampm = (parts[2] || '').toUpperCase();
    var tm = timePart.split(':');
    var hh = parseInt(tm[0] || '0', 10);
    var mm = parseInt(tm[1] || '0', 10);
    if (ampm === 'PM' && hh < 12) hh += 12;
    if (ampm === 'AM' && hh === 12) hh = 0;
    var hhStr = String(hh).padStart(2, '0');
    var mmStr = String(mm).padStart(2, '0');
    return dateKey + hhStr + mmStr;
  }

  // Generic tri-state sorter for a table
  function setupSortableTable(tableId, getValueForKey) {
    var table = document.getElementById(tableId);
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;

    function initOriginalOrder() {
      var rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach(function (row, index) {
        row.dataset.originalIndex = index;
      });
    }

    initOriginalOrder();

    table.querySelectorAll('th.sortable').forEach(function (th) {
      th.style.cursor = 'pointer';
      th.dataset.sortState = 'none'; // none | asc | desc
      th.addEventListener('click', function () {
        var key = th.getAttribute('data-sort-key');
        if (!key) return;

        var currentState = th.dataset.sortState || 'none';
        var newState = currentState === 'none' ? 'asc' : (currentState === 'asc' ? 'desc' : 'none');

        // Reset all headers in this table
        table.querySelectorAll('th.sortable').forEach(function (hdr) {
          hdr.classList.remove('sorted-asc', 'sorted-desc');
          hdr.dataset.sortState = 'none';
          var ind = hdr.querySelector('.sort-indicator');
          if (ind) ind.textContent = '↕';
        });

        var rows = Array.from(tbody.querySelectorAll('tr'));

        if (newState === 'none') {
          // Restore original order
          rows.sort(function (a, b) {
            var ia = parseInt(a.dataset.originalIndex || '0', 10);
            var ib = parseInt(b.dataset.originalIndex || '0', 10);
            return ia - ib;
          });
        } else {
          rows.sort(function (a, b) {
            var va = getValueForKey(a, key);
            var vb = getValueForKey(b, key);

            if (va === null || va === undefined) va = '';
            if (vb === null || vb === undefined) vb = '';

            if (typeof va === 'number' && typeof vb === 'number') {
              return newState === 'asc' ? (va - vb) : (vb - va);
            } else {
              va = String(va).toLowerCase();
              vb = String(vb).toLowerCase();
              if (va < vb) return newState === 'asc' ? -1 : 1;
              if (va > vb) return newState === 'asc' ? 1 : -1;
              return 0;
            }
          });
        }

        rows.forEach(function (row) {
          tbody.appendChild(row);
        });

        if (newState !== 'none') {
          th.dataset.sortState = newState;
          th.classList.add(newState === 'asc' ? 'sorted-asc' : 'sorted-desc');
          var indicator = th.querySelector('.sort-indicator');
          if (indicator) {
            indicator.textContent = newState === 'asc' ? '↑' : '↓';
          }
        }
      });
    });
  }

  // Billable Items table sorter
  setupSortableTable('billables-table', function (row, key) {
    var cells = row.children;
    if (!cells || cells.length === 0) return '';
    switch (key) {
      case 'dos': {
        // Sort by DOS (service date) using the hidden data-dos-key
        return row.dataset.dosKey || '';
      }
      case 'activity':
        return (cells[1].innerText || '').trim();
      case 'qty': {
        var txtQ = cells[2].innerText || '';
        var q = parseFloat(txtQ.replace(/[^\d.]/g, ''));
        return isNaN(q) ? 0 : q;
      }
      case 'description':
        return (cells[4].innerText || '').trim();
      case 'invoice':
        return (cells[6].innerText || '').trim();
      default:
        return '';
    }
  });

  // Default billables order: newest-entered first (without setting any "sorted" header state)
  (function defaultBillablesNewestFirst() {
    var table = document.getElementById('billables-table');
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;
    var rows = Array.from(tbody.querySelectorAll('tr'));
    if (!rows.length) return;

    rows.sort(function (a, b) {
      var ka = a.dataset.entryKey || '';
      var kb = b.dataset.entryKey || '';
      // Descending (newest first)
      if (ka < kb) return 1;
      if (ka > kb) return -1;
      var ia = parseInt(a.dataset.originalIndex || '0', 10);
      var ib = parseInt(b.dataset.originalIndex || '0', 10);
      return ia - ib;
    });

    rows.forEach(function (r) { tbody.appendChild(r); });

    // Re-seed original order to this default so "none" state returns here
    rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach(function (row, index) {
      row.dataset.originalIndex = index;
    });
  })();

  // Reports table sorter
  setupSortableTable('reports-table', function (row, key) {
    var cells = row.children;
    if (!cells || cells.length === 0) return '';
    switch (key) {
      case 'type':
        return (cells[0].innerText || '').trim();
      case 'dos': {
        var txt = cells[2].innerText || '';
        var parts = txt.split('–');
        return dateTextToKey((parts[0] || '').trim());
      }
      case 'next_appt': {
        var txtA = cells[3].innerText || '';
        return dateTimeTextToKey(txtA);
      }
      case 'next_due': {
        var txtD = cells[4].innerText || '';
        return dateTextToKey(txtD);
      }
      default:
        return '';
    }
  });
});
</script>
{% endblock %}
