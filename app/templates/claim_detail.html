{% extends "base.html" %}
{% block title %}Claim {{ claim.claim_number }} - Impact CMS{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">
        Claim {{ claim.claim_number }}
      </h1>
      <a href="{{ url_for('main.claim_edit', claim_id=claim.id) }}"
   class="btn btn-sm btn-outline-secondary">
  Edit Claim
</a>
      <div class="text-muted small">
        {{ claim.claimant_name }}
        {% if employer %}
          · Employer: {{ employer.name }}
        {% endif %}
        {% if carrier %}
          · Carrier: {{ carrier.name }}
        {% endif %}
      </div>
    </div>

    <div class="text-end">
      <!-- Invoice state badge -->
      {% if open_invoice_count > 0 %}
        <span class="badge bg-warning text-dark mb-1">
          {{ open_invoice_count }} Open Invoice{{ 's' if open_invoice_count != 1 else '' }}
        </span>
      {% else %}
        <span class="badge bg-success mb-1">
          All Invoices Closed
        </span>
      {% endif %}
      <div class="d-flex gap-2 justify-content-end">
        <a href="{{ url_for('main.billing_list') }}" class="btn btn-outline-secondary btn-sm">
          Billing
        </a>
        <a href="{{ url_for('main.claims_list') }}" class="btn btn-outline-secondary btn-sm">
          All Claims
        </a>
        <a href="{{ url_for('main.claim_delete', claim_id=claim.id) }}"
           class="btn btn-outline-danger btn-sm">
          Delete Claim
        </a>
      </div>
    </div>
  </div>

  <!-- Claim summary row -->
  <div class="row mb-3">
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="h6 mb-0">Claim Summary</h2>
        </div>
        <div class="card-body small">
          <dl class="row mb-0">
            <dt class="col-sm-4">Claimant</dt>
            <dd class="col-sm-8">{{ claim.claimant_name }}</dd>

            <dt class="col-sm-4">Claim #</dt>
            <dd class="col-sm-8">{{ claim.claim_number }}</dd>

            <dt class="col-sm-4">DOB</dt>
            <dd class="col-sm-8">{{ claim.dob|format_date or "—" }}</dd>

            <dt class="col-sm-4">DOI</dt>
            <dd class="col-sm-8">{{ claim.doi|format_date or "—" }}</dd>

            <dt class="col-sm-4">Address</dt>
            <dd class="col-sm-8">
              {% if claim.claimant_address1 %}
                {{ claim.claimant_address1 }}{% if claim.claimant_address2 %}, {{ claim.claimant_address2 }}{% endif %}<br>
                {{ claim.claimant_city or '' }}{% if claim.claimant_state %}, {{ claim.claimant_state }}{% endif %} {{ claim.claimant_postal_code or '' }}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Phone</dt>
            <dd class="col-sm-8">{{ claim.claimant_phone or "—" }}</dd>

            <dt class="col-sm-4">Email</dt>
            <dd class="col-sm-8">{{ claim.claimant_email or "—" }}</dd>

            <dt class="col-sm-4">Primary Care</dt>
            <dd class="col-sm-8">{{ claim.primary_care_provider or "—" }}</dd>


            <dt class="col-sm-4">Claim State</dt>
            <dd class="col-sm-8">{{ claim.claim_state or "—" }}</dd>

            <dt class="col-sm-4">Adjuster</dt>
            <dd class="col-sm-8">
              {% if claim.carrier_contact %}
                {{ claim.carrier_contact.name }}
                {% if claim.carrier_contact.phone %}
                  · {{ claim.carrier_contact.phone }}
                {% endif %}
                {% if claim.carrier_contact.email %}
                  · {{ claim.carrier_contact.email }}
                {% endif %}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Telephonic?</dt>
            <dd class="col-sm-8">
              {% if claim.is_telephonic %}
                Yes
              {% else %}
                No
              {% endif %}
            </dd>
          </dl>
        </div>
      </div>
    </div>

    <!-- Invoices for this claim -->
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Invoices for this Claim</h2>
          <a href="{{ url_for('main.invoice_new_for_claim', claim_id=claim.id) }}"
             class="btn btn-sm btn-primary">
            Create Invoice from Billable Items
          </a>
        </div>
        <div class="card-body small p-0">
          {% if invoices %}
            <div class="table-responsive">
              <table class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Status</th>
                    <th>DOS Range</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for inv in invoices %}
                    {% set status = inv.status or "Draft" %}
                    <tr>
                      <td>
                        <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}">
                          {{ inv.invoice_number }}
                        </a>
                      </td>
                      <td>
                        {% if status == "Paid" %}
                          <span class="badge bg-success">Paid</span>
                        {% elif status == "Void" %}
                          <span class="badge bg-secondary">Void</span>
                        {% elif status == "Sent" %}
                          <span class="badge bg-info text-dark">Sent</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">Draft</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if inv.dos_start or inv.dos_end %}
                          {{ inv.dos_start|format_date or '—' }} &rarr; {{ inv.dos_end|format_date or '—' }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="text-end">
                        ${{ "%.2f"|format(inv.total_amount or 0.0) }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-3">
              <p class="text-muted mb-0">No invoices yet for this claim.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Accordions for Billable, Reports, Documents -->
  <div class="accordion" id="claimAccordion">

    <!-- Billable Items -->
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="billableHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#billableCollapse" aria-expanded="true"
                aria-controls="billableCollapse">
          Billable Items
        </button>
      </h2>
      <div id="billableCollapse" class="accordion-collapse collapse show"
           aria-labelledby="billableHeading" data-bs-parent="#claimAccordion">
        <div class="accordion-body">

          <!-- Existing items -->
          <div class="card shadow-sm mb-3">
            <div class="card-body p-0">
              {% if billable_items %}
                <div class="table-responsive">
                  <table class="table table-sm table-hover mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Date</th>
                        <th>Activity</th>
                        <th class="text-end">Qty</th>
                        <th>Units</th>
                        <th>Description</th>
                        <th>Invoice</th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in billable_items %}
                        {% set code = (item.activity_code or '') %}
                        {% if code == 'MIL' %}
                          {% set units = 'mi' %}
                        {% elif code == 'EXP' %}
                          {% set units = '$' %}
                        {% else %}
                          {% set units = 'hr' %}
                        {% endif %}
                        <tr>
                          <td>{{ item.date_of_service|format_date or '—' }}</td>
                          <td>{{ item.activity_code }}</td>
                          <td class="text-end">
                            {% if item.quantity is not none %}
                              {{ "%.1f"|format(item.quantity) }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>{{ units }}</td>
                          <td style="max-width: 280px;">
                            {% if item.description %}
                              <span class="text-muted text-truncate d-inline-block"
                                    style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ item.description }}
                              </span>
                            {% else %}
                              <span class="text-muted fst-italic">No description</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if item.invoice_id %}
                              {% set inv = invoice_map.get(item.invoice_id) %}
                              {% if inv %}
                                <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}"
                                   class="badge bg-info text-dark text-decoration-none">
                                  {{ inv.invoice_number }} ({{ inv.status or 'Draft' }})
                                </a>
                              {% else %}
                                <span class="badge bg-secondary">Invoiced</span>
                              {% endif %}
                            {% else %}
                              <span class="badge bg-secondary">Not invoiced</span>
                            {% endif %}
                          </td>
                          <td class="text-end">
                            <a href="{{ url_for('main.billable_edit', claim_id=claim.id, item_id=item.id) }}"
                               class="btn btn-outline-secondary btn-sm">
                              Edit
                            </a>
                            <form method="post"
                                  action="{{ url_for('main.billable_delete', claim_id=claim.id, item_id=item.id) }}"
                                  class="d-inline"
                                  onsubmit="return confirm('Delete this item?');">
                              <button type="submit" class="btn btn-outline-danger btn-sm">
                                Delete
                              </button>
                            </form>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="p-3">
                  <p class="text-muted mb-0">No billable items yet.</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Add new billable item -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Add Billable Item</h3>
            </div>
            <div class="card-body small">
              <form method="post" action="{{ url_for('main.claim_detail', claim_id=claim.id) }}">
                <input type="hidden" name="form_type" value="billable_new">

                <div class="row g-2 align-items-end">
                  <div class="col-6 col-md-3">
                    <label for="activity_code" class="form-label form-label-sm mb-1">Activity</label>
                    <!-- DROPDOWN restored instead of free-text -->
                    <select name="activity_code"
                            id="activity_code"
                            class="form-select form-select-sm"
                            required>
                      <option value="">Select activity…</option>
                      {% for code, label in billable_activity_choices %}
                        <option value="{{ code }}">{{ code }} – {{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="col-6 col-md-3">
                    <label for="service_date" class="form-label form-label-sm mb-1">Date</label>
                    <input type="date"
                           id="service_date"
                           name="service_date"
                           class="form-control form-control-sm">
                  </div>

                  <div class="col-6 col-md-2">
                    <label for="quantity" class="form-label form-label-sm mb-1">Qty</label>
                    <input type="number"
                           step="0.1"
                           min="0"
                           id="quantity"
                           name="quantity"
                           class="form-control form-control-sm">
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="description" class="form-label form-label-sm mb-1">Description</label>
                    <input type="text"
                           id="description"
                           name="description"
                           class="form-control form-control-sm"
                           placeholder="e.g. CM – review records, phone calls…">
                  </div>

                  <div class="col-12 mt-2 text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                      Add Item
                    </button>
                  </div>
                </div>
              </form>
              <p class="text-muted mt-2 mb-0 small">
                Mileage (MIL) is in miles; EXP is in dollars; all other codes are treated as hours.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>

    {# ------------------ REPORTS ------------------ #}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="reportsHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#reportsCollapse" aria-expanded="true"
                aria-controls="reportsCollapse">
          Reports
        </button>
      </h2>
      <div id="reportsCollapse" class="accordion-collapse collapse show"
           aria-labelledby="reportsHeading" data-bs-parent="#claimAccordion">
        <div class="accordion-body">

          <!-- Existing reports table -->
          <div class="card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h2 class="h6 mb-0">Reports</h2>
            </div>
            <div class="card-body p-0">
              <table class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 16%">Type</th>
                    <th style="width: 24%">DOS Range</th>
                    <th style="width: 20%">Treating Provider</th>
                    <th style="width: 20%">Next Appointment</th>
                    <th style="width: 15%">Next Report Due</th>
                    <th style="width: 15%" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% if reports %}
                  {% for r in reports %}
                    <tr>
                      <td class="small">
                        {{ (r.report_type or "—")|capitalize }}
                      </td>
                      <td class="small">
                        {% if r.dos_start or r.dos_end %}
                          {{ r.dos_start|format_date if r.dos_start else "?" }} – {{ r.dos_end|format_date if r.dos_end else "?" }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {% if r.treating_provider %}
                          {{ r.treating_provider.name }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {% if r.initial_next_appt_datetime %}
                          {{ r.initial_next_appt_datetime.strftime('%m/%d/%Y %I:%M %p') }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {{ r.next_report_due|format_date or "—" }}
                      </td>
                      <td class="text-end">
                        <a href="{{ url_for('main.report_edit', claim_id=claim.id, report_id=r.id) }}"
                           class="btn btn-sm btn-primary me-1">
                          Edit
                        </a>

                        <form method="post"
                              action="{{ url_for('main.report_delete', claim_id=claim.id, report_id=r.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this report? This cannot be undone.');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-center text-muted small py-3">
                      No reports yet for this claim.
                    </td>
                  </tr>
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>

          <!-- New report form -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Add Report</h3>
            </div>
            <div class="card-body small" id="report-new-form">
              <form method="post"
                    action="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
                    class="row g-2 align-items-end mb-0">
                <input type="hidden" name="form_type" value="report_new">

                <div class="col-auto">
                  <label for="report_type" class="form-label form-label-sm mb-1">Report Type</label>
                  <select id="report_type"
                          name="report_type"
                          class="form-select form-select-sm"
                          required>
                    <option value="">Select type…</option>
                    <option value="initial">Initial</option>
                    <option value="progress">Progress</option>
                    <option value="closure">Closure</option>
                  </select>
                </div>

                <div class="col-auto">
                  <button type="submit" class="btn btn-primary btn-sm mt-4">
                    New Report
                  </button>
                </div>
              </form>
              <p class="text-muted small mt-2 mb-0">
                After selecting a type, you&#39;ll complete dates, status, barriers, and other details on the report screen.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>
    {# -------------- END REPORTS ------------------ #}

    <!-- Documents -->
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="documentsHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#documentsCollapse" aria-expanded="true"
                aria-controls="documentsCollapse">
          Documents
        </button>
      </h2>
      <div id="documentsCollapse" class="accordion-collapse collapse show"
           aria-labelledby="documentsHeading" data-bs-parent="#claimAccordion">
        <div class="accordion-body">

          <!-- List documents -->
          <div class="card shadow-sm mb-3">
            <div class="card-body p-0">
              {% if documents %}
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Uploaded</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>File</th>
                        <th></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in documents %}
                        <tr>
                          <td>{{ d.uploaded_at|format_date or "—" }}</td>
                          <td>{{ d.doc_type or d.document_type or "—" }}</td>
                          <td style="max-width: 260px;">
                            {% if d.description %}
                              <span class="text-muted text-truncate d-inline-block"
                                    style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ d.description }}
                              </span>
                            {% else %}
                              <span class="text-muted fst-italic">No description</span>
                            {% endif %}
                          </td>
                          <td>
                            {{ d.original_filename or d.filename_original or "—" }}
                          </td>
<td class="text-end">
  <a href="{{ url_for('main.document_download', claim_id=claim.id, doc_id=d.id) }}"
     class="btn btn-outline-secondary btn-sm">
    Open
  </a>

  <form method="post"
        action="{{ url_for('main.document_open_location', claim_id=claim.id, doc_id=d.id) }}"
        class="d-inline ms-1">
    <button type="submit" class="btn btn-outline-secondary btn-sm">
      Open Location
    </button>
  </form>

  <form method="post"
        action="{{ url_for('main.document_delete', claim_id=claim.id, doc_id=d.id) }}"
        class="d-inline"
        onsubmit="return confirm('Delete this document? This cannot be undone.');">
    <button type="submit" class="btn btn-outline-danger btn-sm ms-1">
      Delete
    </button>
  </form>
</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="p-3">
                  <p class="text-muted mb-0">No documents uploaded yet.</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Upload document -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Upload Document</h3>
            </div>
            <div class="card-body small">
              <form method="post"
                    action="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
                    enctype="multipart/form-data">
                <input type="hidden" name="form_type" value="document_upload">
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label for="doc_type" class="form-label form-label-sm mb-1">Type</label>
                    <input type="text"
                           id="doc_type"
                           name="doc_type"
                           class="form-control form-control-sm"
                           placeholder="e.g. Records, IME, Imaging, Form…">
                  </div>

                  <div class="col-md-5">
                    <label for="doc_description" class="form-label form-label-sm mb-1">Description</label>
                    <input type="text"
                           id="doc_description"
                           name="description"
                           class="form-control form-control-sm"
                           placeholder="Short description…">
                  </div>

                  <div class="col-md-4">
                    <label for="doc_file" class="form-label form-label-sm mb-1">File</label>
                    <input type="file"
                           id="doc_file"
                           name="file"
                           class="form-control form-control-sm"
                           required>
                  </div>

                  <div class="col-12 mt-2 text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                      Upload
                    </button>
                  </div>
                </div>
                <p class="text-muted mt-2 mb-0 small">
                  Allowed: pdf, doc, docx, rtf, txt, jpg, jpeg, png, mp4, mov, avi.
                </p>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div> <!-- /accordion -->
</div>

{% endblock %}