{% extends "base.html" %}
{% block title %}Claim {{ claim.claim_number }} - Impact CMS{% endblock %}

{% block content %}
<div class="container-fluid">
  <style>
    /* Subtle zebra striping for billables table (like Excel alternating rows)
       Use Bootstrap table CSS variables so it persists (not just on hover). */
    #billables-table tbody tr:nth-child(even):not(.billable-locked) {
      --bs-table-bg: #fafafa;
    }

    /* Billable items linked to non-Draft invoices should look locked */
    #billables-table tr.billable-locked {
      --bs-table-bg: #f2f2f2;
      --bs-table-color: #666;
      background: #f2f2f2 !important;
      color: #666;
    }
    /* Ensure cell backgrounds also follow the row background (Bootstrap can override) */
    #billables-table tr.billable-locked > * {
      background-color: #f2f2f2 !important;
      border-color: rgba(0, 0, 0, 0.12);
    }

    /* If table-hover is enabled, keep locked rows from changing color on hover */
    #billables-table.table-hover tbody tr.billable-locked:hover {
      background: #f2f2f2 !important;
    }
    #billables-table.table-hover tbody tr.billable-locked:hover > * {
      background-color: #f2f2f2 !important;
    }

    #billables-table tr.billable-locked .btn {
      opacity: 0.55;
      pointer-events: none; /* belt + suspenders even though they're disabled */
    }
    #billables-table tr.billable-locked .badge {
      opacity: 0.9;
    }
  </style>
  <!-- Header row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h4 mb-0">
        Claim {{ claim.claim_number }}
      </h1>
      <div class="text-muted small">
        {{ claim.claimant_name }}
        {% if employer %}
          · Employer: {{ employer.name }}
        {% endif %}
        {% if carrier %}
          · Carrier: {{ carrier.name }}
        {% endif %}
      </div>
    </div>

    <div class="text-end">
      <!-- Invoice state badge -->
      {% if open_invoice_count > 0 %}
        <span class="badge bg-warning text-dark mb-1">
          {{ open_invoice_count }} Open Invoice{{ 's' if open_invoice_count != 1 else '' }}
        </span>
      {% else %}
        <span class="badge bg-success mb-1">
          All Invoices Closed
        </span>
      {% endif %}
      <div class="d-flex gap-2 justify-content-end">
        <a href="{{ url_for('main.billing_list') }}" class="btn btn-outline-secondary btn-sm">
          Billing
        </a>
        <a href="{{ url_for('main.claims_list') }}" class="btn btn-outline-secondary btn-sm">
          All Claims
        </a>
        <a href="{{ url_for('main.claim_edit', claim_id=claim.id) }}"
           class="btn btn-outline-secondary btn-sm">
          Edit Claim
        </a>
        <a href="{{ url_for('main.claim_delete', claim_id=claim.id) }}"
           class="btn btn-outline-danger btn-sm">
          Delete Claim
        </a>
      </div>
    </div>
  </div>

  <!-- Claim summary row -->
  <div class="row mb-3">
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header">
          <h2 class="h6 mb-0">Claim Summary</h2>
        </div>
        <div class="card-body small">
          <dl class="row mb-0">
            <dt class="col-sm-4">Claimant</dt>
            <dd class="col-sm-8">{{ claim.claimant_name }}</dd>

            <dt class="col-sm-4">Claim #</dt>
            <dd class="col-sm-8">{{ claim.claim_number }}</dd>

            <dt class="col-sm-4">DOB</dt>
            <dd class="col-sm-8">{{ claim.dob|format_date or "—" }}</dd>


            <dt class="col-sm-4">DOI</dt>
            <dd class="col-sm-8">{{ claim.doi|format_date or "—" }}</dd>

            <dt class="col-sm-4">Surgery Date</dt>
            <dd class="col-sm-8">
              {% if claim.surgery_date is defined %}
                {{ claim.surgery_date|format_date or "—" }}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Address</dt>
            <dd class="col-sm-8">
              {% if claim.claimant_address1 %}
                {{ claim.claimant_address1 }}{% if claim.claimant_address2 %}, {{ claim.claimant_address2 }}{% endif %}<br>
                {{ claim.claimant_city or '' }}{% if claim.claimant_state %}, {{ claim.claimant_state }}{% endif %} {{ claim.claimant_postal_code or '' }}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Phone</dt>
            <dd class="col-sm-8">
              {% set claimant_ext = claim.claimant_phone_ext or claim.claimant_phone_extension or claim.claimant_ext %}
              {% if claim.claimant_phone %}
                {{ claim.claimant_phone }}{% if claimant_ext %} ext {{ claimant_ext }}{% endif %}
              {% else %}
                —
              {% endif %}
            </dd>

            <dt class="col-sm-4">Email</dt>
            <dd class="col-sm-8">{{ claim.claimant_email or "—" }}</dd>



            <dt class="col-sm-4">Claim State</dt>
            <dd class="col-sm-8">{{ claim.claim_state or "—" }}</dd>

            <dt class="col-sm-4">Adjuster</dt>
            <dd class="col-sm-8">
              {% if claim.carrier_contact %}
                {{ claim.carrier_contact.name }}
                {% if claim.carrier_contact.phone %}
                  {% set adj_ext = claim.carrier_contact.phone_ext or claim.carrier_contact.phone_extension or claim.carrier_contact.phone_extn %}
                  · {{ claim.carrier_contact.phone }}{% if adj_ext %} ext {{ adj_ext }}{% endif %}
                {% endif %}
                {% if claim.carrier_contact.email %}
                  · {{ claim.carrier_contact.email }}
                {% endif %}
              {% else %}
                —
              {% endif %}
            </dd>

          </dl>
        </div>
      </div>
    </div>

    <!-- Invoices for this claim -->
    <div class="col-md-6 mb-3">
      <div class="card shadow-sm h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h6 mb-0">Invoices for this Claim</h2>
          <a href="{{ url_for('main.invoice_new_for_claim', claim_id=claim.id) }}"
             class="btn btn-sm btn-primary">
            Create Invoice from Billable Items
          </a>
        </div>
        <div class="card-body small p-0">
          {% if invoices %}
            <div class="table-responsive">
              <table class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Status</th>
                    <th>DOS Range</th>
                    <th class="text-end">Total</th>
                  </tr>
                </thead>
                <tbody>
                  {% for inv in invoices %}
                    {% set status = inv.status or "Draft" %}
                    <tr>
                      <td>
                        <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}">
                          {{ inv.invoice_number }}
                        </a>
                      </td>
                      <td>
                        {% if status == "Paid" %}
                          <span class="badge bg-success">Paid</span>
                        {% elif status == "Void" %}
                          <span class="badge bg-secondary">Void</span>
                        {% elif status == "Sent" %}
                          <span class="badge bg-info text-dark">Sent</span>
                        {% else %}
                          <span class="badge bg-warning text-dark">Draft</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if inv.dos_start or inv.dos_end %}
                          {{ inv.dos_start|format_date or '—' }} &rarr; {{ inv.dos_end|format_date or '—' }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="text-end">
                        ${{ "%.2f"|format(inv.total_amount or 0.0) }}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-3">
              <p class="text-muted mb-0">No invoices yet for this claim.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Accordions for Billable, Reports, Documents -->
  <div class="accordion" id="claimAccordion">

    <!-- Billable Items -->
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="billableHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#billableCollapse" aria-expanded="true"
                aria-controls="billableCollapse">
          Billable Items
        </button>
      </h2>
      <div id="billableCollapse" class="accordion-collapse collapse show"
           aria-labelledby="billableHeading" data-bs-parent="#claimAccordion">
        <div class="accordion-body">

          <!-- Existing items -->
          <div class="card shadow-sm mb-3">
            <div class="card-body p-0">
              {% if billable_items %}
                <div class="table-responsive" style="max-height: 14rem; overflow-y: auto;">
                  <table id="billables-table" class="table table-sm table-hover mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th class="sortable" data-sort-key="date"><span>Date</span> <span class="sort-indicator">
                            ↕
                          </span></th>
                        <th class="sortable" data-sort-key="activity"><span>Activity</span> <span class="sort-indicator">↕</span></th>
                        <th class="sortable text-end" data-sort-key="qty"><span>Qty</span> <span class="sort-indicator">↕</span></th>
                        <th>Units</th>
                        <th class="sortable" data-sort-key="description"><span>Description</span> <span class="sort-indicator">↕</span></th>
                        <th><span>Notes</span></th>
                        <th class="sortable" data-sort-key="invoice"><span>Invoice</span> <span class="sort-indicator">↕</span></th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in billable_items %}
                        {% set code = (item.activity_code or '') %}
                        {% if code == 'MIL' %}
                          {% set units = 'mi' %}
                        {% elif code == 'EXP' %}
                          {% set units = '$' %}
                        {% else %}
                          {% set units = 'hr' %}
                        {% endif %}
                        {# If the item is linked to an invoice that is not Draft, treat it as locked #}
                        {% set inv_row = invoice_map.get(item.invoice_id) if item.invoice_id else None %}
                        {% set inv_status = (inv_row.status if inv_row and inv_row.status else 'Draft') if item.invoice_id else 'Draft' %}
                        {% set is_locked = (item.invoice_id and inv_status != 'Draft') %}
                        <tr class="{% if is_locked %}billable-locked{% endif %}">
                          <td>
                            {% if item.date_of_service %}
                              {{ item.date_of_service.strftime('%m/%d/%Y') }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>{{ item.activity_code }}</td>
                          <td class="text-end">
                            {% if item.quantity is not none %}
                              {{ "%.1f"|format(item.quantity) }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td>{{ units }}</td>
                          <td style="max-width: 280px;">
                            {% if item.description %}
                              <span class="text-muted text-truncate d-inline-block"
                                    style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ item.description }}
                              </span>
                            {% else %}
                              <span class="text-muted fst-italic">No description</span>
                            {% endif %}
                          </td>
                          <td style="max-width: 280px;">
                            {% if item.notes %}
                              <div class="small text-muted" style="max-height: 6.5em; overflow: hidden;">
                                {{ item.notes }}
                              </div>
                            {% else %}
                              <span class="text-muted fst-italic">No notes</span>
                            {% endif %}
                          </td>
                          <td>
                            {% if item.invoice_id %}
                              {% set inv = invoice_map.get(item.invoice_id) %}
                              {% if inv %}
                                <a href="{{ url_for('main.invoice_detail', invoice_id=inv.id) }}"
                                   class="badge bg-info text-dark text-decoration-none">
                                  {{ inv.invoice_number }} ({{ inv.status or 'Draft' }})
                                </a>
                              {% else %}
                                <span class="badge bg-secondary">Invoiced</span>
                              {% endif %}
                            {% else %}
                              <span class="badge bg-secondary">Not invoiced</span>
                            {% endif %}
                          </td>
                          <td class="text-end">
                            {% if is_locked %}
                              <button type="button" class="btn btn-outline-secondary btn-sm" disabled
                                      title="This billable item is locked because the invoice is {{ inv_status }}.">
                                Edit
                              </button>
                              <button type="button" class="btn btn-outline-danger btn-sm" disabled
                                      title="This billable item is locked because the invoice is {{ inv_status }}.">
                                Delete
                              </button>
                            {% else %}
                              <a href="{{ url_for('main.billable_edit', claim_id=claim.id, item_id=item.id) }}"
                                 class="btn btn-outline-secondary btn-sm">
                                Edit
                              </a>
                              <form method="post"
                                    action="{{ url_for('main.billable_delete', claim_id=claim.id, item_id=item.id) }}"
                                    class="d-inline"
                                    onsubmit="return confirm('Delete this item?');">
                                <button type="submit" class="btn btn-outline-danger btn-sm">
                                  Delete
                                </button>
                              </form>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="p-3">
                  <p class="text-muted mb-0">No billable items yet.</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Add new billable item -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Add Billable Item</h3>
            </div>
            <div class="card-body small">
              <form method="post"
                    action="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
                    class="row g-2 align-items-end mb-0">
                <input type="hidden" name="form_type" value="billable_new">

                <!-- Date -->
                <div class="col-6 col-md-3">
                  <label for="service_date" class="form-label form-label-sm mb-1">Date</label>
                  <input type="text"
                         id="service_date"
                         name="service_date"
                         class="form-control form-control-sm js-date"
                         data-flatpickr="1"
                         inputmode="numeric"
                         maxlength="10"
                         placeholder="MM/DD/YYYY">
                </div>

                <!-- Activity -->
                <div class="col-6 col-md-3">
                  <label for="activity_code" class="form-label form-label-sm mb-1">Activity</label>
                  <select name="activity_code"
                          id="activity_code"
                          class="form-select form-select-sm"
                          required>
                    <option value="">Select activity…</option>
                    {% for code, label in billable_activity_choices %}
                      <option value="{{ code }}">{{ code }} – {{ label }}</option>
                    {% endfor %}
                  </select>
                </div>

                <!-- Description -->
                <div class="col-12 col-md-4">
                  <label for="description" class="form-label form-label-sm mb-1">Description</label>
                  <input type="text"
                         id="description"
                         name="description"
                         class="form-control form-control-sm"
                         placeholder="e.g. CM – review records, phone calls…">
                </div>

                <!-- Quantity -->
                <div class="col-6 col-md-2">
                  <label for="quantity" class="form-label form-label-sm mb-1">Qty</label>
                  <input type="number"
                         step="0.1"
                         min="0"
                         id="quantity"
                         name="quantity"
                         class="form-control form-control-sm">
                </div>

                <!-- Notes and Submit button row -->
                <div class="col-12 col-md-10">
                  <label for="notes" class="form-label form-label-sm mb-1">Notes</label>
                  <textarea id="notes"
                            name="notes"
                            class="form-control form-control-sm"
                            rows="2"
                            placeholder="Optional detailed notes…"></textarea>
                </div>
                <div class="col-12 col-md-2 mt-2 mt-md-0 text-end">
                  <button type="submit" class="btn btn-primary btn-sm w-100 w-md-auto">
                    Add Item
                  </button>
                </div>
              </form>

              <p class="text-muted mt-2 mb-0 small">
                Mileage (MIL) is in miles; EXP is in dollars; all other codes are treated as hours.
              </p>
            </div>
          </div>

        </div>
      </div>
    </div>

    {# ------------------ REPORTS ------------------ #}
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="reportsHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#reportsCollapse" aria-expanded="true"
                aria-controls="reportsCollapse">
          Reports
        </button>
      </h2>
      <div id="reportsCollapse" class="accordion-collapse collapse show"
           aria-labelledby="reportsHeading" data-bs-parent="#claimAccordion">
        <div class="accordion-body">

          <!-- Existing reports table -->
          <div class="card shadow-sm mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h2 class="h6 mb-0">Reports</h2>

              <form method="post"
                    action="{{ url_for('main.claim_report_new', claim_id=claim.id) }}"
                    class="d-flex align-items-center gap-2 mb-0">
                <span class="small text-muted" style="white-space: nowrap;">New report:</span>
                <label for="report_type" class="visually-hidden">Report Type</label>
                <select id="report_type"
                        name="report_type"
                        class="form-select form-select-sm"
                        required>
                  <option value="">Select type…</option>
                  <option value="initial">Initial</option>
                  <option value="progress">Progress</option>
                  <option value="closure">Closure</option>
                </select>
                <button type="submit" class="btn btn-primary btn-sm">
                  New Report
                </button>
              </form>
            </div>
            <div class="card-body p-0">
              <table id="reports-table" class="table table-sm mb-0 align-middle">
                <thead class="table-light">
                  <tr>
                    <th style="width: 10%" class="sortable" data-sort-key="type"><span>Type</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 8%">Report #</th>
                    <th style="width: 22%" class="sortable" data-sort-key="dos"><span>DOS Range</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 30%" class="sortable" data-sort-key="provider"><span>Treating Provider</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 18%" class="sortable" data-sort-key="next_appt"><span>Next Appointment</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 12%" class="sortable" data-sort-key="next_due"><span>Next Report</span> <span class="sort-indicator">↕</span></th>
                    <th style="width: 15%" class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                {% if reports %}
                  {% for r in reports %}
                    <tr>
                      <td class="small" style="white-space: normal; word-break: break-word;">
                        {{ (r.report_type or "—")|capitalize }}
                      </td>
                      <td class="small">
                        {{ r.display_report_number if r.display_report_number is defined and r.display_report_number else '—' }}
                      </td>
                      <td class="small">
                        {% if r.dos_start or r.dos_end %}
                          {{ r.dos_start|format_date if r.dos_start else "?" }} – {{ r.dos_end|format_date if r.dos_end else "?" }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small" style="white-space: normal; word-break: break-word;">
                        {#
                          Some installs use a true many-to-many relationship (e.g. approved_providers),
                          others expose join rows (e.g. report_approved_providers) that point to Provider.
                          Try multiple common attribute names and normalize into a list.
                        #}
                        {% set _names = [] %}

                        {% set provs = None %}
                        {% if r.approved_providers is defined %}
                          {% set provs = r.approved_providers %}
                        {% elif r.approved_treating_providers is defined %}
                          {% set provs = r.approved_treating_providers %}
                        {% elif r.treating_providers is defined %}
                          {% set provs = r.treating_providers %}
                        {% elif r.providers is defined %}
                          {% set provs = r.providers %}
                        {% elif r.report_approved_providers is defined %}
                          {% set provs = r.report_approved_providers %}
                        {% elif r.approved_provider_rows is defined %}
                          {% set provs = r.approved_provider_rows %}
                        {% elif r.report_approved_provider_rows is defined %}
                          {% set provs = r.report_approved_provider_rows %}
                        {% endif %}

                        {# If it's a dynamic relationship/query, pull the list #}
                        {% if provs is not none and provs.all is defined %}
                          {% set provs = provs.all() %}
                        {% endif %}

                        {% if provs %}
                          {% for p in provs %}
                            {# Direct Provider object #}
                            {% if p is not none and p.name is defined and p.name %}
                              {% set _ = _names.append(p.name) %}
                            {# Join row with provider relationship #}
                            {% elif p is not none and p.provider is defined and p.provider and p.provider.name is defined and p.provider.name %}
                              {% set _ = _names.append(p.provider.name) %}
                            {# Join row with treating_provider relationship #}
                            {% elif p is not none and p.treating_provider is defined and p.treating_provider and p.treating_provider.name is defined and p.treating_provider.name %}
                              {% set _ = _names.append(p.treating_provider.name) %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}

                        {# Fallback to single-field / legacy #}
                        {% if _names|length == 0 and r.treating_provider %}
                          {% if r.treating_provider.name is defined and r.treating_provider.name %}
                            {% set _ = _names.append(r.treating_provider.name) %}
                          {% else %}
                            {% set _ = _names.append(r.treating_provider) %}
                          {% endif %}
                        {% endif %}

                        {% if _names|length %}
                          {{ _names|unique|join(', ') }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {% if r.initial_next_appt_datetime %}
                          {{ r.initial_next_appt_datetime.strftime('%m/%d/%Y %I:%M %p') }}
                        {% else %}
                          —
                        {% endif %}
                      </td>
                      <td class="small">
                        {{ r.next_report_due|format_date or "—" }}
                      </td>
                      <td class="text-end">
                        <a href="{{ url_for('main.report_edit', claim_id=claim.id, report_id=r.id) }}"
                           class="btn btn-sm btn-primary me-1">
                          Edit
                        </a>

                        <form method="post"
                              action="{{ url_for('main.report_delete', claim_id=claim.id, report_id=r.id) }}"
                              class="d-inline"
                              onsubmit="return confirm('Delete this report? This cannot be undone.');">
                          <button type="submit" class="btn btn-sm btn-outline-danger">
                            Delete
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="7" class="text-center text-muted small py-3">
                      No reports yet for this claim.
                    </td>
                  </tr>
                {% endif %}
                </tbody>
              </table>
            </div>
          </div>


        </div>
      </div>
    </div>
    {# -------------- END REPORTS ------------------ #}

    <!-- Documents -->
    <div class="accordion-item mb-2">
      <h2 class="accordion-header" id="documentsHeading">
        <button class="accordion-button" type="button" data-bs-toggle="collapse"
                data-bs-target="#documentsCollapse" aria-expanded="true"
                aria-controls="documentsCollapse">
          Documents
        </button>
      </h2>
      <div id="documentsCollapse" class="accordion-collapse collapse show"
           aria-labelledby="documentsHeading" data-bs-parent="#claimAccordion">
        <div class="accordion-body">

          <!-- List documents -->
          <div class="card shadow-sm mb-3">
            <div class="card-body p-0">
              {% if documents %}
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Uploaded</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>File</th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for d in documents %}
                        <tr>
                          <td>{{ d.uploaded_at|format_date or "—" }}</td>
                          <td>{{ d.doc_type or d.document_type or "—" }}</td>
                          <td style="max-width: 260px;">
                            {% if d.description %}
                              <span class="text-muted text-truncate d-inline-block"
                                    style="max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                {{ d.description }}
                              </span>
                            {% else %}
                              <span class="text-muted fst-italic">No description</span>
                            {% endif %}
                          </td>
                          <td>
                            {%- set raw_name = d.original_filename or d.filename_original or "" -%}
                            {%- if raw_name %}
                              {%- set parts = raw_name.split("_", 1) -%}
                              {%- if parts|length == 2 and parts[0]|length == 8 -%}
                                {{ parts[1] }}
                              {%- else -%}
                                {{ raw_name }}
                              {%- endif -%}
                            {%- else -%}
                              —
                            {%- endif -%}
                          </td>
<td class="text-end">
  <a href="{{ url_for('main.claim_document_download', claim_id=claim.id, doc_id=d.id) }}"
     class="btn btn-outline-secondary btn-sm">
    Download
  </a>

  <form method="post"
        action="{{ url_for('main.claim_document_delete', claim_id=claim.id, doc_id=d.id) }}"
        class="d-inline"
        onsubmit="return confirm('Delete this document? This cannot be undone.');">
    <button type="submit" class="btn btn-outline-danger btn-sm ms-1">
      Delete
    </button>
  </form>
</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="p-3">
                  <p class="text-muted mb-0">No documents uploaded yet.</p>
                </div>
              {% endif %}
            </div>
          </div>

          <!-- Upload document -->
          <div class="card shadow-sm">
            <div class="card-header">
              <h3 class="h6 mb-0">Upload Document</h3>
            </div>
            <div class="card-body small">
              <form method="post"
                    action="{{ url_for('main.claim_document_upload', claim_id=claim.id) }}"
                    enctype="multipart/form-data">
                <input type="hidden" name="form_type" value="document_upload">
                <div class="row g-2 align-items-end">
                  <div class="col-md-3">
                    <label for="doc_type" class="form-label form-label-sm mb-1">Type</label>
                    <input type="text"
                           id="doc_type"
                           name="doc_type"
                           class="form-control form-control-sm"
                           placeholder="e.g. Records, IME, Imaging, Form…">
                  </div>

                  <div class="col-md-5">
                    <label for="doc_description" class="form-label form-label-sm mb-1">Description</label>
                    <input type="text"
                           id="doc_description"
                           name="description"
                           class="form-control form-control-sm"
                           placeholder="Short description…">
                  </div>

                  <div class="col-md-4">
                    <label for="doc_file" class="form-label form-label-sm mb-1">File</label>
                    <input type="file"
                           id="doc_file"
                           name="file"
                           class="form-control form-control-sm"
                           required>
                  </div>

                  <div class="col-12 mt-2 text-end">
                    <button type="submit" class="btn btn-primary btn-sm">
                      Upload
                    </button>
                  </div>
                </div>
                <p class="text-muted mt-2 mb-0 small">
                  Allowed: pdf, doc, docx, rtf, txt, jpg, jpeg, png, mp4, mov, avi. Files are stored under your configured Documents Root on this computer.
                </p>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div> <!-- /accordion -->
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Date auto-formatting for inputs with class .js-date-autofmt
  document.querySelectorAll('.js-date-autofmt').forEach(function (input) {
    input.addEventListener('input', function () {
      var digits = input.value.replace(/\D/g, '').slice(0, 8);
      var parts = [];

      if (digits.length > 4) {
        parts = [digits.slice(0, 2), digits.slice(2, 4), digits.slice(4)];
      } else if (digits.length > 2) {
        parts = [digits.slice(0, 2), digits.slice(2)];
      } else if (digits.length > 0) {
        parts = [digits];
      }

      input.value = parts.join('/');

      // Auto-tab when full date (MMDDYYYY) is entered
      if (digits.length === 8) {
        var form = input.form;
        if (form) {
          var elements = Array.from(form.elements);
          var idx = elements.indexOf(input);
          if (idx !== -1 && idx + 1 < elements.length) {
            var next = elements[idx + 1];
            if (next && typeof next.focus === 'function') {
              next.focus();
              if (typeof next.select === 'function') {
                next.select();
              }
            }
          }
        }
      }
    });
  });

  // Helpers to normalize date strings for sorting (MM/DD/YYYY -> YYYYMMDD, etc.)
  function dateTextToKey(txt) {
    if (!txt) return '';
    txt = txt.trim();
    if (!txt || txt === '—' || txt === '?') return '';
    var m = txt.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
    if (!m) return txt.toLowerCase();
    var mm = m[1].padStart(2, '0');
    var dd = m[2].padStart(2, '0');
    var yyyy = m[3];
    return yyyy + mm + dd;
  }

  function dateTimeTextToKey(txt) {
    if (!txt) return '';
    txt = txt.trim();
    if (!txt || txt === '—') return '';
    // Expect "MM/DD/YYYY HH:MM AM"; fall back to date-only if needed
    var parts = txt.split(/\s+/);
    if (parts.length < 2) return dateTextToKey(txt);
    var dateKey = dateTextToKey(parts[0]);
    var timePart = parts[1] || '';
    var ampm = (parts[2] || '').toUpperCase();
    var tm = timePart.split(':');
    var hh = parseInt(tm[0] || '0', 10);
    var mm = parseInt(tm[1] || '0', 10);
    if (ampm === 'PM' && hh < 12) hh += 12;
    if (ampm === 'AM' && hh === 12) hh = 0;
    var hhStr = String(hh).padStart(2, '0');
    var mmStr = String(mm).padStart(2, '0');
    return dateKey + hhStr + mmStr;
  }

  // Generic tri-state sorter for a table
  function setupSortableTable(tableId, getValueForKey) {
    var table = document.getElementById(tableId);
    if (!table) return;
    var tbody = table.querySelector('tbody');
    if (!tbody) return;

    function initOriginalOrder() {
      var rows = Array.from(tbody.querySelectorAll('tr'));
      rows.forEach(function (row, index) {
        row.dataset.originalIndex = index;
      });
    }

    initOriginalOrder();

    table.querySelectorAll('th.sortable').forEach(function (th) {
      th.style.cursor = 'pointer';
      th.dataset.sortState = 'none'; // none | asc | desc
      th.addEventListener('click', function () {
        var key = th.getAttribute('data-sort-key');
        if (!key) return;

        var currentState = th.dataset.sortState || 'none';
        var newState = currentState === 'none' ? 'asc' : (currentState === 'asc' ? 'desc' : 'none');

        // Reset all headers in this table
        table.querySelectorAll('th.sortable').forEach(function (hdr) {
          hdr.classList.remove('sorted-asc', 'sorted-desc');
          hdr.dataset.sortState = 'none';
          var ind = hdr.querySelector('.sort-indicator');
          if (ind) ind.textContent = '↕';
        });

        var rows = Array.from(tbody.querySelectorAll('tr'));

        if (newState === 'none') {
          // Restore original order
          rows.sort(function (a, b) {
            var ia = parseInt(a.dataset.originalIndex || '0', 10);
            var ib = parseInt(b.dataset.originalIndex || '0', 10);
            return ia - ib;
          });
        } else {
          rows.sort(function (a, b) {
            var va = getValueForKey(a, key);
            var vb = getValueForKey(b, key);

            if (va === null || va === undefined) va = '';
            if (vb === null || vb === undefined) vb = '';

            if (typeof va === 'number' && typeof vb === 'number') {
              return newState === 'asc' ? (va - vb) : (vb - va);
            } else {
              va = String(va).toLowerCase();
              vb = String(vb).toLowerCase();
              if (va < vb) return newState === 'asc' ? -1 : 1;
              if (va > vb) return newState === 'asc' ? 1 : -1;
              return 0;
            }
          });
        }

        rows.forEach(function (row) {
          tbody.appendChild(row);
        });

        if (newState !== 'none') {
          th.dataset.sortState = newState;
          th.classList.add(newState === 'asc' ? 'sorted-asc' : 'sorted-desc');
          var indicator = th.querySelector('.sort-indicator');
          if (indicator) {
            indicator.textContent = newState === 'asc' ? '↑' : '↓';
          }
        }
      });
    });
  }

  // Billable Items table sorter
  setupSortableTable('billables-table', function (row, key) {
    var cells = row.children;
    if (!cells || cells.length === 0) return '';
    switch (key) {
      case 'date': {
        var txt = cells[0].innerText || '';
        return dateTextToKey(txt);
      }
      case 'activity':
        return (cells[1].innerText || '').trim();
      case 'qty': {
        var txtQ = cells[2].innerText || '';
        var q = parseFloat(txtQ.replace(/[^\d.]/g, ''));
        return isNaN(q) ? 0 : q;
      }
      case 'description':
        return (cells[4].innerText || '').trim();
      case 'invoice':
        return (cells[6].innerText || '').trim();
      default:
        return '';
    }
  });

  // Reports table sorter
  setupSortableTable('reports-table', function (row, key) {
    var cells = row.children;
    if (!cells || cells.length === 0) return '';
    switch (key) {
      case 'type':
        return (cells[0].innerText || '').trim();
      case 'dos': {
        var txt = cells[2].innerText || '';
        var parts = txt.split('–');
        return dateTextToKey((parts[0] || '').trim());
      }
      case 'provider':
        return (cells[3].innerText || '').trim();
      case 'next_appt': {
        var txtA = cells[4].innerText || '';
        return dateTimeTextToKey(txtA);
      }
      case 'next_due': {
        var txtD = cells[5].innerText || '';
        return dateTextToKey(txtD);
      }
      default:
        return '';
    }
  });
});
</script>
{% endblock %}