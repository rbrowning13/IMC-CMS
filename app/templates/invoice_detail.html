{% extends "base.html" %}
{% block title %}Invoice {{ invoice.invoice_number or "Draft" }} - Impact CMS{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="row mb-2">
    <div class="col d-flex justify-content-between align-items-center">
      <div>
        <a href="{{ url_for('main.billing_list') }}" class="btn btn-sm btn-outline-secondary me-2">
          &larr; Back to Billing
        </a>
        {% if claim %}
          <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="btn btn-sm btn-outline-secondary">
            &larr; Back to Claim
          </a>
        {% endif %}
      </div>
      <div class="d-flex gap-2">
        <a href="{{ url_for('main.invoice_print_invoices', invoice_id=invoice.id) }}"
           class="btn btn-sm btn-outline-secondary">
          Preview / Print
        </a>
        <a href="{{ url_for('main.invoice_pdf_invoices', invoice_id=invoice.id) }}"
           class="btn btn-sm btn-outline-primary">
          Download PDF
        </a>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- Left: Invoice header / meta and Line Items -->
    <div class="col-lg-6">
      <div class="d-flex flex-column gap-3 h-100">
        <div>
          <div class="card shadow-sm">
            <div class="card-header">
              <h1 class="h5 mb-0">Invoice</h1>
            </div>
            <div class="card-body">
              <dl class="row mb-2 small">
                <dt class="col-sm-4">Invoice #</dt>
                <dd class="col-sm-8">
                  {{ invoice.invoice_number or "Draft (no number yet)" }}
                </dd>

                <dt class="col-sm-4">Status</dt>
                <dd class="col-sm-8">
                  {{ invoice.status or "Draft" }}
                </dd>

                <dt class="col-sm-4">Invoice Date</dt>
                <dd class="col-sm-8">
                  {{ invoice.invoice_date.strftime("%m/%d/%Y") if invoice.invoice_date else "—" }}
                </dd>

                <dt class="col-sm-4">Dates of Service</dt>
                <dd class="col-sm-8">
                  {% if invoice.dos_start and invoice.dos_end %}
                    {{ invoice.dos_start.strftime("%m/%d/%Y") }} – {{ invoice.dos_end.strftime("%m/%d/%Y") }}
                  {% elif invoice.dos_start %}
                    From {{ invoice.dos_start.strftime("%m/%d/%Y") }}
                  {% elif invoice.dos_end %}
                    Through {{ invoice.dos_end.strftime("%m/%d/%Y") }}
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </dl>

              {% if claim %}
              <hr>
              <dl class="row mb-0 small">
                <dt class="col-sm-4">Claim #</dt>
                <dd class="col-sm-8">
                  <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}">
                    {{ claim.claim_number or "—" }}
                  </a>
                </dd>

                <dt class="col-sm-4">Claimant</dt>
                <dd class="col-sm-8">
                  {{ claim.claimant_name or "—" }}
                </dd>

                <dt class="col-sm-4">Employer</dt>
                <dd class="col-sm-8">
                  {% if claim.employer %}
                    <a href="{{ url_for('main.employer_detail', employer_id=claim.employer.id) }}">
                      {{ claim.employer.name }}
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </dd>

                <dt class="col-sm-4">Carrier</dt>
                <dd class="col-sm-8">
                  {% if claim.carrier %}
                    <a href="{{ url_for('main.carrier_detail', carrier_id=claim.carrier.id) }}">
                      {{ claim.carrier.name }}
                    </a>
                  {% else %}
                    —
                  {% endif %}
                </dd>
              </dl>
              {% endif %}
            </div>
          </div>
        </div>
        <div>
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h2 class="h6 mb-0">Line Items</h2>
              <small class="text-muted">
                {% if items %}
                  {{ items|length }} item{{ items|length != 1 and "s" or "" }}
                {% else %}
                  No items
                {% endif %}
              </small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width: 9rem;">Service Date</th>
                      <th style="width: 6rem;">Code</th>
                      <th>Description</th>
                      <th class="text-end" style="width: 8rem;">Quantity</th>
                      <th class="text-end" style="width: 7rem;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                  {% if items %}
                    {% for item in items %}
                      <tr>
                        <td>
                          {% set _sd = None %}
                          {% if item.service_date is defined and item.service_date %}
                            {% set _sd = item.service_date %}
                          {% elif item.date_of_service is defined and item.date_of_service %}
                            {% set _sd = item.date_of_service %}
                          {% elif item.service_dt is defined and item.service_dt %}
                            {% set _sd = item.service_dt %}
                          {% elif item.date is defined and item.date %}
                            {% set _sd = item.date %}
                          {% elif item.activity_date is defined and item.activity_date %}
                            {% set _sd = item.activity_date %}
                          {% endif %}

                          {% if _sd %}
                            {{ _sd.strftime('%m/%d/%Y') if _sd.strftime is defined else _sd }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td>{{ item.activity_code or "" }}</td>
                        <td>{{ item.description or "" }}</td>
                        <td class="text-end">
                          {% if item.quantity is not none %}
                            {{ "%.2f"|format(item.quantity) }}
                          {% else %}
                            —
                          {% endif %}
                        </td>
                        <td class="text-end">
                          {% if (invoice.status or "Draft") == "Draft" %}
                            <form method="post"
                                  action="{{ url_for('main.invoice_remove_item_invoices',
                                                     invoice_id=invoice.id,
                                                     item_id=item.id) }}"
                                  onsubmit="return confirm('Remove this item from the invoice and return it to the claim?');">
                              <button type="submit" class="btn btn-sm btn-outline-danger">
                                Remove
                              </button>
                            </form>
                          {% else %}
                            <span class="text-muted small">Locked</span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endfor %}
                  {% else %}
                    <tr>
                      <td colspan="5" class="text-center text-muted py-3">
                        No items on this invoice.
                      </td>
                    </tr>
                  {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: Status edit + actions and Totals -->
    <div class="col-lg-6">
      <div class="d-flex flex-column gap-3 h-100">
        <div>
          <div class="card shadow-sm">
            <div class="card-header">
              <h2 class="h6 mb-0">Invoice Status</h2>
            </div>
            <div class="card-body">
              <form method="post" action="{{ url_for('main.invoice_update_invoices', invoice_id=invoice.id) }}" class="row g-2 align-items-end">
                <div class="col-sm-6">
                  <label class="form-label form-label-sm">Status</label>
                  <select name="status" class="form-select form-select-sm">
                    {% set current_status = invoice.status or "Draft" %}
                    {% for s in ["Draft", "Sent", "Paid", "Void"] %}
                      <option value="{{ s }}" {% if s == current_status %}selected{% endif %}>
                        {{ s }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-sm-4">
                  <label class="form-label form-label-sm">Invoice Date</label>
                  <input
                    type="text"
                    name="invoice_date"
                    class="form-control form-control-sm js-date"
                    data-flatpickr="1"
                    inputmode="numeric"
                    autocomplete="off"
                    placeholder="MM/DD/YYYY"
                    value="{{ invoice.invoice_date.strftime('%m/%d/%Y') if invoice.invoice_date else '' }}">
                </div>
                <div class="col-sm-2 d-grid">
                  <button type="submit" class="btn btn-sm btn-primary mt-3">
                    Save
                  </button>
                </div>
              </form>

              <hr>

              {% set is_draft = (invoice.status or "Draft") == "Draft" %}

              {% if is_draft %}
                <form method="post"
                      action="{{ url_for('main.invoice_add_uninvoiced_invoices', invoice_id=invoice.id) }}"
                      class="mb-2">
                  <button type="submit" class="btn btn-sm btn-outline-secondary">
                    Add all uninvoiced complete items
                  </button>
                </form>

                <form method="post"
                      action="{{ url_for('main.invoice_delete_invoices', invoice_id=invoice.id) }}"
                      onsubmit="return confirm('Delete this draft invoice and return its items to the claim?');">
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    Delete Draft Invoice
                  </button>
                </form>
              {% else %}
                <div class="small text-muted">
                  Draft-only actions are locked after an invoice is marked <strong>{{ invoice.status }}</strong>.
                  Change status back to <strong>Draft</strong> and Save to add items or delete the invoice.
                </div>
              {% endif %}

              <hr>

              {# ---- Payments (billing) ---- #}
              {# Prefer values computed in the route, but keep the table + summary consistent by
                 deriving totals from the same payment list when available. #}

              {# Prefer `payments` from the route; fall back to an Invoice relationship if present #}
              {% set _payments = [] %}
              {% if payments is defined and payments %}
                {% set _payments = payments %}
              {% elif invoice.payments is defined and invoice.payments %}
                {% set _payments = invoice.payments %}
              {% elif invoice.payment_records is defined and invoice.payment_records %}
                {% set _payments = invoice.payment_records %}
              {% endif %}

              {# Prefer canonical totals from the route (computed via helper), then fall back. #}
              {% set _invoice_total = 0 %}
              {% if invoice_total is defined and invoice_total is not none %}
                {% set _invoice_total = invoice_total %}
              {% elif invoice.total_amount is defined and invoice.total_amount is not none %}
                {% set _invoice_total = invoice.total_amount %}
              {% elif invoice.amount_total is defined and invoice.amount_total is not none %}
                {% set _invoice_total = invoice.amount_total %}
              {% endif %}

              {# Paid: prefer route-provided `amount_paid` (or `paid_total`), else derive from rendered list #}
              {% set _paid_total = 0 %}
              {% if amount_paid is defined and amount_paid is not none %}
                {% set _paid_total = amount_paid %}
              {% elif paid_total is defined and paid_total is not none %}
                {% set _paid_total = paid_total %}
              {% elif _payments %}
                {% for p in _payments %}
                  {% set _paid_total = _paid_total + (p.amount or 0) %}
                {% endfor %}
              {% elif invoice.total_paid is defined and invoice.total_paid is not none %}
                {% set _paid_total = invoice.total_paid %}
              {% endif %}

              {# Balance/Total due: prefer route-provided `total_due`, else compute from totals above #}
              {% set _balance_due = 0 %}
              {% if total_due is defined and total_due is not none %}
                {% set _balance_due = total_due %}
              {% elif balance_due is defined and balance_due is not none %}
                {% set _balance_due = balance_due %}
              {% elif invoice.balance_due is defined and invoice.balance_due is not none %}
                {% set _balance_due = invoice.balance_due %}
              {% else %}
                {% set _balance_due = (_invoice_total - _paid_total) %}
              {% endif %}

              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <div class="fw-semibold">Payments</div>
                  <div class="small text-muted">Record and track payments without editing invoice line items.</div>
                </div>
                <a
                  href="/billing/{{ invoice.id }}/payment/new?return_to={{ request.full_path|urlencode }}"
                  class="btn btn-sm btn-outline-primary">
                  Record payment
                </a>
              </div>

              <dl class="row small mb-2">
                <dt class="col-6">Paid</dt>
                <dd class="col-6 text-end">${{ "%.2f"|format(_paid_total) }}</dd>
                <dt class="col-6">Balance</dt>
                <dd class="col-6 text-end">${{ "%.2f"|format(_balance_due) }}</dd>
              </dl>

              {% if _payments %}
                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 8rem;">Date</th>
                        <th style="width: 8rem;" class="text-end">Amount</th>
                        <th style="width: 7rem;">Method</th>
                        <th style="width: 9rem;">Reference</th>
                        <th class="d-none d-lg-table-cell">Notes</th>
                        <th class="text-end" style="width: 9rem;">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for p in _payments %}
                        <tr>
                          <td>
                            {% set _pd = None %}
                            {% if p.paid_date is defined and p.paid_date %}
                              {% set _pd = p.paid_date %}
                            {% elif p.payment_date is defined and p.payment_date %}
                              {% set _pd = p.payment_date %}
                            {% elif p.date is defined and p.date %}
                              {% set _pd = p.date %}
                            {% elif p.created_at is defined and p.created_at %}
                              {% set _pd = p.created_at %}
                            {% elif p.created is defined and p.created %}
                              {% set _pd = p.created %}
                            {% endif %}

                            {% if _pd %}
                              {{ _pd.strftime('%m/%d/%Y') if _pd.strftime is defined else _pd }}
                            {% else %}
                              —
                            {% endif %}
                          </td>
                          <td class="text-end">${{ "%.2f"|format(p.amount or 0) }}</td>
                          <td>{{ p.method or "" }}</td>
                          <td>{{ p.reference or "" }}</td>
                          <td class="text-muted d-none d-lg-table-cell">{{ p.notes or "" }}</td>
                          <td class="text-end">
                            <div class="d-inline-flex gap-1">
                              <a
                                class="btn btn-sm btn-outline-secondary"
                                href="/billing/{{ invoice.id }}/payment/{{ p.id }}/edit?return_to={{ request.full_path|urlencode }}">
                                Edit
                              </a>
                              <form
                                method="post"
                                action="/billing/payment/{{ p.id }}/delete?return_to={{ request.full_path|urlencode }}"
                                onsubmit="return confirm('Delete this payment?');"
                                class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                              </form>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="small text-muted">No payments recorded yet.</div>
              {% endif %}
            </div>
          </div>
        </div>
        <div>
          <div class="card shadow-sm">
            <div class="card-header">
              <h2 class="h6 mb-0">Totals</h2>
            </div>
            <div class="card-body">
              {# ---- Totals: ALWAYS prefer canonical route math (fin) so this matches Payments and Print ---- #}
              {% set _fin = fin if fin is defined else none %}

              {% set hours_total = 0.0 %}
              {% set miles_total = 0.0 %}
              {% set expenses_total = 0.0 %}
              {% set invoice_total_amt = 0.0 %}
              {% set rates_rows = [] %}

              {% if _fin %}
                {% if _fin is mapping %}
                  {% set hours_total = _fin.get('hours_total', _fin.get('total_hours', 0.0)) or 0.0 %}
                  {% set miles_total = _fin.get('miles_total', _fin.get('total_miles', 0.0)) or 0.0 %}
                  {% set expenses_total = _fin.get('expenses_total', _fin.get('total_expenses', 0.0)) or 0.0 %}
                  {% set invoice_total_amt = _fin.get('invoice_total', 0.0) or 0.0 %}
                  {% set rates_rows = _fin.get('rates_used_rows', []) or [] %}
                {% else %}
                  {% if _fin.hours_total is defined %}{% set hours_total = _fin.hours_total %}{% elif _fin.total_hours is defined %}{% set hours_total = _fin.total_hours %}{% endif %}
                  {% if _fin.miles_total is defined %}{% set miles_total = _fin.miles_total %}{% elif _fin.total_miles is defined %}{% set miles_total = _fin.total_miles %}{% endif %}
                  {% if _fin.expenses_total is defined %}{% set expenses_total = _fin.expenses_total %}{% elif _fin.total_expenses is defined %}{% set expenses_total = _fin.total_expenses %}{% endif %}
                  {% if _fin.invoice_total is defined %}{% set invoice_total_amt = _fin.invoice_total %}{% endif %}
                  {% if _fin.rates_used_rows is defined %}{% set rates_rows = _fin.rates_used_rows %}{% endif %}
                {% endif %}
              {% else %}
                {# Fallback: use stored invoice totals if fin wasn't passed (should be rare) #}
                {% set hours_total = invoice.total_hours or 0.0 %}
                {% set miles_total = invoice.total_miles or 0.0 %}
                {% set expenses_total = invoice.total_expenses or 0.0 %}
                {% set invoice_total_amt = invoice.total_amount or 0.0 %}
              {% endif %}

              <dl class="row small mb-1">
                <dt class="col-7">Billable hours</dt>
                <dd class="col-5 text-end">{{ "%.2f"|format(hours_total or 0) }}</dd>

                <dt class="col-7">Mileage (miles)</dt>
                <dd class="col-5 text-end">{{ "%.2f"|format(miles_total or 0) }}</dd>

                <dt class="col-7">Expenses ($)</dt>
                <dd class="col-5 text-end">{{ "%.2f"|format(expenses_total or 0) }}</dd>
              </dl>

              {# Rates used table should come from canonical helper (rates_used_rows) #}
              {% if rates_rows %}
                <hr class="my-2">
                <div class="small text-muted mb-2">Rates used</div>

                <div class="table-responsive">
                  <table class="table table-sm mb-0 align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Rate</th>
                        <th class="text-end" style="width: 8.5rem;">Subtotal</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for r in rates_rows %}
                        <tr>
                          <td>
                            {{ r.label or r.get('label') }}
                            {% if (r.rate is defined or (r is mapping and r.get('rate') is not none)) %}
                              {% set _r_rate = (r.rate if r.rate is defined else r.get('rate')) %}
                              {% if (r.label or r.get('label')) == 'Mileage' %}
                                <span class="text-muted">— ${{ "%.4f"|format(_r_rate or 0) }}/mi</span>
                              {% else %}
                                <span class="text-muted">— ${{ "%.2f"|format(_r_rate or 0) }}</span>
                              {% endif %}
                            {% endif %}
                            {% set _r_src = (r.source if r.source is defined else (r.get('source') if r is mapping else None)) %}
                            {% if _r_src %}<span class="text-muted"> {{ _r_src }}</span>{% endif %}
                          </td>
                          {% set _r_sub = (r.subtotal if r.subtotal is defined else (r.get('subtotal') if r is mapping else 0)) %}
                          <td class="text-end">${{ "%.2f"|format(_r_sub or 0) }}</td>
                        </tr>
                      {% endfor %}

                      {% if (expenses_total or 0) != 0 %}
                        <tr>
                          <td>
                            Expenses
                            <span class="text-muted">— pass-through</span>
                          </td>
                          <td class="text-end">${{ "%.2f"|format(expenses_total or 0) }}</td>
                        </tr>
                      {% endif %}

                      <tr>
                        <td class="fw-bold">Total</td>
                        <td class="text-end fw-bold">${{ "%.2f"|format(invoice_total_amt or 0) }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}