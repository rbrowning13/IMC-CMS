{% extends "base.html" %}
{% block title %}Settings - Impact CMS{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h3 mb-0">Settings</h1>
  </div>

  {% if message %}
    <div class="alert alert-success py-1">
      {{ message }}
    </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="mb-4">

    <!-- Business Information -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#businessInfoSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">Business Information</h2>
      </div>
      <div id="businessInfoSection" class="collapse show">
        <div class="card-body">

          <div class="mb-2">
            <label class="form-label form-label-sm">Business Name</label>
            <input type="text" name="business_name" class="form-control form-control-sm"
                   value="{{ settings.business_name or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Address 1</label>
            <input type="text" name="address1" class="form-control form-control-sm"
                   value="{{ settings.address1 or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Address 2</label>
            <input type="text" name="address2" class="form-control form-control-sm"
                   value="{{ settings.address2 or '' }}">
          </div>

          <div class="row">
            <div class="col-4 mb-2">
              <label class="form-label form-label-sm">City</label>
              <input type="text" name="city" class="form-control form-control-sm"
                     value="{{ settings.city or '' }}">
            </div>
            <div class="col-4 mb-2">
              <label class="form-label form-label-sm">State</label>
              <select name="state" class="form-select form-select-sm">
                {{ state_options(settings.state or 'ID') }}
              </select>
            </div>
            <div class="col-4 mb-2">
              <label class="form-label form-label-sm">ZIP</label>
              <input type="text" name="postal_code" class="form-control form-control-sm"
                     value="{{ settings.postal_code or '' }}">
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Phone</label>
            <input type="text" name="phone" class="form-control form-control-sm"
                   value="{{ settings.phone or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Fax</label>
            <input type="text" name="fax" class="form-control form-control-sm"
                   value="{{ settings.fax or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Email</label>
            <input type="email" name="email" class="form-control form-control-sm"
                   value="{{ settings.email or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Case Manager</label>
            <input type="text" name="responsible_case_manager" class="form-control form-control-sm"
                   value="{{ settings.responsible_case_manager or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">EIN / Tax ID</label>
            <input type="text" name="ein" class="form-control form-control-sm"
                   value="{{ settings.ein or '' }}">
          </div>

        </div>
      </div>
    </div>

    <!-- Rates -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#ratesSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">Rates & Productivity Targets</h2>
      </div>
      <div id="ratesSection" class="collapse show">
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-label form-label-sm">Hourly Rate (standard)</label>
              <input type="text" name="hourly_rate" class="form-control form-control-sm"
                     value="{{ settings.hourly_rate or '' }}">
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label form-label-sm">Telephonic Rate</label>
              <input type="text" name="telephonic_rate" class="form-control form-control-sm"
                     value="{{ settings.telephonic_rate or '' }}">
            </div>
            <div class="col-md-4 mb-2">
              <label class="form-label form-label-sm">Mileage Rate (per mile)</label>
              <input type="text" name="mileage_rate" class="form-control form-control-sm"
                     value="{{ settings.mileage_rate or '' }}">
            </div>
          </div>

          <hr class="my-3">

          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label form-label-sm">Minimum Target Hours Per Week</label>
              <input type="number" step="0.1" name="target_min_hours_per_week"
                     class="form-control form-control-sm"
                     value="{{ settings.target_min_hours_per_week or '' }}">
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label form-label-sm">Maximum Target Hours Per Week</label>
              <input type="number" step="0.1" name="target_max_hours_per_week"
                     class="form-control form-control-sm"
                     value="{{ settings.target_max_hours_per_week or '' }}">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- UI & Documents -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#uiSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">UI & Documents</h2>
      </div>
      <div id="uiSection" class="collapse show">
        <div class="card-body">

          <div class="mb-2">
            <label class="form-label form-label-sm">Accent Color (hex)</label>
            <input type="text" name="accent_color" class="form-control form-control-sm"
                   value="{{ settings.accent_color or '' }}">
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Report Footer Text</label>
            <textarea name="report_footer_text" rows="3" class="form-control form-control-sm">{{ settings.report_footer_text or '' }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Invoice Footer Text</label>
            <textarea name="invoice_footer_text" rows="3" class="form-control form-control-sm">{{ settings.invoice_footer_text or '' }}</textarea>
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Business Logo (PNG/JPG)</label>
            <input type="file" name="logo_file" class="form-control form-control-sm">
            {% if settings.logo_path %}
              <div class="mt-2">
                <img src="{{ url_for('static', filename=settings.logo_path) }}" style="max-height:60px;">
              </div>
            {% endif %}
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">Signature (PNG/JPG)</label>
            <input type="file" name="signature_file" class="form-control form-control-sm">
            {% if settings.signature_path %}
              <div class="mt-2">
                <img src="{{ url_for('static', filename=settings.signature_path) }}" style="max-height:80px;">
              </div>
            {% endif %}
          </div>

        </div>
      </div>
    </div>

    <!-- Email Configuration -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#emailSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">Email Configuration</h2>
      </div>
      <div id="emailSection" class="collapse">
        <div class="card-body">

          <div class="row">
            <div class="col-md-4 mb-2">
              <label class="form-label form-label-sm">SMTP Server</label>
              <input type="text" name="smtp_server" class="form-control form-control-sm"
                     value="{{ settings.smtp_server or 'smtp.office365.com' }}">
            </div>
            <div class="col-md-2 mb-2">
              <label class="form-label form-label-sm">Port</label>
              <input type="number" name="smtp_port" class="form-control form-control-sm"
                     value="{{ settings.smtp_port or 587 }}">
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label form-label-sm">Email Address</label>
              <input type="email" name="smtp_email" class="form-control form-control-sm"
                     value="{{ settings.smtp_email or '' }}">
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label form-label-sm">App Password</label>
            <input type="password" name="smtp_password"
                   class="form-control form-control-sm"
                   placeholder="Stored securely">
          </div>

          <button type="submit" name="send_test_email" value="1"
                  class="btn btn-outline-secondary btn-sm">
            Send Test Email
          </button>

        </div>
      </div>
    </div>

    <!-- AI Assistant -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#aiSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">AI Assistant</h2>
      </div>
      <div id="aiSection" class="collapse show">
        <div class="card-body">

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="ai_enabled" value="1"
                   {% if settings.ai_enabled %}checked{% endif %}>
            <label class="form-check-label">
              Enable AI assistance (optional)
            </label>
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="ai_allow_provider_names" value="1"
                   {% if settings.ai_allow_provider_names %}checked{% endif %}>
            <label class="form-check-label">
              Allow provider names in AI context
            </label>
          </div>

          <div class="alert alert-warning small mt-2 mb-0">
            <strong>Privacy note:</strong> AI should never receive claimant identifiers (name, DOB, phone, email, address) or other sensitive details.
          </div>

        </div>
      </div>
    </div>

    <!-- Contact Roles -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#rolesSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">Contact Roles</h2>
      </div>
      <div id="rolesSection" class="collapse show">
        <div class="card-body">
          <textarea name="contact_roles" rows="6" class="form-control form-control-sm">{{ contact_roles_text }}</textarea>
        </div>
      </div>
    </div>

    <!-- File Storage -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#fileSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">File Storage</h2>
      </div>
      <div id="fileSection" class="collapse show">
        <div class="card-body">

          <div class="mb-2">
            <label class="form-label form-label-sm">Documents Root Folder (local storage only)</label>
            <input type="text" name="documents_root"
                   class="form-control form-control-sm"
                   value="{{ settings.documents_root or '' }}">
          </div>

          <div class="alert alert-warning small mb-0">
            <strong>HIPAA / privacy note:</strong> Use a local, non-synced folder only.
          </div>

        </div>
      </div>
    </div>

    <!-- Lists & Code Tables -->
    <div class="card shadow-sm mb-3">
      <div class="card-header" data-bs-toggle="collapse" data-bs-target="#listsSection" style="cursor:pointer;">
        <h2 class="h6 mb-0">Lists & Code Tables</h2>
      </div>
      <div id="listsSection" class="collapse show">
        <div class="card-body">
          <ul class="mb-0">
            <li><a href="{{ url_for('main.settings_barriers') }}">Manage Barrier Options</a></li>
            <li><a href="{{ url_for('main.settings_billables') }}">Manage Billable Activity Codes</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="d-flex justify-content-end mb-5">
      <button type="submit" class="btn btn-primary btn-sm">
        Save Settings
      </button>
    </div>

  </form>
</div>
{% endblock %}