{% extends "base.html" %}
{% block title %}Print Invoice {{ invoice.invoice_number or "Draft" }} - Impact CMS{% endblock %}

{% block content %}
{# Accent color: support Settings model OR a dict-like settings payload #}
{% set s = settings %}
{% set accent_raw = (
  (s.get('accent_color') if s is mapping else s.accent_color)
  or (s.get('theme_accent_color') if s is mapping else s.theme_accent_color)
  or (s.get('theme_color') if s is mapping else s.theme_color)
  or (s.get('primary_color') if s is mapping else s.primary_color)
  or '#0d6efd'
) %}
{# Normalize hex strings like "ff8800" -> "#ff8800" #}
{% set accent = ('#' ~ accent_raw) if (accent_raw is string and accent_raw and not accent_raw.startswith('#') and accent_raw|length in [3, 6]) else accent_raw %}
<div class="container mt-3" id="invoice-print-root" style="--accent: {{ accent }};">
  <div class="d-print-none mb-3">
    <div class="d-flex justify-content-end gap-2">
      <a href="{{ url_for('main.invoice_detail', invoice_id=invoice.id) }}"
         class="btn btn-sm btn-outline-secondary">
        &larr; Back to Invoice
      </a>
      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}"
         class="btn btn-sm btn-outline-secondary">
        &larr; Back to Claim
      </a>
      <button class="btn btn-sm btn-primary" onclick="window.print()">
        Print
      </button>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="row pb-2 mb-2 align-items-center">
        <!-- Business info with optional logo -->
        <div class="col-md-6">
          <div class="text-center mb-2">
            {% if settings.logo_path %}
              {% if settings.logo_path.startswith('/') %}
                <img src="{{ settings.logo_path }}" alt="{{ settings.business_name or 'Logo' }}" style="max-height: 70px;">
              {% else %}
                <img src="{{ url_for('static', filename=settings.logo_path) }}" alt="{{ settings.business_name or 'Logo' }}" style="max-height: 70px;">
              {% endif %}
            {% endif %}
          </div>

          <div class="text-center">
            <p class="mb-0 small">
              {% if settings.address1 %}{{ settings.address1 }}<br>{% endif %}
              {% if settings.address2 %}{{ settings.address2 }}<br>{% endif %}
              {% if settings.city or settings.state or settings.postal_code %}
                {{ settings.city or "" }}{% if settings.city and settings.state %}, {% endif %}
                {{ settings.state or "" }} {{ settings.postal_code or "" }}<br>
              {% endif %}
              {% if settings.phone %}
                Phone: {{ settings.phone }}<br>
              {% endif %}
              {% if settings.email %}
                Email: {{ settings.email }}<br>
              {% endif %}
              {% if settings.ein %}
                EIN: {{ settings.ein }}<br>
              {% endif %}
            </p>
          </div>
        </div>

        <!-- Invoice meta -->
        <div class="col-md-6 text-md-end mt-3 mt-md-0">
          <h2 class="h4">Invoice</h2>
          <p class="mb-0 small">
            <strong>Invoice #:</strong> {{ invoice.invoice_number or "Draft" }}<br>
            <strong>Date:</strong>
            {{ invoice.invoice_date|format_date if invoice.invoice_date else "—" }}<br>
            <strong>Status:</strong> {{ invoice.status or "Draft" }}<br>
            <strong>Claim #:</strong>
              {{ claim.claim_number or "—" }}<br>
            <strong>Claimant:</strong>
              {{ claim.claimant_name or "—" }}<br>
            {% if settings.responsible_case_manager %}
              <strong>Case Manager:</strong> {{ settings.responsible_case_manager }}<br>
            {% endif %}
          </p>
        </div>
      </div>

      <hr class="ip-hr">

      <!-- Bill to -->
      <div class="row mb-3">
        <div class="col-md-6">
          <h3 class="h6">Bill To</h3>
          {% set bill_to = claim.carrier or None %}
          {% if bill_to %}
            <p class="mb-0 small">
              <strong>{{ bill_to.name }}</strong><br>
              {% if bill_to.address1 %}{{ bill_to.address1 }}<br>{% endif %}
              {% if bill_to.address2 %}{{ bill_to.address2 }}<br>{% endif %}
              {% if bill_to.city or bill_to.state or bill_to.postal_code %}
                {{ bill_to.city or "" }}{% if bill_to.city and bill_to.state %}, {% endif %}
                {{ bill_to.state or "" }} {{ bill_to.postal_code or "" }}<br>
              {% endif %}
              {% if bill_to.phone %}
                Phone: {{ bill_to.phone }}<br>
              {% endif %}
              {% if bill_to.email %}
                Email: {{ bill_to.email }}<br>
              {% endif %}
            </p>
          {% else %}
            <p class="small text-muted mb-0">No carrier assigned to this claim.</p>
          {% endif %}
        </div>

        <div class="col-md-6">
          <h3 class="h6">Dates of Service</h3>

          {# Determine DOS from invoice fields, otherwise derive from items (various service date field names) #}
          {% set dos_start = invoice.dos_start %}
          {% set dos_end = invoice.dos_end %}

          {% if (not dos_start or not dos_end) and items %}
            {% set dos = namespace(min=None, max=None) %}
            {% for item in items %}
              {# Try several common service date field names; item may be a model, dict, or a view-model #}
              {% set d = (
                item.service_date
                or item.date_of_service
                or item.dos
                or item.activity_date
                or item.date
                or item.activity_dt
                or item.service_dt
                or item.performed_on
              ) %}
              {% if d %}
                {% if dos.min is none or d < dos.min %}{% set dos.min = d %}{% endif %}
                {% if dos.max is none or d > dos.max %}{% set dos.max = d %}{% endif %}
              {% endif %}
            {% endfor %}
            {% if not dos_start %}{% set dos_start = dos.min %}{% endif %}
            {% if not dos_end %}{% set dos_end = dos.max %}{% endif %}
          {% endif %}

          <p class="small mb-0">
            {% if dos_start and dos_end %}
              {{ dos_start|format_date }} – {{ dos_end|format_date }}
            {% elif dos_start %}
              From {{ dos_start|format_date }}
            {% elif dos_end %}
              Through {{ dos_end|format_date }}
            {% else %}
              Not specified
            {% endif %}
          </p>
        </div>
      </div>

      {# Totals: ALWAYS prefer centralized route math (fin) to avoid mismatches with invoice_detail. #}
      {% set _fin = fin if fin is defined else none %}

      {# Fallback totals computed from items only if fin is not available #}
      {% set ns = namespace(hours=0.0, miles=0.0, expenses=0.0) %}
      {% if items and not _fin %}
        {% for item in items %}
          {% set code = (item.activity_code or '')|upper %}
          {% set qty = (item.quantity if item.quantity is not none else 0) %}
          {% if code == 'MIL' %}
            {% set ns.miles = ns.miles + qty %}
          {% elif code == 'EXP' %}
            {% set ns.expenses = ns.expenses + qty %}
          {% else %}
            {% set ns.hours = ns.hours + qty %}
          {% endif %}
        {% endfor %}
      {% endif %}

      {# Default to stored totals (or item-computed) #}
      {% set hours_total = invoice.total_hours if invoice.total_hours is not none else ns.hours %}
      {% set miles_total = invoice.total_miles if invoice.total_miles is not none else ns.miles %}
      {% set expenses_total = invoice.total_expenses if invoice.total_expenses is not none else ns.expenses %}

      {# If the route passed centralized financials, use them (source of truth) #}
      {% if _fin %}
        {% if _fin is mapping %}
          {% set hours_total = _fin.get('hours_total', _fin.get('hours', hours_total)) %}
          {% set miles_total = _fin.get('miles_total', _fin.get('miles', miles_total)) %}
          {% set expenses_total = _fin.get('expenses_total', _fin.get('expenses', expenses_total)) %}
        {% else %}
          {% if _fin.hours_total is defined %}{% set hours_total = _fin.hours_total %}{% elif _fin.hours is defined %}{% set hours_total = _fin.hours %}{% endif %}
          {% if _fin.miles_total is defined %}{% set miles_total = _fin.miles_total %}{% elif _fin.miles is defined %}{% set miles_total = _fin.miles %}{% endif %}
          {% if _fin.expenses_total is defined %}{% set expenses_total = _fin.expenses_total %}{% elif _fin.expenses is defined %}{% set expenses_total = _fin.expenses %}{% endif %}
        {% endif %}
      {% endif %}

      <!-- Line items table -->
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle mb-3 ip-items">
          <thead class="ip-items-head">
            <tr>
              <th style="width: 9rem;">Service Date</th>
              <th style="width: 6rem;">Code</th>
              <th>Description</th>
              <th class="text-end" style="width: 8rem;">Quantity</th>
            </tr>
          </thead>
          <tbody>
          {% if items %}
            {% for item in items %}
              <tr>
                <td>
                  {# Service date can come through under different field names and may be a string already #}
                  {% set d = (
                    item.service_date
                    or item.date_of_service
                    or item.dos
                    or item.activity_date
                    or item.date
                    or item.activity_dt
                    or item.service_dt
                    or item.performed_on
                  ) %}
                  {% if d %}
                    {% if d is string %}
                      {{ d }}
                    {% else %}
                      {{ d|format_date }}
                    {% endif %}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ item.activity_code or "" }}</td>
                <td>{{ item.description or "" }}</td>
                <td class="text-end">
                  {% if item.quantity is not none %}
                    {{ "%.2f"|format(item.quantity) }}
                  {% else %}
                    —
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="4" class="text-center text-muted py-3">
                No line items on this invoice.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>

      {# Payments / Balance Due: prefer centralized `fin` from the route, but ensure totals use carrier rates when available. #}
      {% set _fin = fin if fin is defined else none %}

      {# Amount paid: best source is fin; fallback to invoice/payments. #}
      {% set paid_total = 0 %}
      {% if _fin %}
        {% if _fin is mapping %}
          {% set paid_total = _fin.get('paid_total', _fin.get('paid', 0)) %}
        {% else %}
          {% if _fin.paid_total is defined %}{% set paid_total = _fin.paid_total %}{% elif _fin.paid is defined %}{% set paid_total = _fin.paid %}{% endif %}
        {% endif %}
      {% elif invoice.balance_due is defined and invoice.balance_due is not none %}
        {% set paid_total = (invoice.total_amount or 0) - (invoice.balance_due or 0) %}
      {% elif payments is defined and payments %}
        {% set pns = namespace(total=0.0) %}
        {% for p in payments %}
          {% set pns.total = pns.total + (p.amount or 0) %}
        {% endfor %}
        {% set paid_total = pns.total %}
      {% else %}
        {% set paid_total = 0 %}
      {% endif %}

      {#
        Total amount:
        - If fin provides component subtotals (hourly/mileage/expenses), use them (best).
        - Otherwise, compute using effective rates (carrier overrides settings when present).

        This prevents invoice_print from drifting to default settings rates when carrier-specific rates exist.
      #}

      {% set total_amount = 0 %}

      {% set fin_hourly_subtotal = none %}
      {% set fin_mileage_subtotal = none %}
      {% set fin_expenses_subtotal = none %}

      {% if _fin and (_fin is mapping) %}
        {% set fin_hourly_subtotal = _fin.get('hourly_subtotal') or _fin.get('hourly_amount') or _fin.get('subtotal_hourly') %}
        {% set fin_mileage_subtotal = _fin.get('mileage_subtotal') or _fin.get('mileage_amount') or _fin.get('subtotal_mileage') %}
        {% set fin_expenses_subtotal = _fin.get('expenses_subtotal') or _fin.get('expenses_amount') or _fin.get('subtotal_expenses') %}
      {% elif _fin %}
        {% if _fin.hourly_subtotal is defined %}{% set fin_hourly_subtotal = _fin.hourly_subtotal %}{% elif _fin.hourly_amount is defined %}{% set fin_hourly_subtotal = _fin.hourly_amount %}{% endif %}
        {% if _fin.mileage_subtotal is defined %}{% set fin_mileage_subtotal = _fin.mileage_subtotal %}{% elif _fin.mileage_amount is defined %}{% set fin_mileage_subtotal = _fin.mileage_amount %}{% endif %}
        {% if _fin.expenses_subtotal is defined %}{% set fin_expenses_subtotal = _fin.expenses_subtotal %}{% elif _fin.expenses_amount is defined %}{% set fin_expenses_subtotal = _fin.expenses_amount %}{% endif %}
      {% endif %}

      {# If fin provides component subtotals, use them (best). #}
      {% if fin_hourly_subtotal is not none or fin_mileage_subtotal is not none or fin_expenses_subtotal is not none %}
        {% set total_amount = (fin_hourly_subtotal or 0) + (fin_mileage_subtotal or 0) + (fin_expenses_subtotal or 0) %}
      {% else %}
        {# Effective rates (carrier overrides settings). #}
        {% set c = claim.carrier if claim and claim.carrier else none %}
        {% set hourly_rate = (c.hourly_rate if c and c.hourly_rate is not none else settings.hourly_rate) or 0 %}
        {% set mileage_rate = (c.mileage_rate if c and c.mileage_rate is not none else settings.mileage_rate) or 0 %}

        {# All hours are billed at hourly_rate (telephonic claims are handled at the claim level; not per-code). #}
        {% set hourly_hours = hours_total or 0 %}

        {% if _fin and (_fin is mapping) %}
          {% set hourly_hours = _fin.get('hours_total', _fin.get('hours', hourly_hours)) %}
        {% elif _fin %}
          {% if _fin.hours_total is defined %}{% set hourly_hours = _fin.hours_total %}{% elif _fin.hours is defined %}{% set hourly_hours = _fin.hours %}{% endif %}
        {% endif %}

        {% set total_amount = (hourly_hours * hourly_rate) + ((miles_total or 0) * mileage_rate) + (expenses_total or 0) %}
      {% endif %}

      {# Balance due is derived from total_amount and paid_total to stay consistent. #}
      {% set total_due = (total_amount or 0) - (paid_total or 0) %}
      {% if total_due < 0 %}{% set total_due = 0 %}{% endif %}

      <!-- Totals (keep together on one printed page) -->
      <div class="row ip-bottom">
        <div class="col-md-6">
          <!-- intentionally blank: footer text is shown beneath totals -->
        </div>
        <div class="col-md-6">
          <table class="table table-sm mb-0 ip-totals">
            <tbody class="small">
              <tr>
                <th class="text-end">Billable hours</th>
                <td class="text-end" style="width: 8rem;">
                  {{ "%.2f"|format(hours_total or 0) }}
                </td>
              </tr>
              <tr>
                <th class="text-end">Mileage (miles)</th>
                <td class="text-end">
                  {{ "%.2f"|format(miles_total or 0) }}
                </td>
              </tr>
              <tr>
                <th class="text-end">Expenses ($)</th>
                <td class="text-end">
                  {{ "%.2f"|format(expenses_total or 0) }}
                </td>
              </tr>
              <tr>
                <th class="text-end">Invoice Total</th>
                <td class="text-end">
                  ${{ "%.2f"|format(total_amount or 0) }}
                </td>
              </tr>
              <tr>
                <th class="text-end">Amount Paid</th>
                <td class="text-end">
                  ${{ "%.2f"|format(paid_total or 0) }}
                </td>
              </tr>
              <tr class="fw-bold">
                <th class="text-end">Total Due</th>
                <td class="text-end">
                  ${{ "%.2f"|format(total_due or 0) }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      {% if settings.invoice_footer_text %}
        <hr class="ip-hr">
        <div class="small text-muted" style="white-space: pre-wrap;">
          {{ settings.invoice_footer_text }}
        </div>
      {% endif %}

    </div>
  </div>
</div>

<style>
  /* Invoice print styling: match report/fax clean look */

  /* Keep the invoice itself as a white sheet (but don't break site-wide dark mode) */
  #invoice-print-root .card-body {
    background: #ffffff !important;
    color: #111111 !important;
  }
  /* Links inside the printed "paper" should use the configured accent */
  #invoice-print-root .card-body a {
    color: var(--accent, #0d6efd) !important;
  }

  #invoice-print-root .card {
    border: 0;
    background: transparent;
  }

  #invoice-print-root .card-body {
    background: #ffffff;
    border: 2px solid rgba(0,0,0,0.15);
    border-radius: 12px;
    padding: 22px 22px;

    /* Kill any inherited/inset accent bar at the top */
    box-shadow: none !important;
    background-image: none !important;
  }

  /* Some themes implement the top accent as a pseudo-element; disable it */
  #invoice-print-root .card-body::before,
  #invoice-print-root .card-body::after {
    content: none !important;
    display: none !important;
  }

  .ip-hr {
    border: 0;
    border-top: 2px solid rgba(0,0,0,0.12);
    margin: 14px 0;
  }

  /* Make subtle boxes/lines a touch more visible */
  #invoice-print-root .table-bordered > :not(caption) > * {
    border-color: rgba(0,0,0,0.28);
  }

  /* Force all tables onto a white “paper” theme (the base site uses dark tables) */
  #invoice-print-root .table,
  #invoice-print-root .table th,
  #invoice-print-root .table td {
    background: #ffffff !important;
    color: #111111 !important;
  }

  /* Keep the line-items header as the accent bar, but make body cells white */
  /* Line-items header: always use accent color (screen + print) */
  #invoice-print-root .ip-items-head th {
    background-color: var(--accent, #0d6efd) !important;
    color: #ffffff !important;
    border-color: rgba(0,0,0,0.28) !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  #invoice-print-root .ip-items tbody td {
    background: #ffffff !important;
  }

  /* Shrink totals table so it only sits under the labels/values (no long line to the left) */
  #invoice-print-root .ip-bottom .col-md-6:last-child {
    text-align: right;
  }
  #invoice-print-root .ip-totals {
    display: inline-table;
    width: auto;
    margin-left: auto;
  }

  /* Totals box: light rows + subtle separators */
  #invoice-print-root .ip-totals th,
  #invoice-print-root .ip-totals td {
    background: #ffffff !important;
    border-color: rgba(0,0,0,0.18) !important;
  }


  @media print {
    body {
      background: #ffffff !important;
    }
    .navbar,
    .d-print-none {
      display: none !important;
    }
    #invoice-print-root {
      margin-top: 0 !important;
    }

    /* Better page splitting: repeat table header and avoid orphan totals */
    .ip-items thead {
      display: table-header-group;
    }
    .ip-items tfoot {
      display: table-footer-group;
    }
    .ip-items tr,
    .ip-bottom,
    .ip-totals {
      break-inside: avoid;
      page-break-inside: avoid;
    }

    /* Remove shadows/extra rounding artifacts in print */
    #invoice-print-root .card-body {
      box-shadow: none !important;
      background-image: none !important;
    }

    /* Print: force tables to white/black regardless of site theme */
    #invoice-print-root .table,
    #invoice-print-root .table th,
    #invoice-print-root .table td {
      background: #ffffff !important;
      color: #111111 !important;
    }
    #invoice-print-root .ip-items-head th {
      background-color: var(--accent, #0d6efd) !important;
      color: #ffffff !important;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }
  }
</style>
{% endblock %}