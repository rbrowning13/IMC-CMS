{% extends "base.html" %}
{% block title %}Claims - Impact CMS{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h1 class="h4 mb-2 mb-sm-0">Claims</h1>
    <div class="d-flex align-items-center gap-2">
      <input
        id="claims-search"
        type="text"
        class="form-control form-control-sm"
        style="min-width: 220px;"
        placeholder="Search claims..."
        aria-label="Search claims"
      >
      <button
        class="btn btn-outline-secondary btn-sm"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#claims-filters"
        aria-expanded="false"
        aria-controls="claims-filters">
        Filters
      </button>
      <a href="{{ url_for('main.new_claim') }}" class="btn btn-primary btn-sm">
        New Claim
      </a>
    </div>
  </div>

  <div id="claims-filters" class="collapse mb-3">
    <div class="card card-body py-2">
      <div class="row g-2 align-items-center small">
        <div class="col-sm-6 col-md-4">
          <label for="claims-filter-status" class="form-label form-label-sm mb-0">Claim activity</label>
          <select id="claims-filter-status" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="active">Active</option>
            <option value="dormant">Dormant</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-4">
          <label for="claims-filter-billing" class="form-label form-label-sm mb-0">Billing status</label>
          <select id="claims-filter-billing" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="none">No invoices</option>
            <option value="open">Open invoices</option>
            <option value="closed">All closed</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-2 d-flex align-items-center">
          <div class="form-check form-switch ms-md-auto">
            <input class="form-check-input" type="checkbox" id="claims-filter-show-closed" checked>
            <label class="form-check-label small" for="claims-filter-show-closed">Show closed claims</label>
          </div>
        </div>
        <div class="col-sm-6 col-md-2 d-flex align-items-end justify-content-end mt-2 mt-md-0">
          <button type="button" id="claims-filters-clear" class="btn btn-outline-secondary btn-sm">
            Clear filters
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header">
      <h2 class="h6 mb-0">All Claims</h2>
    </div>
    <div class="card-body p-0">
      {% if claims %}
        <div class="table-responsive">
          <table id="claims-table" class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-sort-key="claim_number"><span>Claim #</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="claimant"><span>Claimant</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="carrier"><span>Carrier</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="employer"><span>Employer</span> <span class="sort-indicator">↕</span></th>
                <th class="text-center sortable text-nowrap small" data-sort-key="claim_status"><span>Status</span> <span class="sort-indicator">↕</span></th>
                <th class="text-center sortable text-nowrap small" data-sort-key="activity"><span>Activity</span> <span class="sort-indicator">↕</span></th>
                <th class="text-center sortable text-nowrap small" data-sort-key="billing"><span>Billing</span> <span class="sort-indicator">↕</span></th>
                <th class="text-center sortable text-nowrap small" data-sort-key="next_report_due"><span>Next Report Due</span> <span class="sort-indicator">↕</span></th>
              </tr>
            </thead>
            <tbody>

              {% for claim in claims %}
                {% set summary = billing_summary.get(claim.id) if billing_summary else None %}
                {% set dormancy = dormant_info.get(claim.id) if dormant_info else None %}

                <tr
                  {% if dormancy and dormancy["is_dormant"] %}class="table-warning"{% endif %}
                  data-status="{% if dormancy %}{% if dormancy['is_dormant'] %}dormant{% else %}active{% endif %}{% else %}unknown{% endif %}"
                  data-billing="{% if not summary or summary['total'] == 0 %}none{% elif summary['open'] > 0 %}open{% else %}closed{% endif %}"
                  data-closed="{% if claim.is_closed %}1{% else %}0{% endif %}"
                >
                  <td>
                    <div class="d-flex align-items-center gap-1">
                      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="claim-link">
                        {{ claim.claim_number }}
                      </a>
                      <button type="button"
                              class="btn btn-link btn-sm p-0 text-muted copy-btn"
                              data-copy-text="{{ claim.claim_number }}"
                              title="Copy claim number"
                              aria-label="Copy claim number">
                        <span class="copy-icon" aria-hidden="true"></span>
                      </button>
                    </div>
                  </td>

                  <td>
                    {% set _fn = (claim.claimant_first_name if claim.claimant_first_name is defined and claim.claimant_first_name else '')|trim %}
                    {% set _ln = (claim.claimant_last_name if claim.claimant_last_name is defined and claim.claimant_last_name else '')|trim %}
                    <div class="d-flex align-items-center gap-1">
                      <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}" class="claim-link">
                        {% if _ln and _fn %}
                          {{ _ln }}, {{ _fn }}
                        {% elif _ln %}
                          {{ _ln }}
                        {% elif _fn %}
                          {{ _fn }}
                        {% else %}
                          {{ claim.claimant_name or '—' }}
                        {% endif %}
                      </a>
                      <button type="button"
                              class="btn btn-link btn-sm p-0 text-muted copy-btn"
                              data-copy-text="{% if _ln and _fn %}{{ _ln }}, {{ _fn }}{% elif _ln %}{{ _ln }}{% elif _fn %}{{ _fn }}{% else %}{{ claim.claimant_name or '' }}{% endif %}"
                              title="Copy claimant name"
                              aria-label="Copy claimant name">
                        <span class="copy-icon" aria-hidden="true"></span>
                      </button>
                    </div>
                  </td>

                  <td>
                    {% if claim.carrier %}
                      <a href="{{ url_for('main.carrier_detail', carrier_id=claim.carrier.id) }}" class="claim-link">
                        {{ claim.carrier.name }}
                      </a>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if claim.employer %}
                      <a href="{{ url_for('main.employer_detail', employer_id=claim.employer.id) }}" class="claim-link">
                        {{ claim.employer.name }}
                      </a>
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td class="text-center text-nowrap">
                    {% if claim.is_closed %}
                      <span class="badge bg-secondary">Closed</span>
                    {% else %}
                      <span class="badge bg-primary">Open</span>
                    {% endif %}
                  </td>

                  <td class="text-center text-nowrap">
                    {% if dormancy %}
                      {% if dormancy["is_dormant"] %}
                        <span class="badge bg-warning text-dark">Dormant</span>
                        {% if dormancy["last_activity"] %}
                          <div class="small text-muted">
                            Last activity {{ dormancy["last_activity"]|format_date }}
                          </div>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-success">Active</span>
                        {% if dormancy["last_activity"] %}
                          <div class="small text-muted">
                            Last activity {{ dormancy["last_activity"]|format_date }}
                          </div>
                        {% endif %}
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  </td>

                  <td class="text-center text-nowrap">
                    {# ---------- BILLING BADGE LOGIC (ENHANCED) ---------- #}
                    {% if not summary or summary["total"] == 0 %}
                      <span class="badge bg-secondary">No invoices</span>

                      {% if summary and summary["uninvoiced_total"] > 0 %}
                        <div class="mt-1">
                          <span class="badge bg-danger">
                            ${{ "%.2f"|format(summary["uninvoiced_total"]) }} uninvoiced
                          </span>
                        </div>
                      {% endif %}

                    {% elif summary["open"] > 0 %}
                      <span class="badge bg-warning text-dark">
                        {{ summary["open"] }} open
                      </span>

                      <div class="mt-1">
                        <span class="badge bg-warning text-dark">
                          ${{ "%.2f"|format(summary["open_total"] or 0) }}
                        </span>
                      </div>

                      {% if summary["uninvoiced_total"] > 0 %}
                        <div class="mt-1">
                          <span class="badge bg-danger">
                            ${{ "%.2f"|format(summary["uninvoiced_total"]) }} uninvoiced
                          </span>
                        </div>
                      {% endif %}

                    {% else %}
                      <span class="badge bg-success">All closed</span>

                      {% if summary["uninvoiced_total"] > 0 %}
                        <div class="mt-1">
                          <span class="badge bg-danger">
                            ${{ "%.2f"|format(summary["uninvoiced_total"]) }} uninvoiced
                          </span>
                        </div>
                      {% endif %}
                    {% endif %}
                  </td>

                  {# ---------- NEXT REPORT DUE ---------- #}
                  <td class="text-center text-nowrap">
                    {% set due = next_report_due_map.get(claim.id) if next_report_due_map else None %}
                    {% if due %}
                      {% set days = (due - today).days %}
                      {% if days > 5 %}
                        <span class="badge bg-success">{{ due|format_date }}</span>
                      {% elif days > 0 %}
                        <span class="badge bg-warning text-dark">{{ due|format_date }}</span>
                      {% else %}
                        <span class="badge bg-danger">{{ due|format_date }}</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3">
          <p class="text-muted mb-0">No claims have been created yet.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Hook up search helper
    attachTableSearch('claims-search', 'claims-table');

    const table = document.getElementById('claims-table');
    if (!table) {
      return;
    }

    const tbody = table.querySelector('tbody');
    const allRows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

    // Remember original row order for tri-state sorting
    allRows.forEach(function (row, index) {
      row.dataset.originalIndex = String(index);
    });

    // ----- Filters (status + billing + closed), preserving search-hidden rows -----
    const statusFilter = document.getElementById('claims-filter-status');
    const billingFilter = document.getElementById('claims-filter-billing');
    const showClosedCheckbox = document.getElementById('claims-filter-show-closed');
    const clearBtn = document.getElementById('claims-filters-clear');

    function getQueryParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    // Initialize showClosedCheckbox checked state from URL param
    (function initShowClosedCheckbox() {
      if (!showClosedCheckbox) return;
      const val = getQueryParam('show_closed');
      if (val === '1' || val === 'true') {
        showClosedCheckbox.checked = true;
      } else {
        showClosedCheckbox.checked = false;
      }
    })();

    function applyFilters() {
      const statusVal = statusFilter ? statusFilter.value.toLowerCase() : '';
      const billingVal = billingFilter ? billingFilter.value.toLowerCase() : '';
      const showClosed = showClosedCheckbox ? showClosedCheckbox.checked : true;

      allRows.forEach(function (row) {
        const rowStatus = (row.getAttribute('data-status') || '').toLowerCase();
        const rowBilling = (row.getAttribute('data-billing') || '').toLowerCase();
        const rowClosed = row.getAttribute('data-closed') || '0';

        const statusMatch = !statusVal || rowStatus === statusVal;
        const billingMatch = !billingVal || rowBilling === billingVal;
        const closedMatch = showClosed || rowClosed === '0';

        if (statusMatch && billingMatch && closedMatch) {
          // Only show the row if search has not hidden it
          if (!row.dataset.searchHidden || row.dataset.searchHidden === '0') {
            row.style.display = '';
          }
        } else {
          row.style.display = 'none';
        }
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener('change', applyFilters);
    }
    if (billingFilter) {
      billingFilter.addEventListener('change', applyFilters);
    }
    if (showClosedCheckbox) {
      showClosedCheckbox.addEventListener('change', function () {
        // Update URL query param without reload
        const params = new URLSearchParams(window.location.search);
        if (showClosedCheckbox.checked) {
          params.set('show_closed', '1');
        } else {
          params.delete('show_closed');
        }
        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.replaceState({}, '', newUrl);
        applyFilters();
      });
    }
    if (clearBtn) {
      clearBtn.addEventListener('click', function () {
        if (statusFilter) statusFilter.value = '';
        if (billingFilter) billingFilter.value = '';
        if (showClosedCheckbox) showClosedCheckbox.checked = false;
        applyFilters();
      });
    }

    // ----- Tri-state sorting for claims table -----
    function extractSortableLastName(fullName) {
      const raw = (fullName || '').trim();
      if (!raw) return '';

      // If "Last, First" format, prefer the portion before comma.
      if (raw.includes(',')) {
        const parts = raw.split(',');
        const last = (parts[0] || '').trim().toLowerCase();
        const rest = (parts.slice(1).join(',') || '').trim().toLowerCase();
        return last || rest || raw.toLowerCase();
      }

      // Otherwise assume "First Middle Last" and use last token.
      const tokens = raw.split(/\s+/).filter(Boolean);
      if (tokens.length === 0) return '';
      const last = tokens[tokens.length - 1].toLowerCase();
      return last || raw.toLowerCase();
    }

    function getSortValue(row, key) {
      switch (key) {
        case 'claim_number': {
          const s = (row.children[0].innerText || '').trim();
          const n = parseInt(s.replace(/[^0-9]/g, ''), 10);
          if (!Number.isNaN(n)) {
            // zero-pad for stable string sorting
            return String(n).padStart(12, '0');
          }
          return s.toLowerCase();
        }
        case 'claimant': {
          const full = (row.children[1].innerText || '').trim();
          const last = extractSortableLastName(full);
          // secondary key keeps stable ordering for same last names
          return (last + '|' + full.toLowerCase());
        }
        case 'carrier':
          return (row.children[2].innerText || '').trim().toLowerCase();
        case 'employer':
          return (row.children[3].innerText || '').trim().toLowerCase();
        case 'claim_status':
          return (row.children[4].innerText || '').trim().toLowerCase();
        case 'activity':
          return (row.children[5].innerText || '').trim().toLowerCase();
        case 'billing':
          return (row.children[6].innerText || '').trim().toLowerCase();
        case 'next_report_due': {
          const text = (row.children[7].innerText || '').trim();
          if (!text || text === '—') return '';
          return text;
        }
        default:
          return '';
      }
    }

    const sortableHeaders = table.querySelectorAll('th.sortable');

    sortableHeaders.forEach(function (th) {
      th.style.cursor = 'pointer';
      th.dataset.sortState = 'none'; // none | asc | desc

      th.addEventListener('click', function () {
        const key = th.getAttribute('data-sort-key');
        if (!key) return;

        const currentState = th.dataset.sortState || 'none';
        let newState;
        if (currentState === 'none') {
          newState = 'asc';
        } else if (currentState === 'asc') {
          newState = 'desc';
        } else {
          newState = 'none';
        }

        // Reset all headers except the one clicked
        sortableHeaders.forEach(function (other) {
          if (other !== th) {
            other.dataset.sortState = 'none';
            const otherIndicator = other.querySelector('.sort-indicator');
            if (otherIndicator) {
              otherIndicator.textContent = '↕';
            }
          }
        });

        // Update this header's indicator
        const indicator = th.querySelector('.sort-indicator');
        if (indicator) {
          if (newState === 'asc') {
            indicator.textContent = '↑';
          } else if (newState === 'desc') {
            indicator.textContent = '↓';
          } else {
            indicator.textContent = '↕';
          }
        }

        th.dataset.sortState = newState;

        const rowsToSort = Array.from(tbody.querySelectorAll('tr'));

        if (newState === 'none') {
          // Restore original order based on data-original-index
          rowsToSort.sort(function (a, b) {
            const ia = parseInt(a.dataset.originalIndex || '0', 10);
            const ib = parseInt(b.dataset.originalIndex || '0', 10);
            return ia - ib;
          });
        } else {
          rowsToSort.sort(function (a, b) {
            const va = getSortValue(a, key);
            const vb = getSortValue(b, key);
            if (va === vb) return 0;
            return newState === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
          });
        }

        rowsToSort.forEach(function (row) {
          tbody.appendChild(row);
        });
      });
    });

    // Default initial sort: Claimant (by last name) ascending
    (function defaultSortByClaimant() {
      const claimantHeader = table.querySelector('th.sortable[data-sort-key="claimant"]');
      if (!claimantHeader) return;

      // Force state to none so the first click lands on asc.
      claimantHeader.dataset.sortState = 'none';
      claimantHeader.click();
    })();

    // Apply filters initially, including showClosed checkbox state
    applyFilters();
  });
</script>
<script>
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.copy-btn');
  if (!btn) return;
  const text = btn.getAttribute('data-copy-text') || '';
  if (!text) return;

  navigator.clipboard.writeText(text).then(() => {
    btn.classList.remove('text-muted');
    btn.classList.add('text-success');
    setTimeout(() => {
      btn.classList.remove('text-success');
      btn.classList.add('text-muted');
    }, 800);
  });
});
</script>
<style>
  /* Modern claim links */
  .claim-link {
    color: inherit;
    text-decoration: none;
    font-weight: 500;
  }

  .claim-link:hover {
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  /* Copy icon button */
  .copy-btn {
    opacity: 0.45;
    transition: opacity 0.15s ease, color 0.15s ease;
  }

  .copy-btn:hover {
    opacity: 0.85;
  }

  .copy-icon {
    display: inline-block;
    width: 14px;
    height: 14px;
    background-color: currentColor;
    mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v16h13a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 18H8V7h11v16z'/%3E%3C/svg%3E") no-repeat center / contain;
  }
</style>
{% endblock %}