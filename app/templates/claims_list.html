{% extends "base.html" %}
{% block title %}Claims - Impact CMS{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
    <h1 class="h4 mb-2 mb-sm-0">Claims</h1>
    <div class="d-flex align-items-center gap-2">
      <input
        id="claims-search"
        type="text"
        class="form-control form-control-sm"
        style="min-width: 220px;"
        placeholder="Search claims..."
        aria-label="Search claims"
      >
      <button
        class="btn btn-outline-secondary btn-sm"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#claims-filters"
        aria-expanded="false"
        aria-controls="claims-filters">
        Filters
      </button>
      <a href="{{ url_for('main.new_claim') }}" class="btn btn-primary btn-sm">
        New Claim
      </a>
    </div>
  </div>

  <div id="claims-filters" class="collapse mb-3">
    <div class="card card-body py-2">
      <div class="row g-2 align-items-center small">
        <div class="col-sm-6 col-md-4">
          <label for="claims-filter-status" class="form-label form-label-sm mb-0">Claim status</label>
          <select id="claims-filter-status" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="active">Active</option>
            <option value="dormant">Dormant</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-4">
          <label for="claims-filter-billing" class="form-label form-label-sm mb-0">Billing status</label>
          <select id="claims-filter-billing" class="form-select form-select-sm">
            <option value="">All</option>
            <option value="none">No invoices</option>
            <option value="open">Open invoices</option>
            <option value="closed">All closed</option>
          </select>
        </div>
        <div class="col-sm-12 col-md-4 d-flex align-items-end justify-content-end mt-2 mt-md-0">
          <button type="button" id="claims-filters-clear" class="btn btn-outline-secondary btn-sm">
            Clear filters
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header">
      <h2 class="h6 mb-0">All Claims</h2>
    </div>
    <div class="card-body p-0">
      {% if claims %}
        <div class="table-responsive">
          <table id="claims-table" class="table table-sm table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-sort-key="claim_number"><span>Claim #</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="claimant"><span>Claimant</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="carrier"><span>Carrier</span> <span class="sort-indicator">↕</span></th>
                <th class="sortable" data-sort-key="employer"><span>Employer</span> <span class="sort-indicator">↕</span></th>
                <th class="text-center sortable" data-sort-key="status"><span>Status</span> <span class="sort-indicator">↕</span></th>
                <th class="text-center sortable" data-sort-key="billing"><span>Billing</span> <span class="sort-indicator">↕</span></th>
              </tr>
            </thead>
            <tbody>

              {% for claim in claims %}
                {% set summary = billing_summary.get(claim.id) if billing_summary else None %}
                {% set dormancy = dormant_info.get(claim.id) if dormant_info else None %}

                <tr
                  {% if dormancy and dormancy["is_dormant"] %}class="table-warning"{% endif %}
                  data-status="{% if dormancy %}{% if dormancy['is_dormant'] %}dormant{% else %}active{% endif %}{% else %}unknown{% endif %}"
                  data-billing="{% if not summary or summary['total'] == 0 %}none{% elif summary['open'] > 0 %}open{% else %}closed{% endif %}"
                >
                  <td>
                    <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}">
                      {{ claim.claim_number }}
                    </a>
                  </td>

                  <td>
                    <a href="{{ url_for('main.claim_detail', claim_id=claim.id) }}">
                      {{ claim.claimant_name }}
                    </a>
                  </td>

                  <td>
                    {% if claim.carrier %}
                      {{ claim.carrier.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if claim.employer %}
                      {{ claim.employer.name }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td class="text-center">
                    {% if dormancy %}
                      {% if dormancy["is_dormant"] %}
                        <span class="badge bg-warning text-dark">Dormant</span>
                        {% if dormancy["last_activity"] %}
                          <div class="small text-muted">
                            Last activity {{ dormancy["last_activity"]|format_date }}
                          </div>
                        {% endif %}
                      {% else %}
                        <span class="badge bg-success">Active</span>
                        {% if dormancy["last_activity"] %}
                          <div class="small text-muted">
                            Last activity {{ dormancy["last_activity"]|format_date }}
                          </div>
                        {% endif %}
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">Unknown</span>
                    {% endif %}
                  </td>

                  <td class="text-center">

                    {# ---------- BILLING BADGE LOGIC ---------- #}
                    {% if not summary or summary["total"] == 0 %}
                      <span class="badge bg-secondary">No invoices</span>

                    {% elif summary["open"] > 0 %}
                      <span class="badge bg-warning text-dark">
                        {{ summary["open"] }} open invoice{% if summary["open"] != 1 %}s{% endif %}
                      </span>

                    {% else %}
                      <span class="badge bg-success">All closed</span>
                    {% endif %}

                  </td>

                </tr>
              {% endfor %}

            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3">
          <p class="text-muted mb-0">No claims have been created yet.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Hook up search helper
    attachTableSearch('claims-search', 'claims-table');

    const table = document.getElementById('claims-table');
    if (!table) {
      return;
    }

    const tbody = table.querySelector('tbody');
    const allRows = tbody ? Array.from(tbody.querySelectorAll('tr')) : [];

    // Remember original row order for tri-state sorting
    allRows.forEach(function (row, index) {
      row.dataset.originalIndex = String(index);
    });

    // ----- Filters (status + billing), preserving search-hidden rows -----
    const statusFilter = document.getElementById('claims-filter-status');
    const billingFilter = document.getElementById('claims-filter-billing');
    const clearBtn = document.getElementById('claims-filters-clear');

    function applyFilters() {
      const statusVal = statusFilter ? statusFilter.value.toLowerCase() : '';
      const billingVal = billingFilter ? billingFilter.value.toLowerCase() : '';

      allRows.forEach(function (row) {
        const rowStatus = (row.getAttribute('data-status') || '').toLowerCase();
        const rowBilling = (row.getAttribute('data-billing') || '').toLowerCase();

        const statusMatch = !statusVal || rowStatus === statusVal;
        const billingMatch = !billingVal || rowBilling === billingVal;

        if (statusMatch && billingMatch) {
          // Only show the row if search has not hidden it
          if (!row.dataset.searchHidden || row.dataset.searchHidden === '0') {
            row.style.display = '';
          }
        } else {
          row.style.display = 'none';
        }
      });
    }

    if (statusFilter) {
      statusFilter.addEventListener('change', applyFilters);
    }
    if (billingFilter) {
      billingFilter.addEventListener('change', applyFilters);
    }
    if (clearBtn) {
      clearBtn.addEventListener('click', function () {
        if (statusFilter) statusFilter.value = '';
        if (billingFilter) billingFilter.value = '';
        applyFilters();
      });
    }

    // ----- Tri-state sorting for claims table -----
    function extractSortableLastName(fullName) {
      const raw = (fullName || '').trim();
      if (!raw) return '';

      // If "Last, First" format, prefer the portion before comma.
      if (raw.includes(',')) {
        const parts = raw.split(',');
        const last = (parts[0] || '').trim().toLowerCase();
        const rest = (parts.slice(1).join(',') || '').trim().toLowerCase();
        return last || rest || raw.toLowerCase();
      }

      // Otherwise assume "First Middle Last" and use last token.
      const tokens = raw.split(/\s+/).filter(Boolean);
      if (tokens.length === 0) return '';
      const last = tokens[tokens.length - 1].toLowerCase();
      return last || raw.toLowerCase();
    }

    function getSortValue(row, key) {
      switch (key) {
        case 'claim_number': {
          const s = (row.children[0].innerText || '').trim();
          const n = parseInt(s.replace(/[^0-9]/g, ''), 10);
          if (!Number.isNaN(n)) {
            // zero-pad for stable string sorting
            return String(n).padStart(12, '0');
          }
          return s.toLowerCase();
        }
        case 'claimant': {
          const full = (row.children[1].innerText || '').trim();
          const last = extractSortableLastName(full);
          // secondary key keeps stable ordering for same last names
          return (last + '|' + full.toLowerCase());
        }
        case 'carrier':
          return (row.children[2].innerText || '').trim().toLowerCase();
        case 'employer':
          return (row.children[3].innerText || '').trim().toLowerCase();
        case 'status':
          return (row.children[4].innerText || '').trim().toLowerCase();
        case 'billing':
          return (row.children[5].innerText || '').trim().toLowerCase();
        default:
          return '';
      }
    }

    const sortableHeaders = table.querySelectorAll('th.sortable');

    sortableHeaders.forEach(function (th) {
      th.style.cursor = 'pointer';
      th.dataset.sortState = 'none'; // none | asc | desc

      th.addEventListener('click', function () {
        const key = th.getAttribute('data-sort-key');
        if (!key) return;

        const currentState = th.dataset.sortState || 'none';
        let newState;
        if (currentState === 'none') {
          newState = 'asc';
        } else if (currentState === 'asc') {
          newState = 'desc';
        } else {
          newState = 'none';
        }

        // Reset all headers except the one clicked
        sortableHeaders.forEach(function (other) {
          if (other !== th) {
            other.dataset.sortState = 'none';
            const otherIndicator = other.querySelector('.sort-indicator');
            if (otherIndicator) {
              otherIndicator.textContent = '↕';
            }
          }
        });

        // Update this header's indicator
        const indicator = th.querySelector('.sort-indicator');
        if (indicator) {
          if (newState === 'asc') {
            indicator.textContent = '↑';
          } else if (newState === 'desc') {
            indicator.textContent = '↓';
          } else {
            indicator.textContent = '↕';
          }
        }

        th.dataset.sortState = newState;

        const rowsToSort = Array.from(tbody.querySelectorAll('tr'));

        if (newState === 'none') {
          // Restore original order based on data-original-index
          rowsToSort.sort(function (a, b) {
            const ia = parseInt(a.dataset.originalIndex || '0', 10);
            const ib = parseInt(b.dataset.originalIndex || '0', 10);
            return ia - ib;
          });
        } else {
          rowsToSort.sort(function (a, b) {
            const va = getSortValue(a, key);
            const vb = getSortValue(b, key);
            if (va === vb) return 0;
            return newState === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
          });
        }

        rowsToSort.forEach(function (row) {
          tbody.appendChild(row);
        });
      });
    });

    // Default initial sort: Claimant (by last name) ascending
    (function defaultSortByClaimant() {
      const claimantHeader = table.querySelector('th.sortable[data-sort-key="claimant"]');
      if (!claimantHeader) return;

      // Force state to none so the first click lands on asc.
      claimantHeader.dataset.sortState = 'none';
      claimantHeader.click();
    })();
  });
</script>
{% endblock %}